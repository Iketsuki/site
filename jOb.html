<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus | Knowledge Fusion</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        bgMain: 'var(--bg-main)',
                        bgSidebar: 'var(--bg-sidebar)',
                        bgItem: 'var(--bg-item)',
                        bgHover: 'var(--bg-hover)',
                        textMain: 'var(--text-main)',
                        textMuted: 'var(--text-muted)',
                        borderMain: 'var(--border-main)',
                        accent: 'var(--accent)',
                        tagColor: 'var(--tag-color)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --bg-main: #ffffff;
            --bg-sidebar: #f9fafb;
            --bg-item: #ffffff;
            --bg-hover: #f3f4f6;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --border-main: #e5e7eb;
            --accent: #8b5cf6;
            --tag-color: #10b981;
            --scroll-track: #f3f4f6;
            --scroll-thumb: #d1d5db;
        }

        html.dark {
            --bg-main: #0f0f0f;
            --bg-sidebar: #111827;
            --bg-item: #1f2937;
            --bg-hover: #374151;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --border-main: #1f2937;
            --accent: #8b5cf6;
            --tag-color: #34d399;
            --scroll-track: #1f2937;
            --scroll-thumb: #4b5563;
        }

        body { background-color: var(--bg-main); color: var(--text-main); font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--scroll-track); }
        ::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 4px; }

        /* Editor Typography */
        .markdown-preview { font-size: 0.95rem; padding-bottom: 3rem; }
        .markdown-preview h1 { font-size: 2em; font-weight: bold; margin-bottom: 0.5em; color: var(--text-main); border-bottom: 1px solid var(--border-main); padding-bottom: 0.3em; }
        .markdown-preview h2 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: var(--text-main); }
        .markdown-preview h3 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-preview p { margin-bottom: 1em; line-height: 1.6; }
        
        /* Lists */
        .markdown-preview ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-preview ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .markdown-preview li { margin-bottom: 0.25em; }
        .markdown-preview ul ul, .markdown-preview ol ol, .markdown-preview ul ol, .markdown-preview ol ul { margin-bottom: 0; margin-top: 0.25em; }

        .markdown-preview blockquote { border-left: 4px solid var(--accent); padding-left: 1em; font-style: italic; color: var(--text-muted); margin-bottom: 1em; background: var(--bg-hover); padding-top:0.5em; padding-bottom:0.5em; }
        
        /* Code Blocks */
        .markdown-preview code { background-color: var(--bg-hover); padding: 0.2em 0.4em; border-radius: 4px; font-family: monospace; font-size: 0.9em; color: var(--accent); }
        .markdown-preview pre { background-color: var(--bg-sidebar); padding: 1em; border-radius: 8px; overflow-x: auto; margin-bottom: 1em; border: 1px solid var(--border-main); }
        .markdown-preview pre code { background-color: transparent; padding: 0; color: var(--text-main); font-size: 0.85em; }
        
        .markdown-preview a { color: #60a5fa; text-decoration: underline; }
        .markdown-preview hr { border-color: var(--border-main); margin: 2em 0; }

        /* Tables */
        .markdown-preview table { width: 100%; border-collapse: collapse; margin-bottom: 1em; font-size: 0.9em; }
        .markdown-preview th, .markdown-preview td { border: 1px solid var(--border-main); padding: 8px; text-align: left; }
        .markdown-preview th { background-color: var(--bg-sidebar); font-weight: 600; }
        .markdown-preview tr:nth-child(even) { background-color: var(--bg-hover); }

        /* Task Lists */
        .markdown-preview input[type="checkbox"] { margin-right: 0.5em; cursor: pointer; appearance: none; -webkit-appearance: none; width: 1.1em; height: 1.1em; border: 1px solid var(--text-muted); border-radius: 3px; position: relative; top: 3px; background: var(--bg-main); }
        .markdown-preview input[type="checkbox"]:checked { background-color: var(--accent); border-color: var(--accent); }
        .markdown-preview input[type="checkbox"]:checked::after { content: '✔'; position: absolute; top: -2px; left: 1px; color: white; font-size: 0.8em; }
        .markdown-preview li.task-list-item { list-style-type: none; margin-left: -1.5em; }

        .wikilink { color: var(--accent); cursor: pointer; background: rgba(139, 92, 246, 0.1); padding: 0 4px; border-radius: 4px; font-weight: 500; }
        .wikilink.is-missing { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .tag-pill { color: var(--tag-color); background: rgba(16, 185, 129, 0.1); padding: 0 6px; border-radius: 12px; font-size: 0.8em; font-weight: 500; cursor: pointer; margin-right: 2px; display: inline-block;}
        .tag-pill:hover { background: rgba(16, 185, 129, 0.2); }

        /* Sidebar & Common */
        .sidebar-item:hover { background-color: var(--bg-hover); }
        .sidebar-item.active { background-color: var(--bg-hover); border-left: 3px solid var(--accent); font-weight: 600; color: var(--text-main); }
        .sidebar-item.selected { background-color: rgba(139, 92, 246, 0.15); border-left: 3px solid var(--accent); }
        .drop-target { border: 2px dashed var(--accent) !important; background-color: rgba(139, 92, 246, 0.1) !important; }
        .root-drop-zone { min-height: 50px; flex: 1; border-top: 1px solid transparent; }
        .root-drop-zone.drop-target { border-top: 2px dashed var(--accent) !important; }

        /* Whiteboard */
        .bg-dot-pattern { background-image: radial-gradient(var(--text-muted) 1px, transparent 1px); background-size: 20px 20px; opacity: 0.2; }
        .wb-card { position: absolute; width: 280px; background: var(--bg-item); border: 1px solid var(--border-main); border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex; flex-direction: column; cursor: grab; transition: box-shadow 0.2s, border-color 0.2s; }
        .wb-card:active { cursor: grabbing; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); }
        .wb-header { padding: 10px; border-bottom: 1px solid var(--border-main); font-weight: bold; font-size: 0.9rem; cursor: grab; display:flex; justify-content:space-between; align-items:center; background: var(--bg-sidebar); border-radius: 8px 8px 0 0; }
        .wb-body { padding: 12px; font-size: 0.8rem; height: 140px; overflow: hidden; color: var(--text-muted); pointer-events: none; line-height: 1.5; }
        .wb-footer { padding: 8px 12px; border-top: 1px solid var(--border-main); display: flex; flex-wrap: wrap; gap: 6px; align-items: center; background: var(--bg-item); border-radius: 0 0 8px 8px; min-height: 36px; }
        .wb-status-badge { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; background: var(--bg-hover); color: var(--text-muted); padding: 2px 6px; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-main); flex-shrink: 0; }

        /* Kanban */
        .kanban-container { display: flex; gap: 16px; padding: 24px; align-items: flex-start; transform-origin: 0 0; width: max-content; min-width: 100%; }
        .kanban-container.layout-row { flex-direction: row; }
        .kanban-container.layout-col { flex-direction: column; width: 600px; }
        .kanban-col { background: var(--bg-sidebar); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; flex-shrink: 0; border: 1px solid var(--border-main); transition: all 0.2s; }
        .kanban-container.layout-row .kanban-col { min-width: 300px; width: 300px; }
        .kanban-container.layout-col .kanban-col { width: 100%; margin-bottom: 16px; }
        .kanban-header { font-weight: bold; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; color: var(--text-main); cursor: grab; user-select: none; }
        .kanban-list { display: flex; gap: 8px; min-height: 50px; }
        .kanban-list.items-col { flex-direction: column; }
        .kanban-list.items-row { flex-direction: row; flex-wrap: wrap; }
        .kanban-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); border: 1px solid var(--border-main); padding: 12px; border-radius: 6px; cursor: grab; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; }
        html.dark .kanban-card { background: rgba(31, 41, 55, 0.7); }
        .kanban-list.items-col .kanban-card { width: 100%; }
        .kanban-list.items-row .kanban-card { width: 220px; height: 120px; overflow: hidden; }
        .kanban-card:hover { border-color: var(--accent); transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .kanban-drop-zone { min-height: 50px; height: 100%; }

        /* Glassy Panels */
        .glassy-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid var(--border-main); }
        html.dark .glassy-panel { background: rgba(17, 24, 39, 0.8); }

        /* Views Management */
        .view-section { display: none; height: 100%; width: 100%; }
        .view-section.active { display: block; }
        #view-editor.active { display: flex; }
        #view-kanban.active { display: flex; }

        .nav-btn { width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); transition: all 0.2s; cursor: pointer; margin-bottom: 8px; }
        .nav-btn:hover { background: var(--bg-hover); color: var(--text-main); }
        .nav-btn.active { background: var(--accent); color: white; }
    </style>
</head>
<body class="flex h-screen w-screen overflow-hidden">

    <!-- Nav Rail -->
    <nav class="w-14 bg-bgSidebar border-r border-borderMain flex flex-col items-center py-4 flex-shrink-0 z-50">
        <div class="mb-6 text-accent text-xl font-bold"><i class="fa-solid fa-bolt"></i></div>
        
        <div class="nav-btn active" id="nav-editor" title="Editor" onclick="switchView('editor')"><i class="fa-solid fa-pen-nib"></i></div>
        <div class="nav-btn" id="nav-whiteboard" title="Whiteboard" onclick="switchView('whiteboard')"><i class="fa-solid fa-object-group"></i></div>
        <div class="nav-btn" id="nav-kanban" title="Kanban" onclick="switchView('kanban')"><i class="fa-solid fa-list-check"></i></div>
        <div class="nav-btn" id="nav-graph" title="Graph" onclick="switchView('graph')"><i class="fa-solid fa-share-nodes"></i></div>

        <div class="mt-auto flex flex-col items-center gap-2">
            <div class="nav-btn" id="btn-export" title="Backup Data"><i class="fa-solid fa-download"></i></div>
            <input type="file" id="file-import" class="hidden" accept=".json">
            <div class="nav-btn" id="btn-import" title="Restore Data"><i class="fa-solid fa-upload"></i></div>
            <div class="nav-btn" onclick="resetData()" title="Reset Demo"><i class="fa-solid fa-arrows-rotate"></i></div>
            <div class="nav-btn" id="btn-theme" title="Theme"><i class="fa-regular fa-sun"></i></div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside id="sidebar-tree" class="w-60 bg-bgSidebar border-r border-borderMain flex flex-col flex-shrink-0 transition-all duration-300">
        <div class="p-3 border-b border-borderMain flex flex-col gap-2" ondragover="allowDrop(event)" ondrop="dropToRoot(event)">
            <h2 class="font-bold text-sm text-textMain">Nexus Core</h2>
            <div class="flex flex-col gap-1">
                <input type="text" id="search-input" placeholder="Search..." class="w-full bg-bgMain border border-borderMain rounded px-2 py-1 text-xs focus:outline-none focus:border-accent text-textMain">
                <input type="text" id="sidebar-tag-filter" placeholder="Filter tags (e.g. demo, work)" class="w-full bg-bgMain border border-borderMain rounded px-2 py-1 text-xs focus:outline-none focus:border-accent text-textMain">
            </div>
        </div>
        
        <div id="file-tree" class="flex-1 overflow-y-auto p-2 space-y-0.5 text-sm" ondragover="allowDrop(event)"></div>
        
        <div class="root-drop-zone p-2 text-xs text-textMuted text-center flex items-end justify-center opacity-50" ondragover="allowDrop(event)" ondrop="dropToRoot(event)">
            Drop here to move to root
        </div>

        <div class="p-2 border-t border-borderMain bg-bgSidebar grid grid-cols-3 gap-2">
            <button id="btn-new-page" class="bg-accent hover:bg-opacity-90 text-white py-1.5 rounded text-xs font-bold flex items-center justify-center" title="New Note"><i class="fa-solid fa-plus"></i></button>
            <button id="btn-new-folder" class="bg-white dark:bg-gray-800 border border-borderMain text-textMain py-1.5 rounded text-xs font-bold flex items-center justify-center" title="New Folder"><i class="fa-solid fa-folder"></i></button>
            <button id="btn-ts-note" class="bg-white dark:bg-gray-800 border border-borderMain text-textMain py-1.5 rounded text-xs font-bold flex items-center justify-center" title="Insert/Create Timestamp Note"><i class="fa-regular fa-clock"></i></button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 relative h-full overflow-hidden bg-bgMain">

        <!-- EDITOR VIEW -->
        <div id="view-editor" class="view-section active flex-col h-full">
            <header class="h-12 bg-bgSidebar border-b border-borderMain flex items-center justify-between px-4 flex-shrink-0">
                <input type="text" id="note-title" class="bg-transparent text-lg font-medium focus:outline-none text-textMain w-full" placeholder="Untitled Page">
                <div class="flex items-center space-x-2 text-xs">
                    <span class="text-textMuted">Board:</span>
                    <select id="note-board" class="bg-bgMain border border-borderMain rounded px-2 py-1 text-textMuted focus:border-accent max-w-[120px]"></select>
                    <span class="text-textMuted">Status:</span>
                    <select id="note-status" class="bg-bgMain border border-borderMain rounded px-2 py-1 text-textMuted focus:border-accent max-w-[120px]"></select>
                    <button id="btn-toggle-mode" class="text-textMuted hover:text-textMain px-2 py-1 border border-borderMain rounded"><i class="fa-regular fa-eye"></i></button>
                    <button id="btn-delete-note" class="text-red-500 hover:text-red-600 px-2 py-1 border border-borderMain rounded" title="Delete Note"><i class="fa-regular fa-trash-can"></i></button>
                    <span id="save-status" class="text-textMuted w-12 text-right"></span>
                </div>
            </header>
            <div class="flex flex-1 overflow-hidden">
                <textarea id="markdown-input" class="w-1/2 h-full bg-bgMain text-textMain p-6 resize-none focus:outline-none font-mono text-sm border-r border-borderMain overflow-y-auto"></textarea>
                <div id="markdown-preview" class="w-1/2 h-full bg-bgMain text-textMain p-6 overflow-y-auto markdown-preview"></div>
            </div>
        </div>

        <!-- WHITEBOARD VIEW -->
        <div id="view-whiteboard" class="view-section relative overflow-hidden cursor-grab active:cursor-grabbing">
            <div class="absolute inset-0 bg-dot-pattern pointer-events-none z-0"></div>
            <div id="wb-canvas" class="absolute top-0 left-0 transform-origin-0-0" style="transform: translate(0px, 0px) scale(1);"></div>
            
            <div class="absolute top-4 left-4 glassy-panel p-3 rounded-lg shadow-lg text-xs z-50 flex flex-col gap-2">
               <div class="flex justify-between items-center border-b border-borderMain pb-2 mb-1">
                   <span class="font-bold text-textMain text-sm">Whiteboard</span>
                   <button onclick="autoArrangeWhiteboard()" class="text-accent hover:text-textMain px-1" title="Auto Arrange Grid"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
               </div>
               <label class="flex items-center cursor-pointer text-textMuted hover:text-textMain"><input type="checkbox" id="wb-show-status" class="mr-2 accent-accent" checked> Status</label>
               <label class="flex items-center cursor-pointer text-textMuted hover:text-textMain"><input type="checkbox" id="wb-show-tags" class="mr-2 accent-accent" checked> Tags</label>
               <label class="flex items-center cursor-pointer text-textMuted hover:text-textMain"><input type="checkbox" id="wb-show-hidden" class="mr-2 accent-accent"> Show Hidden</label>
            </div>
            <div class="absolute bottom-4 right-4 glassy-panel p-2 rounded shadow text-xs text-textMuted z-50">
                Ctrl + Scroll to Zoom • Drag to Pan • Dbl Click to Edit
            </div>
        </div>

        <!-- KANBAN VIEW -->
        <div id="view-kanban" class="view-section overflow-hidden flex-col relative cursor-grab active:cursor-grabbing">
            <div class="h-12 bg-bgSidebar border-b border-borderMain flex items-center justify-between px-4 flex-shrink-0 z-20 relative">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-textMain">Board:</span>
                    <select id="kanban-board-select" class="bg-bgMain border border-borderMain rounded px-2 py-1 text-sm text-textMain focus:border-accent"></select>
                    <button onclick="addBoard()" class="text-textMuted hover:text-accent px-2"><i class="fa-solid fa-plus"></i></button>
                    <button onclick="deleteBoard()" class="text-textMuted hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                    <div class="h-4 w-px bg-borderMain mx-1"></div>
                    <button onclick="toggleKanbanLayout('board')" class="text-textMuted hover:text-textMain px-2" title="Toggle Board Flow"><i class="fa-solid fa-rotate"></i> Board</button>
                    <button onclick="toggleKanbanLayout('items')" class="text-textMuted hover:text-textMain px-2" title="Toggle Items Flow"><i class="fa-solid fa-table-cells-large"></i> Items</button>
                </div>
                <button onclick="addKanbanColumn()" class="bg-accent hover:bg-opacity-90 text-white px-3 py-1.5 rounded text-xs font-bold"><i class="fa-solid fa-plus"></i> New Status</button>
            </div>
            <div class="absolute inset-0 bg-dot-pattern pointer-events-none z-0 top-12"></div>
            <div id="kanban-wrapper" class="flex-1 relative overflow-hidden top-0">
                <div id="kanban-canvas" class="absolute top-0 left-0 transform-origin-0-0 min-h-full" style="transform: translate(0px, 0px) scale(1);">
                     <div id="kanban-container"></div>
                </div>
            </div>
             <div class="absolute bottom-4 left-4 glassy-panel p-2 rounded shadow text-xs text-textMuted z-50">
                Drag Background to Pan • Ctrl+Scroll to Zoom • Drag Cards to Reorder
            </div>
        </div>

        <!-- GRAPH VIEW -->
        <div id="view-graph" class="view-section relative">
            <canvas id="graph-canvas" class="block w-full h-full"></canvas>
            <div class="absolute top-4 right-4 glassy-panel p-3 rounded-lg shadow-lg text-xs flex flex-col gap-3 z-50 w-48">
                <div id="graph-filter-status" class="hidden bg-accent text-white px-2 py-1 rounded flex justify-between items-center">
                    <span id="filter-tag-name" class="mr-2 font-bold truncate"></span>
                    <button onclick="clearGraphFilter()" class="hover:text-gray-200"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="flex flex-col gap-1 pb-2 border-b border-borderMain">
                    <span class="text-textMuted font-bold uppercase tracking-wider text-[10px]">Filters</span>
                    <select id="graph-status-filter" class="bg-bgMain border border-borderMain rounded px-2 py-1 text-textMain mt-1"><option value="all">All Statuses</option></select>
                    <input type="text" id="graph-tag-filter" placeholder="Filter Tags (comma sep)" class="bg-bgMain border border-borderMain rounded px-2 py-1 text-textMain mt-1">
                </div>
                <div class="flex flex-col gap-2">
                    <label class="flex items-center cursor-pointer text-textMain hover:text-accent transition-colors"><input type="checkbox" id="chk-show-tags" class="mr-2 accent-accent" checked> Show Tags</label>
                    <label class="flex items-center cursor-pointer text-textMain hover:text-accent transition-colors"><input type="checkbox" id="chk-freeze-graph" class="mr-2 accent-accent"> Freeze Nodes</label>
                </div>
            </div>
             <div class="absolute bottom-4 left-4 flex gap-2 z-50">
                <button onclick="resetGraphView()" class="glassy-panel p-2 rounded shadow hover:bg-bgHover text-textMain" title="Reset View"><i class="fa-solid fa-crosshairs"></i></button>
                <div class="glassy-panel p-2 rounded shadow text-xs text-textMuted pointer-events-none">
                    Drag node to move • Click node to edit • Pan empty space
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- UTILS ---
        function getLocalTimestamp() {
            const now = new Date();
            const pad = (n) => n.toString().padStart(2, '0');
            const yy = now.getFullYear().toString().slice(2);
            const mm = pad(now.getMonth() + 1);
            const dd = pad(now.getDate());
            const hh = pad(now.getHours());
            const min = pad(now.getMinutes());
            return `${yy}${mm}${dd}${hh}${min}`;
        }

        // --- APP STATE ---
        let state = {
            notes: [], folders: [], boards: [], 
            activeBoardId: 'default', activeNoteId: null, currentView: 'editor', isEditMode: true,
            selectedIds: new Set(), lastSelectedId: null,
            theme: localStorage.getItem('nexus_theme') || 'light',
            wb: { x: 100, y: 100, scale: 1, isPanning: false, lastX: 0, lastY: 0, showStatus: true, showTags: true, showHidden: false },
            kanban: { boardLayout: 'row', itemLayout: 'col', x: 0, y: 0, scale: 1, isPanning: false, lastX: 0, lastY: 0 },
            graph: { showTags: true, frozen: false, filterTag: null, filterStatus: 'all', textFilter: '' },
            sidebar: { filterText: '' }
        };

        // --- DOM ELEMENTS ---
        const el = {
            navBtns: document.querySelectorAll('.nav-btn'), sidebar: document.getElementById('sidebar-tree'), views: document.querySelectorAll('.view-section'),
            sidebarTagFilter: document.getElementById('sidebar-tag-filter'),
            title: document.getElementById('note-title'), noteBoard: document.getElementById('note-board'), status: document.getElementById('note-status'),
            editor: document.getElementById('markdown-input'), preview: document.getElementById('markdown-preview'),
            saveStatus: document.getElementById('save-status'), btnMode: document.getElementById('btn-toggle-mode'), btnDeleteNote: document.getElementById('btn-delete-note'),
            wbCanvas: document.getElementById('wb-canvas'), wbContainer: document.getElementById('view-whiteboard'),
            wbShowStatus: document.getElementById('wb-show-status'), wbShowTags: document.getElementById('wb-show-tags'), wbShowHidden: document.getElementById('wb-show-hidden'),
            kanbanWrapper: document.getElementById('kanban-wrapper'), kanbanCanvas: document.getElementById('kanban-canvas'),
            kanbanContainer: document.getElementById('kanban-container'), kanbanBoardSelect: document.getElementById('kanban-board-select'),
            graphCanvas: document.getElementById('graph-canvas'), chkTags: document.getElementById('chk-show-tags'), chkFreeze: document.getElementById('chk-freeze-graph'),
            graphFilterStatus: document.getElementById('graph-filter-status'), filterTagName: document.getElementById('filter-tag-name'),
            graphStatusSelect: document.getElementById('graph-status-filter'), graphTagFilter: document.getElementById('graph-tag-filter'),
            btnExport: document.getElementById('btn-export'), btnImport: document.getElementById('btn-import'), fileImport: document.getElementById('file-import'),
            btnTsNote: document.getElementById('btn-ts-note')
        };

        // --- INIT ---
        function init() {
            applyTheme(state.theme); loadData();
            if (state.notes.length === 0) createDefaultNote();
            if (!state.activeNoteId && state.notes.length > 0) setActiveNote(state.notes[0].id);
            else if (state.activeNoteId) setActiveNote(state.activeNoteId);
            
            setupWhiteboardInteractions(); setupKanbanInteractions(); setupMarkdownInteractions();
            renderTree(); updateBoardUI(); renderKanban();

            // Listeners
            el.title.addEventListener('input', e => updateActiveNote('title', e.target.value));
            el.status.addEventListener('change', e => updateActiveNote('status', e.target.value));
            el.noteBoard.addEventListener('change', e => updateActiveNote('boardId', e.target.value));
            el.editor.addEventListener('input', updatePreview);
            el.btnMode.addEventListener('click', toggleEditMode);
            el.btnDeleteNote.addEventListener('click', deleteCurrentNote);
            document.getElementById('btn-theme').addEventListener('click', toggleTheme);
            document.getElementById('search-input').addEventListener('input', renderTree);
            document.getElementById('btn-new-page').addEventListener('click', () => createNote());
            document.getElementById('btn-new-folder').addEventListener('click', createFolder);
            el.btnTsNote.addEventListener('click', handleTsButton);
            
            el.sidebarTagFilter.addEventListener('input', (e) => { state.sidebar.filterText = e.target.value; renderTree(); });
            el.btnExport.addEventListener('click', exportData);
            el.btnImport.addEventListener('click', () => el.fileImport.click());
            el.fileImport.addEventListener('change', importData);

            el.chkTags.addEventListener('change', e => { state.graph.showTags = e.target.checked; if(state.currentView === 'graph') initGraph(); });
            el.chkFreeze.addEventListener('change', e => { state.graph.frozen = e.target.checked; if(!state.graph.frozen) animateGraph(); });
            el.graphStatusSelect.addEventListener('change', e => { state.graph.filterStatus = e.target.value; initGraph(); });
            el.graphTagFilter.addEventListener('input', e => { state.graph.textFilter = e.target.value; initGraph(); });

            el.wbShowStatus.addEventListener('change', e => { state.wb.showStatus = e.target.checked; renderWhiteboard(); });
            el.wbShowTags.addEventListener('change', e => { state.wb.showTags = e.target.checked; renderWhiteboard(); });
            el.wbShowHidden.addEventListener('change', e => { state.wb.showHidden = e.target.checked; renderWhiteboard(); });

            el.kanbanBoardSelect.addEventListener('change', (e) => { state.activeBoardId = e.target.value; saveData(); renderKanban(); });
            updateModeUI();
        }

        // --- DATA ---
        function loadData() {
            const raw = localStorage.getItem('nexus_data_v16');
            if (raw) {
                const data = JSON.parse(raw);
                state.notes = data.notes || []; state.folders = data.folders || [];
                state.boards = data.boards || [{ id: 'default', name: 'Main', statuses: ['todo', 'doing', 'done'] }];
                state.activeBoardId = data.activeBoardId || 'default';
                state.kanban = { ...state.kanban, ...data.kanban };
                
                if (!state.boards.find(b => b.id === state.activeBoardId)) {
                     state.activeBoardId = state.boards.length > 0 ? state.boards[0].id : 'default';
                     if(state.boards.length === 0) state.boards = [{ id: 'default', name: 'Main', statuses: ['todo', 'doing', 'done'] }];
                }
                
                state.notes.forEach(n => {
                    if (!n.wb) n.wb = { x: Math.random() * 800, y: Math.random() * 600 };
                    if (!n.boardId) n.boardId = state.activeBoardId;
                    if (!n.status) n.status = 'todo';
                    if (!n.tags) n.tags = [];
                });
            } else {
                state.boards = [{ id: 'default', name: 'Main', statuses: ['todo', 'doing', 'done'] }];
                state.activeBoardId = 'default';
            }
        }

        function saveData() {
            localStorage.setItem('nexus_data_v16', JSON.stringify({ 
                notes: state.notes, folders: state.folders, boards: state.boards, activeBoardId: state.activeBoardId, kanban: state.kanban
            }));
            el.saveStatus.innerText = 'Saved'; setTimeout(() => el.saveStatus.innerText = '', 2000);
        }

        function resetData() { if(confirm("Reset all data?")) { localStorage.removeItem('nexus_data_v16'); location.reload(); } }

        function createDefaultNote() {
            const content = `# Nexus v16 Demo\n\n### 1. Markdown Features\n- **Bold**, *Italic*, [Links](https://example.com)\n- **Lists**:\n  - Unordered\n  - Ordered\n    1. Sub-item\n\n### 2. Code Blocks\n\`\`\`python\nprint("Hello Nexus!")\n\`\`\`\n\n### 3. Checkboxes\n- [x] Task Completed\n- [ ] Task Pending (Click me!)\n\n### 4. Math (LaTeX)\n$$ E = mc^2 $$\n\n### 5. Tables\n| Feature | Status |\n| :--- | :--- |\n| Tags | #working |\n| Tables | Working |`;
            
            const note = {
                id: 'demo_note', title: 'Nexus Demo', content: content, folderId: null, tags: ['demo', 'features'],
                boardId: state.activeBoardId, status: 'todo', wb: { x: 100, y: 100 }, timestamp: Date.now()
            };
            state.notes = [note]; saveData(); setActiveNote(note.id);
        }

        function deleteCurrentNote() {
            if(!state.activeNoteId) return;
            if(confirm("Delete current note?")) {
                state.notes = state.notes.filter(n => n.id !== state.activeNoteId);
                state.activeNoteId = state.notes.length > 0 ? state.notes[0].id : null;
                saveData(); renderTree(); 
                if (state.activeNoteId) setActiveNote(state.activeNoteId);
                else { el.title.value=''; el.editor.value=''; el.preview.innerHTML=''; }
            }
        }

        function handleTsButton() {
            const ts = getLocalTimestamp();
            if (state.activeNoteId && state.currentView === 'editor') {
                const content = el.editor.value;
                const newContent = content + ` ${ts} `;
                el.editor.value = newContent;
                updateActiveNote('content', newContent);
                updatePreview();
            } else {
                createNote(ts);
            }
        }

        function exportData() {
            const ts = getLocalTimestamp();
            const dataStr = JSON.stringify({ notes: state.notes, folders: state.folders, boards: state.boards, activeBoardId: state.activeBoardId, kanban: state.kanban }, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `${ts}.json`; a.click();
        }

        function importData(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (confirm("Overwrite data?")) { localStorage.setItem('nexus_data_v16', JSON.stringify(data)); location.reload(); }
                } catch (err) { alert("Invalid file"); }
            }; reader.readAsText(file);
        }

        function createNote(title = "Untitled", content = "") {
            const board = state.boards.find(b => b.id === state.activeBoardId) || state.boards[0];
            const note = {
                id: '_' + Math.random().toString(36).substr(2, 9),
                title, content, folderId: null, tags: [], boardId: state.activeBoardId, status: 'no-status',
                wb: { x: Math.random() * 500, y: Math.random() * 500 }, timestamp: Date.now()
            };
            state.notes.unshift(note); saveData(); setActiveNote(note.id); renderTree();
            if (state.currentView === 'kanban') renderKanban();
            if (state.currentView === 'whiteboard') renderWhiteboard();
        }

        function createFolder() { const name = prompt("Folder Name:"); if(name) { state.folders.push({ id: '_' + Math.random().toString(36).substr(2,9), name, isOpen: true }); saveData(); renderTree(); }}

        function updateActiveNote(key, value) {
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) {
                note[key] = value;
                if (key === 'boardId') {
                    const newBoard = state.boards.find(b => b.id === value);
                    if (newBoard && !newBoard.statuses.includes(note.status)) note.status = 'no-status';
                    updateBoardUI();
                }
                if (key === 'content') {
                    const tags = [...value.matchAll(/(?<=^|\s)(#[a-zA-Z0-9_]+)/g)].map(m => m[0]);
                    note.tags = [...new Set(tags)];
                }
                note.timestamp = Date.now(); saveData();
                if (key === 'title' || key === 'boardId' || key === 'status') { renderTree(); if(state.currentView === 'whiteboard') renderWhiteboard(); if(state.currentView === 'kanban') renderKanban(); }
            }
        }

        // --- VIEW NAV ---
        window.switchView = (viewName) => {
            state.currentView = viewName;
            el.views.forEach(v => { v.classList.remove('active'); v.style.display = 'none'; });
            const activeView = document.getElementById(`view-${viewName}`);
            activeView.classList.add('active');
            activeView.style.display = (viewName === 'editor' || viewName === 'kanban') ? 'flex' : 'block';
            
            el.navBtns.forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${viewName}`).classList.add('active');

            if (viewName === 'editor') { el.sidebar.classList.remove('w-0', 'opacity-0', 'overflow-hidden'); el.sidebar.classList.add('w-60'); }
            else { el.sidebar.classList.add('w-0', 'opacity-0', 'overflow-hidden'); el.sidebar.classList.remove('w-60'); }

            if (viewName === 'whiteboard') renderWhiteboard();
            if (viewName === 'kanban') renderKanban();
            if (viewName === 'graph') { updateGraphFiltersUI(); requestAnimationFrame(() => { resetGraphView(); initGraph(); }); }
        };

        function setActiveNote(id) {
            state.activeNoteId = id;
            state.selectedIds.clear(); state.selectedIds.add(id); state.lastSelectedId = id; // Reset multi-select
            const note = state.notes.find(n => n.id === id); if (!note) return;
            el.title.value = note.title; el.editor.value = note.content;
            updateBoardUI(); el.noteBoard.value = note.boardId; el.status.value = note.status;
            updatePreview(); renderTree();
        }

        function handleNoteClick(e, id) {
            if (e.shiftKey && state.lastSelectedId) {
                const visibleIds = getVisibleNoteIds();
                const start = visibleIds.indexOf(state.lastSelectedId);
                const end = visibleIds.indexOf(id);
                if (start !== -1 && end !== -1) {
                    const low = Math.min(start, end);
                    const high = Math.max(start, end);
                    for(let i=low; i<=high; i++) state.selectedIds.add(visibleIds[i]);
                }
            } else if (e.ctrlKey || e.metaKey) {
                if (state.selectedIds.has(id)) state.selectedIds.delete(id);
                else state.selectedIds.add(id);
                state.lastSelectedId = id;
            } else {
                setActiveNote(id); 
                return;
            }
            renderTree();
        }

        function getVisibleNoteIds() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const tagTextFilter = state.sidebar.filterText ? state.sidebar.filterText.split(',').map(t => t.trim().toLowerCase().replace('#','')).filter(t=>t) : [];
            const filterFn = (n) => {
                const matchesSearch = n.title.toLowerCase().includes(search);
                let matchesTagText = true;
                if (tagTextFilter.length > 0) matchesTagText = n.tags.some(t => tagTextFilter.some(f => t.toLowerCase().includes(f)));
                return matchesSearch && matchesTagText;
            };
            
            let ids = [];
            state.folders.forEach(f => {
                if(f.isOpen) {
                    state.notes.filter(n => n.folderId === f.id && filterFn(n)).forEach(n => ids.push(n.id));
                }
            });
            state.notes.filter(n => !n.folderId && filterFn(n)).forEach(n => ids.push(n.id));
            return ids;
        }

        function updateBoardUI() {
            const boardOpts = state.boards.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            el.kanbanBoardSelect.innerHTML = boardOpts; el.kanbanBoardSelect.value = state.activeBoardId;
            el.noteBoard.innerHTML = boardOpts;
            const note = state.notes.find(n => n.id === state.activeNoteId);
            const targetBoardId = note ? note.boardId : state.activeBoardId;
            const board = state.boards.find(b => b.id === targetBoardId) || state.boards[0];
            if (board) {
                el.status.innerHTML = board.statuses.map(s => `<option value="${s}">${s}</option>`).join('');
                if (note) el.status.value = note.status;
            }
        }

        function updatePreview() {
            const raw = el.editor.value;
            const mathStore = [];
            let text = raw
                .replace(/\$\$([\s\S]*?)\$\$/g, (m, t) => { mathStore.push({t, d:true}); return `%%%M${mathStore.length-1}%%%`; })
                .replace(/\$((?!\$)[\s\S]*?)\$/g, (m, t) => { mathStore.push({t, d:false}); return `%%%M${mathStore.length-1}%%%`; });
            let html = marked.parse(text);
            html = html.replace(/%%%M(\d+)%%%/g, (m, i) => { const entry = mathStore[i]; try { return katex.renderToString(entry.t, { displayMode: entry.d, throwOnError: false }); } catch { return entry.t; } });
            html = html.replace(/\[\[(.*?)\]\]/g, (m, t) => { const exists = state.notes.some(n => n.title.toLowerCase() === t.toLowerCase()); const cls = exists ? 'wikilink' : 'wikilink is-missing'; return `<span class="${cls}" onclick="handleLink('${t.replace(/'/g, "\\'")}')">${t}</span>`; });
            html = html.replace(/(^|\s|>)(#[a-zA-Z0-9_]+)/g, '$1<span class="tag-pill" onclick="handleTagClick(\'$2\')">$2</span>');
            html = html.replace(/disabled=""/g, ''); 
            el.preview.innerHTML = html;
            updateActiveNote('content', raw);
        }

        function setupMarkdownInteractions() {
            el.preview.addEventListener('click', (e) => { if (e.target.tagName === 'INPUT' && e.target.type === 'checkbox') toggleTodo(e.target); });
        }

        function toggleTodo(checkbox) {
            const allChecks = Array.from(el.preview.querySelectorAll('input[type="checkbox"]'));
            const index = allChecks.indexOf(checkbox);
            let raw = el.editor.value;
            let matchIndex = -1;
            const regex = /^(\s*[-*]\s\[)([ x])(\])/gm; // Capture indent
            const newRaw = raw.replace(regex, (match, prefix, state, suffix) => {
                matchIndex++;
                if (matchIndex === index) return `${prefix}${state === ' ' ? 'x' : ' '}${suffix}`;
                return match;
            });
            if (newRaw !== raw) { el.editor.value = newRaw; updateActiveNote('content', newRaw); updatePreview(); }
        }

        window.handleLink = (title) => { const target = state.notes.find(n => n.title.toLowerCase() === title.toLowerCase()); if (target) { setActiveNote(target.id); switchView('editor'); } else createNote(title, `# ${title}`); };
        window.handleTagClick = (tagName) => { const cleanTag = tagName.startsWith('#') ? tagName.substring(1) : tagName; switchView('graph'); state.graph.filterTag = cleanTag; state.graph.textFilter = cleanTag; el.graphTagFilter.value = cleanTag; el.graphFilterStatus.classList.remove('hidden'); el.filterTagName.innerText = tagName; requestAnimationFrame(() => initGraph()); };
        window.clearGraphFilter = () => { state.graph.filterTag = null; state.graph.textFilter = ''; el.graphTagFilter.value = ''; el.graphFilterStatus.classList.add('hidden'); initGraph(); };
        function toggleEditMode() { state.isEditMode = !state.isEditMode; updateModeUI(); }
        function updateModeUI() { if (state.isEditMode) { el.editor.classList.remove('hidden'); el.editor.classList.add('w-1/2'); el.preview.classList.remove('w-full'); el.preview.classList.add('w-1/2'); el.btnMode.innerHTML = '<i class="fa-regular fa-eye"></i>'; } else { el.editor.classList.add('hidden'); el.editor.classList.remove('w-1/2'); el.preview.classList.remove('w-1/2'); el.preview.classList.add('w-full'); el.btnMode.innerHTML = '<i class="fa-solid fa-pen-to-square"></i>'; } }

        function setupPanZoom(container, canvas, stateObj) {
            container.addEventListener('wheel', e => { if (e.ctrlKey) { e.preventDefault(); const s = Math.exp(-e.deltaY * 0.001); stateObj.scale = Math.min(Math.max(0.1, stateObj.scale * s), 4); } else { stateObj.x -= e.deltaX; stateObj.y -= e.deltaY; } updateTransform(canvas, stateObj); saveData(); });
            container.addEventListener('mousedown', e => { if (e.target === container || e.target === canvas || e.target.id === 'kanban-container') { stateObj.isPanning = true; stateObj.lastX = e.clientX; stateObj.lastY = e.clientY; container.style.cursor = 'grabbing'; } });
            window.addEventListener('mousemove', e => { if (stateObj.isPanning) { stateObj.x += e.clientX - stateObj.lastX; stateObj.y += e.clientY - stateObj.lastY; stateObj.lastX = e.clientX; stateObj.lastY = e.clientY; updateTransform(canvas, stateObj); } });
            window.addEventListener('mouseup', () => { stateObj.isPanning = false; container.style.cursor = 'grab'; });
        }
        function updateTransform(el, state) { el.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`; }

        function setupWhiteboardInteractions() {
            setupPanZoom(el.wbContainer, el.wbCanvas, state.wb);
            window.addEventListener('mousemove', e => { if (window.draggedCard) { const dx = (e.clientX - window.dragStart.x) / state.wb.scale; const dy = (e.clientY - window.dragStart.y) / state.wb.scale; const note = state.notes.find(n => n.id === window.draggedCard); note.wb.x = window.cardStart.x + dx; note.wb.y = window.cardStart.y + dy; renderWhiteboard(); } });
            window.addEventListener('mouseup', () => { if(window.draggedCard) { window.draggedCard = null; saveData(); } });
        }
        function renderWhiteboard() {
            el.wbCanvas.innerHTML = '';
            state.notes.forEach(note => {
                if (note.status === 'no-status' && !state.wb.showHidden) return; 
                const card = document.createElement('div'); card.className = 'wb-card'; card.style.left = `${note.wb.x}px`; card.style.top = `${note.wb.y}px`;
                const header = document.createElement('div'); header.className = 'wb-header'; header.innerHTML = `<span class="truncate mr-2">${note.title}</span> <i class="fa-solid fa-up-right-from-square text-xs text-textMuted hover:text-accent cursor-pointer" onclick="editNote('${note.id}')"></i>`; header.onmousedown = (e) => startCardDrag(e, note.id);
                const body = document.createElement('div'); body.className = 'wb-body'; body.innerText = note.content;
                card.appendChild(header); card.appendChild(body);
                if (state.wb.showStatus || (state.wb.showTags && note.tags.length > 0)) { const footer = document.createElement('div'); footer.className = 'wb-footer'; if (state.wb.showStatus) footer.innerHTML += `<div class="wb-status-badge" onclick="cycleStatus('${note.id}')">${note.status}</div>`; if (state.wb.showTags) footer.innerHTML += note.tags.map(t => `<span class="tag-pill" onclick="handleTagClick('${t}')">#${t}</span>`).join(''); card.appendChild(footer); }
                el.wbCanvas.appendChild(card);
            }); updateTransform(el.wbCanvas, state.wb);
        }
        window.cycleStatus = (id) => { const note = state.notes.find(n => n.id === id); if (note) { const board = state.boards.find(b => b.id === note.boardId) || state.boards[0]; const currIdx = board.statuses.indexOf(note.status); note.status = board.statuses[(currIdx + 1) % board.statuses.length]; saveData(); renderWhiteboard(); } };
        window.editNote = (id) => { setActiveNote(id); switchView('editor'); };
        window.autoArrangeWhiteboard = () => { const visible = state.notes.filter(n => n.status !== 'no-status' || state.wb.showHidden); const cols = Math.ceil(Math.sqrt(visible.length)); const spacing = 320; visible.forEach((n, i) => { n.wb.x = (i % cols) * spacing; n.wb.y = Math.floor(i / cols) * spacing; }); state.wb.x = 100; state.wb.y = 100; state.wb.scale = 1; saveData(); renderWhiteboard(); };
        function startCardDrag(e, id) { if(e.target.closest('.fa-up-right-from-square')) return; e.stopPropagation(); window.draggedCard = id; window.dragStart = { x: e.clientX, y: e.clientY }; const note = state.notes.find(n => n.id === id); window.cardStart = { x: note.wb.x, y: note.wb.y }; }

        function setupKanbanInteractions() { setupPanZoom(el.kanbanWrapper, el.kanbanCanvas, state.kanban); updateTransform(el.kanbanCanvas, state.kanban); }
        function renderKanban() {
            const container = el.kanbanContainer; container.innerHTML = ''; container.className = `kanban-container layout-${state.kanban.boardLayout}`;
            const activeBoard = state.boards.find(b => b.id === state.activeBoardId) || state.boards[0];
            
            activeBoard.statuses.forEach((status, index) => {
                const col = document.createElement('div'); col.className = 'kanban-col';
                col.draggable = true; col.ondragstart = (e) => { e.dataTransfer.setData('col-idx', index); e.dataTransfer.effectAllowed = "move"; }; col.ondragover = allowDrop; col.ondrop = (e) => dropKanbanCol(e, index);
                const dropZone = document.createElement('div'); dropZone.className = 'kanban-drop-zone'; dropZone.ondragover = allowDrop; dropZone.ondrop = (e) => { e.stopPropagation(); dropKanbanNote(e, status); };
                const colNotes = state.notes.filter(n => n.boardId === activeBoard.id && n.status === status);
                col.innerHTML = `<div class="kanban-header"><span class="uppercase text-xs font-bold tracking-wider cursor-pointer" ondblclick="renameStatus('${status}')">${status}</span><div class="flex items-center gap-2"><span class="text-xs bg-bgHover px-2 rounded-full">${colNotes.length}</span><i class="fa-solid fa-xmark text-textMuted hover:text-red-500 cursor-pointer text-xs" onclick="deleteStatus('${status}')"></i></div></div>`;
                const list = document.createElement('div'); list.className = `kanban-list items-${state.kanban.itemLayout}`;
                colNotes.forEach(note => {
                    const card = document.createElement('div'); card.className = 'kanban-card'; card.draggable = true;
                    let tagsHtml = (note.tags && note.tags.length > 0) ? `<div class="mt-2 pt-1 border-t border-borderMain flex flex-wrap gap-1">` + note.tags.map(t => `<span class="tag-pill" onclick="event.stopPropagation(); handleTagClick('${t}')">#${t}</span>`).join('') + `</div>` : '';
                    card.innerHTML = `<div class="font-medium text-sm">${note.title}</div><div class="text-xs text-textMuted mt-1 truncate">${note.content.substring(0,50)}</div>${tagsHtml}`;
                    card.ondragstart = (e) => { e.dataTransfer.setData('text/plain', note.id); e.stopPropagation(); };
                    // Allow drop on card for reordering
                    card.ondragover = allowDrop; 
                    card.ondrop = (e) => { e.stopPropagation(); handleReorder(e.dataTransfer.getData('text/plain'), note.id); };
                    card.onclick = () => { setActiveNote(note.id); switchView('editor'); };
                    list.appendChild(card);
                });
                dropZone.appendChild(list); col.appendChild(dropZone); container.appendChild(col);
            });
        }

        window.toggleKanbanLayout = (type) => { if (type === 'board') state.kanban.boardLayout = state.kanban.boardLayout === 'row' ? 'col' : 'row'; else state.kanban.itemLayout = state.kanban.itemLayout === 'col' ? 'row' : 'col'; saveData(); renderKanban(); };
        window.addBoard = () => { const name = prompt("New Board Name:"); if (name) { const id = '_' + Math.random().toString(36).substr(2,9); state.boards.push({ id, name, statuses: ['no-status', 'todo', 'doing', 'done'] }); state.activeBoardId = id; saveData(); updateBoardUI(); renderKanban(); }};
        window.deleteBoard = () => { if (state.boards.length <= 1) return; if (confirm("Delete board?")) { state.boards = state.boards.filter(b => b.id !== state.activeBoardId); state.activeBoardId = state.boards[0].id; saveData(); updateBoardUI(); renderKanban(); }};
        window.addKanbanColumn = () => { const board = state.boards.find(b => b.id === state.activeBoardId); const name = prompt("New Status Name:"); if (name && !board.statuses.includes(name)) { board.statuses.push(name); saveData(); renderKanban(); updateBoardUI(); }};
        window.renameStatus = (oldName) => { const board = state.boards.find(b => b.id === state.activeBoardId); const newName = prompt("Rename:", oldName); if (newName && !board.statuses.includes(newName)) { board.statuses[board.statuses.indexOf(oldName)] = newName; state.notes.filter(n => n.boardId === board.id && n.status === oldName).forEach(n => n.status = newName); saveData(); renderKanban(); updateBoardUI(); }};
        window.deleteStatus = (status) => { const board = state.boards.find(b => b.id === state.activeBoardId); if (confirm(`Delete "${status}"?`)) { board.statuses = board.statuses.filter(s => s !== status); if(board.statuses.length===0) board.statuses.push('no-status'); state.notes.filter(n => n.boardId === board.id && n.status === status).forEach(n => n.status = board.statuses[0]); saveData(); renderKanban(); updateBoardUI(); }};
        window.allowDrop = (e) => e.preventDefault();
        window.dropKanbanNote = (e, status) => { e.preventDefault(); const id = e.dataTransfer.getData('text/plain'); if(!id) return; const note = state.notes.find(n => n.id === id); if (note) { note.boardId = state.activeBoardId; note.status = status; saveData(); renderKanban(); }};
        window.dropKanbanCol = (e, targetIdx) => { e.preventDefault(); const srcIdx = e.dataTransfer.getData('col-idx'); if (srcIdx === "") return; const board = state.boards.find(b => b.id === state.activeBoardId); const s = [...board.statuses]; const [r] = s.splice(srcIdx, 1); s.splice(targetIdx, 0, r); board.statuses = s; saveData(); renderKanban(); updateBoardUI(); };

        window.handleReorder = (draggedId, targetId) => {
            if (draggedId === targetId) return;
            const draggedIndex = state.notes.findIndex(n => n.id === draggedId);
            const targetIndex = state.notes.findIndex(n => n.id === targetId);
            if (draggedIndex > -1 && targetIndex > -1) {
                const [removed] = state.notes.splice(draggedIndex, 1);
                state.notes.splice(targetIndex, 0, removed);
                saveData();
                renderKanban();
            }
        };

        // --- GRAPH ---
        let ctx = el.graphCanvas.getContext('2d');
        let graphNodes = [], graphLinks = [];
        let graphTransform = { x: 0, y: 0, k: 1 };
        let animationFrameId;

        window.resetGraphView = () => { const rect = el.graphCanvas.parentElement.getBoundingClientRect(); if(rect.width) { el.graphCanvas.width = rect.width; el.graphCanvas.height = rect.height; graphTransform = { x: rect.width/2, y: rect.height/2, k: 1 }; drawGraph(); } };
        function updateGraphFiltersUI() { const allStatuses = new Set(state.notes.map(n => n.status)); el.graphStatusSelect.innerHTML = `<option value="all">All Statuses</option>` + Array.from(allStatuses).map(s => `<option value="${s}">${s}</option>`).join(''); el.graphStatusSelect.value = state.graph.filterStatus; }

        function initGraph() {
            const rect = el.graphCanvas.parentElement.getBoundingClientRect(); if (rect.width === 0) return;
            el.graphCanvas.width = rect.width; el.graphCanvas.height = rect.height;
            let visibleNotes = state.notes;
            if (state.graph.textFilter) { const searchTags = state.graph.textFilter.split(',').map(t => t.trim().toLowerCase()).filter(t => t); if (searchTags.length > 0) { visibleNotes = visibleNotes.filter(n => n.tags.some(tag => searchTags.some(st => tag.toLowerCase().includes(st)))); } }
            if (state.graph.filterTag) { visibleNotes = visibleNotes.filter(n => n.tags.includes(state.graph.filterTag)); }
            if (state.graph.filterStatus !== 'all') visibleNotes = visibleNotes.filter(n => n.status === state.graph.filterStatus);
            graphNodes = visibleNotes.map(n => { const existing = graphNodes.find(gn => gn.id === n.id); return { id: n.id, label: n.title, type: 'note', x: existing ? existing.x : (Math.random()-0.5)*rect.width*0.5, y: existing ? existing.y : (Math.random()-0.5)*rect.height*0.5, vx: existing ? existing.vx : 0, vy: existing ? existing.vy : 0 }; });
            const showTags = state.graph.showTags || state.graph.filterTag;
            if(showTags) { const tags = new Set(); visibleNotes.forEach(n => n.tags.forEach(t => tags.add(t))); tags.forEach(t => { const existing = graphNodes.find(gn => gn.id === `tag_${t}`); graphNodes.push({ id: `tag_${t}`, label: t, type: 'tag', x: existing?existing.x:(Math.random()-0.5)*rect.width*0.4, y: existing?existing.y:(Math.random()-0.5)*rect.height*0.4, vx:0, vy:0 }) }); }
            graphLinks = []; visibleNotes.forEach(n => { const links = [...n.content.matchAll(/\[\[(.*?)\]\]/g)].map(m => m[1]); links.forEach(l => { const target = visibleNotes.find(t => t.title.toLowerCase() === l.toLowerCase()); if(target) graphLinks.push({ source: n.id, target: target.id }); }); if(showTags) n.tags.forEach(t => graphLinks.push({ source: n.id, target: `tag_${t}` })); });
            if(!state.graph.frozen) animateGraph(); else drawGraph();
        }

        function animateGraph() {
            if(state.currentView !== 'graph' || state.graph.frozen) return;
            for(let i=0; i<graphNodes.length; i++) { for(let j=i+1; j<graphNodes.length; j++) { let dx = graphNodes[j].x - graphNodes[i].x; let dy = graphNodes[j].y - graphNodes[i].y; let d2 = dx*dx + dy*dy || 1; if(d2 < 200000) { let force = 400 / d2; let fx = (dx/Math.sqrt(d2)) * force; let fy = (dy/Math.sqrt(d2)) * force; graphNodes[j].vx += fx; graphNodes[j].vy += fy; graphNodes[i].vx -= fx; graphNodes[i].vy -= fy; } } }
            graphLinks.forEach(l => { let s = graphNodes.find(n => n.id === l.source); let t = graphNodes.find(n => n.id === l.target); if(s && t) { let dx = t.x - s.x; let dy = t.y - s.y; s.vx += dx * 0.005; s.vy += dy * 0.005; t.vx -= dx * 0.005; t.vy -= dy * 0.005; } });
            graphNodes.forEach(n => { if (n !== draggedGraphNode) { n.x += n.vx; n.y += n.vy; n.vx *= 0.9; n.vy *= 0.9; n.x -= n.x * 0.001; n.y -= n.y * 0.001; } else { n.vx = 0; n.vy = 0; } });
            drawGraph(); requestAnimationFrame(animateGraph);
        }

        function drawGraph() {
            ctx.clearRect(0, 0, el.graphCanvas.width, el.graphCanvas.height); ctx.save(); ctx.translate(graphTransform.x, graphTransform.y); ctx.scale(graphTransform.k, graphTransform.k);
            const style = getComputedStyle(document.body); const cLine = style.getPropertyValue('--text-muted').trim(); const cAccent = style.getPropertyValue('--accent').trim(); const cTag = style.getPropertyValue('--tag-color').trim();
            ctx.beginPath(); ctx.strokeStyle = cLine; graphLinks.forEach(l => { let s = graphNodes.find(n => n.id === l.source); let t = graphNodes.find(n => n.id === l.target); if(s && t) { ctx.moveTo(s.x, s.y); ctx.lineTo(t.x, t.y); } }); ctx.stroke();
            graphNodes.forEach(n => { ctx.beginPath(); ctx.arc(n.x, n.y, n.type==='tag'?4:6, 0, Math.PI*2); ctx.fillStyle = n.type === 'tag' ? cTag : (n.id === state.activeNoteId ? cAccent : '#9ca3af'); ctx.fill(); ctx.fillStyle = style.getPropertyValue('--text-main').trim(); ctx.font = '10px Inter'; ctx.fillText(n.label, n.x + 8, n.y + 3); });
            ctx.restore();
        }
        
        let isDraggingGraph = false, graphDragStart = {x:0, y:0}, draggedGraphNode = null, mouseDownTime = 0, mouseDownPos = {x:0, y:0};
        el.graphCanvas.addEventListener('mousedown', e => {
            mouseDownTime = Date.now(); mouseDownPos = {x: e.clientX, y: e.clientY};
            const rect = el.graphCanvas.getBoundingClientRect(); const mx = (e.clientX - rect.left - graphTransform.x) / graphTransform.k; const my = (e.clientY - rect.top - graphTransform.y) / graphTransform.k;
            const clicked = graphNodes.find(n => (n.x-mx)**2 + (n.y-my)**2 < 100);
            if(clicked) { draggedGraphNode = clicked; isDraggingGraph = true; graphDragStart = { x: e.clientX, y: e.clientY, type: 'node' }; } else { isDraggingGraph = true; graphDragStart = { x: e.clientX, y: e.clientY, type: 'pan' }; }
        });
        el.graphCanvas.addEventListener('mousemove', e => {
            if(isDraggingGraph) {
                if (graphDragStart.type === 'pan') { graphTransform.x += e.clientX - graphDragStart.x; graphTransform.y += e.clientY - graphDragStart.y; } 
                else if (graphDragStart.type === 'node' && draggedGraphNode) { draggedGraphNode.x += (e.clientX - graphDragStart.x) / graphTransform.k; draggedGraphNode.y += (e.clientY - graphDragStart.y) / graphTransform.k; }
                graphDragStart = { x: e.clientX, y: e.clientY, type: graphDragStart.type }; if(state.graph.frozen) drawGraph();
            }
        });
        el.graphCanvas.addEventListener('mouseup', (e) => { 
            const timeDiff = Date.now() - mouseDownTime; const distDiff = Math.hypot(e.clientX - mouseDownPos.x, e.clientY - mouseDownPos.y);
            if (draggedGraphNode && graphDragStart.type === 'node' && timeDiff < 200 && distDiff < 5) { if (draggedGraphNode.type === 'tag') window.handleTagClick(draggedGraphNode.label); else { setActiveNote(draggedGraphNode.id); switchView('editor'); } }
            isDraggingGraph = false; draggedGraphNode = null; 
        });
        el.graphCanvas.addEventListener('wheel', e => { e.preventDefault(); graphTransform.k = Math.max(0.1, graphTransform.k - e.deltaY * 0.001); drawGraph(); });

        // --- SIDEBAR FILTER ---
        function updateSidebarFilterUI() {
             const type = el.sidebarFilterType.value; state.sidebar.filterType = type; el.sidebarFilterVal.innerHTML = '<option value="">Select...</option>'; el.sidebarFilterVal.disabled = (type === 'all');
             if(type === 'status') { const statuses = new Set(state.notes.map(n => n.status)); el.sidebarFilterVal.innerHTML += Array.from(statuses).map(s => `<option value="${s}">${s}</option>`).join(''); } 
             else if(type === 'tag') { const tags = new Set(state.notes.flatMap(n => n.tags)); el.sidebarFilterVal.innerHTML += Array.from(tags).map(t => `<option value="${t}">${t}</option>`).join(''); }
             renderTree();
        }

        function renderTree() {
            const c = document.getElementById('file-tree'); c.innerHTML = '';
            const search = document.getElementById('search-input').value.toLowerCase();
            const tagTextFilter = state.sidebar.filterText ? state.sidebar.filterText.split(',').map(t => t.trim().toLowerCase().replace('#','')).filter(t=>t) : [];

            const filterFn = (n) => {
                const matchesSearch = n.title.toLowerCase().includes(search);
                let matchesTagText = true;
                if (tagTextFilter.length > 0) matchesTagText = n.tags.some(t => tagTextFilter.some(f => t.toLowerCase().includes(f)));
                return matchesSearch && matchesTagText;
            };

            state.folders.forEach(f => {
                const div = document.createElement('div'); div.draggable = false; div.className = 'folder-container mb-1';
                const header = document.createElement('div'); header.className = 'p-1 text-textMain font-bold flex items-center cursor-pointer hover:bg-bgHover rounded';
                header.innerHTML = `<i class="fa-solid ${f.isOpen?'fa-chevron-down':'fa-chevron-right'} w-4 text-xs mr-1 text-textMuted"></i> ${f.name}`;
                header.onclick = () => { f.isOpen = !f.isOpen; saveData(); renderTree(); };
                header.ondragover = (e) => { e.preventDefault(); header.classList.add('drop-target'); };
                header.ondragleave = () => header.classList.remove('drop-target');
                header.ondrop = (e) => handleDrop(e, f.id);
                div.appendChild(header);
                if(f.isOpen) { state.notes.filter(n => n.folderId === f.id && filterFn(n)).forEach(n => div.appendChild(createTreeItem(n, true))); }
                c.appendChild(div);
            });
            state.notes.filter(n => !n.folderId && filterFn(n)).forEach(n => c.appendChild(createTreeItem(n, false)));
        }

        function createTreeItem(note, indent) {
            const div = document.createElement('div'); const isSelected = state.selectedIds.has(note.id);
            div.className = `sidebar-item p-1 flex items-center cursor-pointer rounded ${indent?'ml-4':''} ${note.id===state.activeNoteId?'active':''} ${isSelected?'selected':''}`;
            div.draggable = true; div.innerHTML = `<i class="fa-regular fa-file-lines text-xs mr-2 w-4 text-center text-textMuted"></i> <span class="truncate">${note.title}</span>`;
            div.onclick = (e) => handleNoteClick(e, note.id); div.ondragstart = (e) => handleDragStart(e, note.id);
            return div;
        }

        function handleDragStart(e, id) {
            if (!state.selectedIds.has(id)) { state.selectedIds.clear(); state.selectedIds.add(id); renderTree(); }
            const ids = Array.from(state.selectedIds); e.dataTransfer.setData('note-ids', JSON.stringify(ids)); e.dataTransfer.effectAllowed = "move";
        }
        function allowDrop(e) { e.preventDefault(); if (e.target.classList.contains('root-drop-zone')) e.target.classList.add('drop-target'); }
        function handleDrop(e, targetFolderId) {
            e.preventDefault(); e.target.classList.remove('drop-target');
            const data = e.dataTransfer.getData('note-ids'); if (!data) return;
            const ids = JSON.parse(data);
            state.notes.forEach(n => { if (ids.includes(n.id)) n.folderId = targetFolderId; });
            saveData(); renderTree();
        }
        window.dropToRoot = (e) => { handleDrop(e, null); }

        function toggleTheme() { state.theme = state.theme === 'dark' ? 'light' : 'dark'; applyTheme(state.theme); if(state.currentView === 'graph') drawGraph(); }
        function applyTheme(theme) { localStorage.setItem('nexus_theme', theme); document.documentElement.className = theme; document.querySelector('#btn-theme i').className = theme === 'dark' ? 'fa-regular fa-moon' : 'fa-regular fa-sun'; }

        init();
    </script>
</body>
</html>
