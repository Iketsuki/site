<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robo-Academy: Train Your AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-x: hidden;
        }

        .canvas-container {
            position: relative;
            box-shadow: 0 0 50px rgba(56, 189, 248, 0.1);
            max-width: 100%;
        }

        canvas {
            border-radius: 12px;
            cursor: crosshair;
            touch-action: none;
            max-width: 100%;
            height: auto;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #38bdf8;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 10px #38bdf8;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        input[type=number] {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 4px 8px;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            width: 100%;
        }
        input[type=number]:focus {
            outline: none;
            border-color: #38bdf8;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }

        .challenge-card {
            border: 1px solid #334155;
            transition: all 0.2s;
        }
        .challenge-card:hover {
            border-color: #38bdf8;
            background: rgba(56, 189, 248, 0.1);
        }
        .challenge-active {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .tool-btn.active {
            background-color: #2563eb;
            color: white;
            ring-width: 2px;
            ring-color: #60a5fa;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col lg:flex-row">

    <!-- Sidebar / Controls -->
    <div class="w-full lg:w-[28rem] glass-panel p-5 flex flex-col gap-4 z-10 border-r border-slate-700 overflow-y-auto max-h-screen scrollbar-hide">
        
        <!-- Header -->
        <div class="flex items-center justify-between pb-2 border-b border-slate-700">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="fas fa-robot text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-none">Robo-Academy</h1>
                    <p class="text-xs text-slate-400">RL Educational Lab</p>
                </div>
            </div>
            <!-- Mode Switcher -->
            <div class="flex bg-slate-800 rounded-lg p-1">
                <button onclick="setMode('sandbox')" id="btnModeSandbox" class="px-3 py-1 rounded text-xs font-bold bg-slate-600 text-white shadow transition-colors">Sandbox</button>
                <button onclick="setMode('challenge')" id="btnModeChallenge" class="px-3 py-1 rounded text-xs font-bold text-slate-400 hover:text-white transition-colors">Challenges</button>
            </div>
        </div>

        <!-- SHARED PRIMARY CONTROLS -->
        <div class="space-y-3">
            <div class="grid grid-cols-2 gap-2">
                <button id="btnTrain" class="bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-500/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-play"></i> Train AI
                </button>
                <button id="btnReset" class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>
            
            <div class="flex items-center gap-2 bg-slate-800/50 p-2 rounded-lg border border-slate-700">
                <div class="flex-1">
                    <div class="flex justify-between text-[10px] text-slate-400 font-bold mb-1">
                        <span>SIMULATION SPEED</span>
                        <span id="speedLabel" class="text-blue-400">Normal</span>
                    </div>
                    <input type="range" min="1" max="100" value="50" id="speedSlider">
                </div>
                <div class="h-8 w-px bg-slate-700 mx-1"></div>
                <div class="flex flex-col items-center justify-center px-1">
                    <span class="text-[9px] font-bold text-slate-400 mb-1">LOOP</span>
                    <div class="relative inline-block w-8 align-middle select-none">
                        <input type="checkbox" id="autoTrainToggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 checked:right-0 checked:border-emerald-400"/>
                        <label for="autoTrainToggle" class="toggle-label block overflow-hidden h-4 rounded-full bg-slate-300 cursor-pointer checked:bg-emerald-400"></label>
                    </div>
                </div>
            </div>

            <button id="btnNextEp" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold shadow-lg hidden animate-pulse text-sm">
                Next Episode <i class="fas fa-forward ml-2"></i>
            </button>
        </div>

        <!-- CHALLENGE SECTION -->
        <div id="challengeSection" class="hidden space-y-4">
            <div class="bg-indigo-900/30 border border-indigo-500/30 p-3 rounded-lg text-sm text-indigo-200">
                <i class="fas fa-graduation-cap mr-2"></i> <strong>Mission:</strong> Parameters start at 0. Tune them to make the AI survive and win.
            </div>
            
            <div id="challengeList" class="space-y-2 max-h-56 overflow-y-auto scrollbar-hide">
                <!-- Challenges injected via JS -->
            </div>

            <div id="activeChallengeBox" class="hidden bg-slate-800 p-4 rounded-xl border border-yellow-500/50 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fas fa-trophy text-4xl text-yellow-500"></i></div>
                
                <h3 class="font-bold text-yellow-400 text-xs uppercase mb-1 flex items-center gap-2">
                    <i class="fas fa-flag"></i> Current Objective
                </h3>
                <p id="challengeObjective" class="text-sm font-bold text-white mb-2 leading-tight">...</p>
                
                <div class="bg-slate-900/50 rounded p-2 mb-2 text-xs text-slate-300 border border-slate-700">
                    <strong class="text-blue-400">Advisor:</strong> <span id="challengeAdvisor">Click 'Train AI' to see how it fails.</span>
                </div>

                <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                    <div id="challengeProgress" class="bg-yellow-500 h-full w-0 transition-all duration-500"></div>
                </div>
                <p id="challengeProgressText" class="text-[10px] text-right text-slate-400 mt-1">0% Complete</p>
            </div>
        </div>

        <!-- SANDBOX SECTION (Map Builder) -->
        <div id="sandboxSection" class="space-y-4">
            <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-700 relative">
                <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">Map Builder</h2>
                
                <!-- Tools Grid -->
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button class="tool-btn active py-2 rounded-lg bg-blue-600 text-white text-xs font-bold ring-2 ring-blue-400 ring-offset-2 ring-offset-slate-900 transition-all" data-tool="wall" title="Draw Walls">
                        <i class="fas fa-square mr-1"></i> Wall
                    </button>
                    <button class="tool-btn py-2 rounded-lg bg-slate-700 text-slate-300 text-xs font-bold hover:bg-slate-600 transition-all" data-tool="eraser" title="Eraser">
                        <i class="fas fa-eraser mr-1"></i> Eraser
                    </button>
                    <button class="tool-btn py-2 rounded-lg bg-slate-700 text-slate-300 text-xs font-bold hover:bg-slate-600 transition-all" data-tool="spawn" title="Set Spawn Point">
                        <i class="fas fa-robot text-blue-400 mr-1"></i> Spawn
                    </button>
                    <button class="tool-btn py-2 rounded-lg bg-slate-700 text-slate-300 text-xs font-bold hover:bg-slate-600 transition-all" data-tool="goal" title="Move Goal">
                        <i class="fas fa-star text-yellow-400 mr-1"></i> Goal
                    </button>
                    <button class="tool-btn py-2 rounded-lg bg-slate-700 text-slate-300 text-xs font-bold hover:bg-slate-600 transition-all" data-tool="button" title="Place Button">
                        <i class="fas fa-circle text-purple-400 mr-1"></i> Button
                    </button>
                    <button class="tool-btn py-2 rounded-lg bg-slate-700 text-slate-300 text-xs font-bold hover:bg-slate-600 transition-all" data-tool="hazard" title="Place Hazard (Lava)">
                        <i class="fas fa-fire text-orange-500 mr-1"></i> Hazard
                    </button>
                </div>
                
                <div class="flex items-center gap-2 mt-3 pt-3 border-t border-slate-700/50">
                    <input type="number" id="gridCols" value="5" min="3" max="25" class="text-center w-16" placeholder="W">
                    <span class="text-slate-500 text-xs">x</span>
                    <input type="number" id="gridRows" value="5" min="3" max="25" class="text-center w-16" placeholder="H">
                    <button id="btnApplyGrid" class="flex-1 bg-slate-700 hover:bg-slate-600 text-[10px] py-2 rounded text-slate-300 uppercase font-bold tracking-wide">Resize</button>
                </div>
            </div>
        </div>

        <!-- LOGIC LAB (Educational Parameters) -->
        <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-700 flex-1 flex flex-col">
            <h2 class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3 flex justify-between items-center">
                Logic Lab 
                <span class="text-[9px] bg-slate-800 px-2 py-0.5 rounded text-slate-500">HYPERPARAMETERS</span>
            </h2>
            
            <div class="space-y-3 flex-1 overflow-y-auto max-h-[220px] scrollbar-hide pr-1" id="logicLabContainer">
                <!-- Goal Reward -->
                <div class="group param-row" data-info="The reward (happiness) for reaching the goal. Higher = More motivated to win.">
                    <div class="flex items-center gap-2 mb-1">
                        <label class="text-xs font-bold text-green-400 w-28 flex items-center gap-1 cursor-help">
                            Goal Reward
                        </label>
                        <input type="number" id="rewardGoal" value="0" class="flex-1 text-green-400 text-right">
                    </div>
                </div>

                <!-- Wall Penalty -->
                <div class="group param-row" data-info="The penalty (pain) for crashing into a wall. Negative values (e.g., -100) teach safety.">
                    <div class="flex items-center gap-2 mb-1">
                        <label class="text-xs font-bold text-slate-400 w-28 flex items-center gap-1 cursor-help">
                            Wall Penalty
                        </label>
                        <input type="number" id="rewardWall" value="0" class="flex-1 text-slate-400 text-right">
                    </div>
                </div>

                <!-- Step Cost -->
                <div class="group param-row" data-info="The cost of time. A small penalty per step (e.g., -1) makes the robot hurry up.">
                    <div class="flex items-center gap-2 mb-1">
                        <label class="text-xs font-bold text-yellow-400 w-28 flex items-center gap-1 cursor-help">
                            Step Cost
                        </label>
                        <input type="number" id="rewardStep" value="0" class="flex-1 text-yellow-400 text-right">
                    </div>
                </div>

                <!-- Button Bonus -->
                 <div class="group param-row" data-info="Reward for activating sub-goals. High values make the robot detour for buttons.">
                    <div class="flex items-center gap-2 mb-1">
                        <label class="text-xs font-bold text-purple-400 w-28 flex items-center gap-1 cursor-help">
                            Button Bonus
                        </label>
                        <input type="number" id="rewardButton" value="0" class="flex-1 text-purple-400 text-right">
                    </div>
                </div>

                <!-- Hazard Penalty -->
                 <div class="group param-row" data-info="Penalty for Lava. Needs to be extremely high (e.g., -500) to ensure survival.">
                    <div class="flex items-center gap-2 mb-1">
                        <label class="text-xs font-bold text-orange-500 w-28 flex items-center gap-1 cursor-help">
                            Hazard Cost
                        </label>
                        <input type="number" id="rewardHazard" value="0" class="flex-1 text-orange-500 text-right">
                    </div>
                </div>
            </div>
            
            <!-- Static Info Box -->
            <div id="paramInfoBox" class="mt-3 bg-slate-900/80 p-2 rounded border border-slate-600 text-[10px] text-slate-300 min-h-[40px] flex items-center">
                <i class="fas fa-info-circle mr-2 text-blue-400"></i> <span id="paramInfoText">Hover over a parameter to learn what it does.</span>
            </div>
            
            <div class="mt-2 pt-2 border-t border-slate-700">
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input type="checkbox" id="toggleView" class="w-4 h-4 rounded border-slate-600 text-blue-500 focus:ring-blue-500 bg-slate-700" checked>
                    <span class="text-xs text-slate-300 group-hover:text-white transition-colors">Visualize "Brain" (Heatmap)</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Main Display -->
    <div class="flex-1 bg-slate-950 flex flex-col relative overflow-hidden h-full">
        <!-- Floating Header -->
        <div class="absolute top-4 left-4 right-4 flex justify-between items-start pointer-events-none z-10 flex-wrap gap-2">
             <div class="flex gap-4 text-xs font-bold text-slate-400 bg-slate-900/80 p-2 rounded-full backdrop-blur border border-slate-700 shadow-xl overflow-x-auto max-w-full">
                <span class="flex items-center gap-2 whitespace-nowrap"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Agent</span>
                <span class="flex items-center gap-2 whitespace-nowrap"><div class="w-2 h-2 rounded-full bg-yellow-400"></div> Goal</span>
                <span class="flex items-center gap-2 whitespace-nowrap"><div class="w-2 h-2 rounded-full bg-purple-500"></div> Button</span>
                <span class="flex items-center gap-2 whitespace-nowrap"><div class="w-2 h-2 rounded-sm bg-slate-600"></div> Wall</span>
                <span class="flex items-center gap-2 whitespace-nowrap"><div class="w-2 h-2 rounded-sm bg-orange-600"></div> Lava</span>
            </div>
            
            <!-- Quick Stats -->
            <div class="flex gap-4 text-xs font-bold bg-slate-900/80 p-2 rounded-full backdrop-blur border border-slate-700 shadow-xl">
                <div class="flex flex-col items-center leading-none px-2 border-r border-slate-700">
                    <span class="text-[9px] text-slate-500">SCORE</span>
                    <span id="currentScore" class="text-white">0</span>
                </div>
                <div class="flex flex-col items-center leading-none px-2 border-r border-slate-700">
                    <span class="text-[9px] text-slate-500">EPISODE</span>
                    <span id="episodeCount" class="text-white">0</span>
                </div>
                <div class="flex flex-col items-center leading-none px-2">
                    <span class="text-[9px] text-slate-500">WINS</span>
                    <span id="winCount" class="text-blue-400">0</span>
                </div>
            </div>
        </div>

        <div class="flex-1 flex items-center justify-center p-4 overflow-auto">
             <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#38bdf8 1px, transparent 1px); background-size: 30px 30px;"></div>
             <div class="canvas-container relative mx-auto">
                <canvas id="gameCanvas" width="800" height="600" class="bg-slate-900 shadow-2xl border border-slate-800"></canvas>
                <div id="notification" class="absolute top-4 left-1/2 -translate-x-1/2 bg-slate-800/90 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg opacity-0 transition-opacity pointer-events-none border border-slate-600 whitespace-nowrap z-20">Training Started</div>
             </div>
        </div>

        <!-- Chart Footer -->
        <div class="h-32 bg-slate-900 border-t border-slate-800 p-2 flex gap-4 shrink-0">
             <div class="w-64 flex flex-col justify-center px-4 border-r border-slate-800 hidden lg:flex">
                 <h3 class="text-xs font-bold text-slate-400 mb-1">Performance Graph</h3>
                 <p class="text-[10px] text-slate-500">Visualizes the total reward per episode. Upward trend = Learning.</p>
                 <div class="mt-2 text-[10px] text-slate-500">
                     <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span>Best: <span id="bestReward" class="text-green-400 font-mono">0</span>
                 </div>
             </div>
             <div class="flex-1 relative">
                 <canvas id="chartCanvas" class="w-full h-full"></canvas>
             </div>
        </div>
    </div>

    <script>
        /**
         * ROBO-ACADEMY
         * Educational Q-Learning + Challenge System
         */

        // --- Configuration & State ---
        let CONFIG = {
            gridSize: 40, cols: 5, rows: 5,     
            colors: { bg: '#0f172a', wall: '#334155', agent: '#38bdf8', goal: '#facc15', goalInactive: '#475569', button: '#a855f7', hazard: '#ea580c', grid: '#1e293b', path: 'rgba(255, 255, 255, 0.3)' },
            rewards: { goal: 0, button: 0, wall: 0, step: 0, hazard: 0 } // ALL 0 START
        };

        const state = {
            mode: 'sandbox', 
            activeChallengeIndex: null,
            running: false,
            autoTrain: false, 
            speedValue: 50, 
            showBrain: true,
            episode: 0,
            wins: 0,
            bestReward: -Infinity,
            history: [],
            tool: 'wall',
            isDrawing: false,
            frameCount: 0,
            needsReset: false,
            path: [],
            consecutiveWins: 0
        };

        // --- Elements ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const chartCanvas = document.getElementById('chartCanvas');
        const chartCtx = chartCanvas.getContext('2d');
        const scoreEl = document.getElementById('currentScore');

        // --- Info Box Logic ---
        document.querySelectorAll('.param-row').forEach(row => {
            row.addEventListener('mouseenter', () => {
                const text = row.getAttribute('data-info');
                document.getElementById('paramInfoText').innerText = text;
            });
            row.addEventListener('mouseleave', () => {
                document.getElementById('paramInfoText').innerText = "Hover over a parameter to learn what it does.";
            });
        });

        // --- Challenge Manager ---
        const challenges = [
            {
                title: "1. The Lazy Robot",
                desc: "The robot has zero motivation. Fix its logic.",
                objective: "Win in < 10 steps (3 times in a row).",
                map: (env) => {
                    env.resize(5, 5);
                    env.spawnPos = {x:0, y:0};
                    env.goalPos = {x:4, y:4};
                },
                setupParams: { goal: 0, wall: 0, step: 0, button: 0, hazard: 0 }, 
                checkWin: (lastSteps, lastWin) => (lastWin && lastSteps < 10),
                advisor: "Everything is zero! Set 'Goal Reward' to 100 and 'Step Cost' to -5."
            },
            {
                title: "2. The Hazardous Path",
                desc: "Navigate the corridor without crashing.",
                objective: "Win 5 times consecutively without crashing.",
                map: (env) => {
                    env.resize(7, 5);
                    env.spawnPos = {x:0, y:2};
                    env.goalPos = {x:6, y:2};
                    for(let x=1; x<6; x++) { env.grid[1][x] = 1; env.grid[3][x] = 1; }
                },
                setupParams: { goal: 0, wall: 0, step: 0, button: 0, hazard: 0 }, 
                checkWin: (lastSteps, lastWin) => lastWin,
                advisor: "It hits walls because 'Wall Penalty' is 0. Set 'Wall Penalty' to -200!"
            },
            {
                title: "3. The Key Master",
                desc: "The goal is locked. Find the key (button).",
                objective: "Activate button & Win (3 times in a row).",
                map: (env) => {
                    env.resize(6, 6);
                    env.spawnPos = {x:0, y:0};
                    env.goalPos = {x:5, y:0};
                    env.buttonPos = {x:0, y:5}; 
                    env.grid[0][4] = 1; env.grid[1][4] = 1;
                },
                setupParams: { goal: 0, wall: 0, step: 0, button: 0, hazard: 0 }, 
                checkWin: (lastSteps, lastWin, activated) => (lastWin && activated),
                advisor: "Set 'Button Bonus' to 50 so it knows the button is valuable."
            },
            {
                title: "4. The Maze Runner",
                desc: "Efficiency is key in this maze.",
                objective: "Reach goal in < 30 steps (2 times in a row).",
                map: (env) => {
                    env.resize(9, 7);
                    env.spawnPos = {x:0, y:0};
                    env.goalPos = {x:8, y:6};
                    for(let y=0; y<6; y++) env.grid[y][1] = 1; 
                    for(let y=1; y<7; y++) env.grid[y][3] = 1; 
                    for(let y=0; y<6; y++) env.grid[y][5] = 1; 
                    for(let y=1; y<7; y++) env.grid[y][7] = 1; 
                },
                setupParams: { goal: 0, wall: 0, step: 0, button: 0, hazard: 0 },
                checkWin: (lastSteps, lastWin) => (lastWin && lastSteps < 30),
                advisor: "Set 'Step Cost' to -2 so it stops wandering aimlessly."
            },
            {
                title: "5. The Minefield",
                desc: "Dense obstacles. Requires extreme caution.",
                objective: "Win 3 times consecutively.",
                map: (env) => {
                    env.resize(10, 8);
                    env.spawnPos = {x:0, y:0};
                    env.goalPos = {x:9, y:7};
                    const obstacles = [[1,1], [1,3], [1,5], [1,7], [3,0], [3,2], [3,4], [3,6], [5,1], [5,3], [5,5], [5,7], [7,0], [7,2], [7,4], [7,6], [8,3], [2,5], [6,2], [4,4]];
                    obstacles.forEach(p => { if(p[0]<10 && p[1]<8) env.grid[p[1]][p[0]] = 1; });
                },
                setupParams: { goal: 0, wall: 0, step: 0, button: 0, hazard: 0 },
                checkWin: (lastSteps, lastWin) => lastWin,
                advisor: "Set 'Wall Penalty' to -500 and 'Goal Reward' to 200."
            },
            {
                title: "6. The Floor is Lava",
                desc: "Orange tiles kill you instantly.",
                objective: "Win 5 times consecutively.",
                map: (env) => {
                    env.resize(8, 6);
                    env.spawnPos = {x:0, y:3};
                    env.goalPos = {x:7, y:3};
                    // Ensure solvable: Create a safe "snake" path
                    // Lava Top
                    for(let x=1; x<8; x++) env.grid[1][x] = 2; 
                    // Lava Bottom
                    for(let x=0; x<7; x++) env.grid[5][x] = 2; 
                    
                    // Specific blocks to force winding
                    env.grid[3][3] = 2; // Block straight path
                    
                    // Fill surrounding with lava for effect
                    env.grid[2][2] = 2; 
                    env.grid[2][4] = 2;
                    env.grid[4][2] = 2;
                    env.grid[4][4] = 2;
                    
                    // Clear a specific path: (0,3)->(1,3)->(2,3)->(2,4)->(3,4)->(4,4)->(5,4)->(5,3)->(6,3)->(7,3)
                    // Wait, let's just make it simpler but tight
                    // Reset grid to clear
                    for(let y=0; y<6; y++) for(let x=0; x<8; x++) env.grid[y][x] = 0;
                    
                    // Draw Lava Tunnel
                    for(let x=0; x<8; x++) { env.grid[2][x] = 2; env.grid[4][x] = 2; }
                    env.grid[2][0] = 0; env.grid[4][7] = 0; // Entrances/Exits just in case
                    
                    // The path is row 3. Block it at x=3
                    env.grid[3][3] = 2;
                    
                    // Open a detour: go up at x=2, over to x=4, down to x=4
                    env.grid[2][2] = 0; 
                    env.grid[2][3] = 0;
                    env.grid[2][4] = 0;
                    
                    // Just to be safe, clear start/goal
                    env.grid[3][0] = 0; env.grid[3][7] = 0;
                },
                setupParams: { goal: 0, wall: 0, step: 0, button: 0, hazard: 0 },
                checkWin: (lastSteps, lastWin) => lastWin,
                advisor: "Lava (Hazards) are distinct from walls. You must set 'Hazard Cost' to a HUGE negative (e.g., -1000) to survive."
            },
             {
                title: "7. The Long Haul",
                desc: "A massive map. Patience vs Efficiency.",
                objective: "Win once.",
                map: (env) => {
                    env.resize(15, 10);
                    env.spawnPos = {x:0, y:0};
                    env.goalPos = {x:14, y:9};
                    // Random walls
                    for(let i=0; i<40; i++) {
                        let rx = Math.floor(Math.random()*15);
                        let ry = Math.floor(Math.random()*10);
                        if((rx!==0 || ry!==0) && (rx!==14 || ry!==9)) env.grid[ry][rx] = 1;
                    }
                },
                setupParams: { goal: 0, wall: 0, step: 0, button: 0, hazard: 0 },
                checkWin: (lastSteps, lastWin) => lastWin,
                advisor: "For large maps, you need a balance. Goal=200, Step Cost=-1."
            }
        ];

        function initChallenges() {
            const list = document.getElementById('challengeList');
            list.innerHTML = '';
            challenges.forEach((c, i) => {
                const div = document.createElement('div');
                div.className = "challenge-card bg-slate-800 p-3 rounded cursor-pointer border-l-4 border-l-transparent";
                div.innerHTML = `
                    <div class="font-bold text-sm text-slate-200">${c.title}</div>
                    <div class="text-[10px] text-slate-400 mt-1">${c.desc}</div>
                `;
                div.onclick = () => loadChallenge(i);
                list.appendChild(div);
            });
        }

        function loadChallenge(index) {
            state.activeChallengeIndex = index;
            state.consecutiveWins = 0;
            const c = challenges[index];
            
            document.querySelectorAll('.challenge-card').forEach((el, i) => {
                if(i === index) {
                    el.classList.add('challenge-active', 'border-l-emerald-500');
                    el.classList.remove('border-l-transparent');
                } else {
                    el.classList.remove('challenge-active', 'border-l-emerald-500');
                    el.classList.add('border-l-transparent');
                }
            });

            document.getElementById('activeChallengeBox').classList.remove('hidden');
            document.getElementById('challengeObjective').innerText = c.objective;
            document.getElementById('challengeAdvisor').innerText = c.advisor;
            document.getElementById('challengeProgress').style.width = '0%';
            document.getElementById('challengeProgressText').innerText = "0 Streak";
            showNotification(`Loaded: ${c.title}`);

            // Lock Sandbox
            env.resetMap();
            c.map(env);
            
            // Set parameters to 0
            document.getElementById('rewardGoal').value = c.setupParams.goal;
            document.getElementById('rewardWall').value = c.setupParams.wall;
            document.getElementById('rewardStep').value = c.setupParams.step;
            document.getElementById('rewardButton').value = c.setupParams.button;
            document.getElementById('rewardHazard').value = c.setupParams.hazard;
            
            document.getElementById('btnReset').click();
        }

        function updateChallengeProgress(lastSteps, lastWin, activated) {
            if (state.mode !== 'challenge' || state.activeChallengeIndex === null) return;
            
            const c = challenges[state.activeChallengeIndex];
            const success = c.checkWin(lastSteps, lastWin, activated);

            if (success) {
                state.consecutiveWins++;
                showNotification(`Streak: ${state.consecutiveWins}`, "text-green-400");
                
                let targetWins = 3; 
                if(state.activeChallengeIndex === 1 || state.activeChallengeIndex === 5) targetWins = 5;
                if(state.activeChallengeIndex === 3) targetWins = 2;
                if(state.activeChallengeIndex === 6) targetWins = 1;
                
                let pct = Math.min((state.consecutiveWins / targetWins) * 100, 100);
                document.getElementById('challengeProgress').style.width = `${pct}%`;
                document.getElementById('challengeProgressText').innerText = `${state.consecutiveWins}/${targetWins} Streak`;
                
                document.getElementById('challengeAdvisor').innerText = "Good job! Keep it consistent.";
                document.getElementById('challengeAdvisor').className = "text-green-400 font-bold";

                if (state.consecutiveWins >= targetWins) {
                    showNotification("CHALLENGE COMPLETE!", "text-yellow-400");
                    document.getElementById('challengeAdvisor').innerText = "CHALLENGE COMPLETE! Select a new one.";
                    confettiEffect();
                    state.running = false;
                }
            } else {
                state.consecutiveWins = 0;
                document.getElementById('challengeProgress').style.width = '0%';
                document.getElementById('challengeProgressText').innerText = "Streak Reset";
                document.getElementById('challengeAdvisor').innerText = "Failed condition. " + c.advisor;
                document.getElementById('challengeAdvisor').className = "text-slate-300";
            }
        }
        
        // --- Environment ---
        class Environment {
            constructor() {
                this.resize(CONFIG.cols, CONFIG.rows);
            }
            resize(cols, rows) {
                this.width = cols; this.height = rows;
                const maxW = 800; const maxH = 600;
                const sizeX = maxW / cols; const sizeY = maxH / rows;
                CONFIG.gridSize = Math.floor(Math.min(sizeX, sizeY));
                canvas.width = maxW; canvas.height = maxH;
                this.offsetX = (maxW - (cols * CONFIG.gridSize)) / 2;
                this.offsetY = (maxH - (rows * CONFIG.gridSize)) / 2;
                this.resetMap();
            }
            resetMap() {
                this.grid = Array(this.height).fill().map(() => Array(this.width).fill(0));
                this.spawnPos = { x: 0, y: 0 };
                this.goalPos = { x: this.width - 1, y: this.height - 1 };
                this.buttonPos = null;
                this.resetEpisode();
            }
            resetEpisode() {
                this.agentPos = { ...this.spawnPos };
                
                this.goalActive = (this.buttonPos === null); 
                state.path = [{x:this.agentPos.x, y:this.agentPos.y}];
                this.steps = 0;
                this.activatedButtonThisRun = false;
            }
            toGrid(px, py) {
                return { x: Math.floor((px - this.offsetX) / CONFIG.gridSize), y: Math.floor((py - this.offsetY) / CONFIG.gridSize) };
            }
            handleMapClick(x, y) {
                if (state.mode === 'challenge') {
                    showNotification("Map Locked in Challenge Mode", "text-red-400");
                    return;
                }
                if (x < 0 || x >= this.width || y < 0 || y >= this.height) return;
                
                if (state.tool === 'spawn') { 
                    this.grid[y][x] = 0;
                    this.spawnPos = { x, y };
                    this.agentPos = { x, y }; 
                }
                else if (state.tool === 'goal') { 
                    this.goalPos = { x, y }; this.grid[y][x] = 0; 
                    if (this.buttonPos && this.buttonPos.x === x && this.buttonPos.y === y) this.buttonPos = null; 
                } 
                else if (state.tool === 'button') { 
                    if (this.buttonPos && this.buttonPos.x === x && this.buttonPos.y === y) this.buttonPos = null; 
                    else { this.buttonPos = { x, y }; this.grid[y][x] = 0; } 
                } 
                else if (state.tool === 'wall') { 
                    if ((this.goalPos.x === x && this.goalPos.y === y) || (this.buttonPos && this.buttonPos.x === x && this.buttonPos.y === y) || (this.spawnPos.x === x && this.spawnPos.y === y)) return; 
                    this.grid[y][x] = 1; 
                }
                else if (state.tool === 'hazard') { 
                     if ((this.goalPos.x === x && this.goalPos.y === y) || (this.buttonPos && this.buttonPos.x === x && this.buttonPos.y === y) || (this.spawnPos.x === x && this.spawnPos.y === y)) return; 
                    this.grid[y][x] = 2; 
                }
                else if (state.tool === 'eraser') { 
                    this.grid[y][x] = 0; 
                    if (this.buttonPos && this.buttonPos.x === x && this.buttonPos.y === y) this.buttonPos = null; 
                }
            }
            getState() { return `${this.agentPos.x},${this.agentPos.y},${this.goalActive ? 1 : 0}`; }
            step(action) {
                this.steps++;
                let nx = this.agentPos.x; let ny = this.agentPos.y;
                if (action === 0) ny--; if (action === 1) nx++; if (action === 2) ny++; if (action === 3) nx--;
                
                // Boundary
                if (nx < 0 || nx >= this.width || ny < 0 || ny >= this.height) return { reward: CONFIG.rewards.wall, done: true, won: false, nextState: this.getState() };
                
                // Wall
                if (this.grid[ny][nx] === 1) return { reward: CONFIG.rewards.wall, done: true, won: false, nextState: this.getState() };
                
                // Hazard (Lava)
                if (this.grid[ny][nx] === 2) return { reward: CONFIG.rewards.hazard, done: true, won: false, nextState: this.getState() };

                // Valid Move
                this.agentPos = { x: nx, y: ny };
                state.path.push({x: nx, y: ny});
                
                let r = CONFIG.rewards.step;
                
                // Button
                if (this.buttonPos && nx === this.buttonPos.x && ny === this.buttonPos.y) {
                    if (!this.goalActive) { this.goalActive = true; this.activatedButtonThisRun = true; r += CONFIG.rewards.button; showNotification("Activated!", "text-purple-400"); }
                }
                
                const newState = this.getState();
                
                // Goal
                if (nx === this.goalPos.x && ny === this.goalPos.y) {
                    if (this.goalActive) return { reward: CONFIG.rewards.goal, done: true, won: true, nextState: newState };
                }
                return { reward: r, done: false, won: false, nextState: newState };
            }
        }

        // --- Agent ---
        class Agent {
            constructor() { this.resetBrain(); }
            getQ(state) { if (!this.qTable[state]) this.qTable[state] = [0, 0, 0, 0]; return this.qTable[state]; }
            getAction(state) {
                if (Math.random() < this.epsilon) return Math.floor(Math.random() * 4);
                const qs = this.getQ(state);
                let maxQ = Math.max(...qs);
                let indices = qs.map((q, i) => q === maxQ ? i : -1).filter(i => i !== -1);
                return indices[Math.floor(Math.random() * indices.length)];
            }
            learn(state, action, reward, nextState) {
                const currentQ = this.getQ(state)[action];
                const nextQs = this.getQ(nextState);
                const maxNextQ = Math.max(...nextQs);
                this.qTable[state][action] = currentQ + this.learningRate * (reward + this.discountFactor * maxNextQ - currentQ);
            }
            decayEpsilon() { if (this.epsilon > this.epsilonMin) this.epsilon *= this.epsilonDecay; }
            resetBrain() { this.qTable = {}; this.epsilon = 0.9; this.learningRate = 0.5; this.discountFactor = 0.9; this.epsilonDecay = 0.99; this.epsilonMin = 0.01; }
        }

        // --- Core ---
        const env = new Environment();
        const agent = new Agent();
        let currentEpisodeReward = 0;

        function runStep() {
            if (state.needsReset) return;
            const currentState = env.getState();
            const action = agent.getAction(currentState);
            const { reward, done, nextState, won } = env.step(action);
            agent.learn(currentState, action, reward, nextState);
            currentEpisodeReward += reward;
            scoreEl.innerText = currentEpisodeReward;
            scoreEl.className = currentEpisodeReward > 0 ? 'text-white text-green-400' : currentEpisodeReward < -50 ? 'text-white text-red-400' : "text-white";
            if (done) finishEpisode(reward, won);
        }

        function finishEpisode(finalReward, won) {
            state.episode++;
            state.history.push(currentEpisodeReward);
            if (state.history.length > 50) state.history.shift();
            
            if (won) { state.wins++; showNotification("Goal Reached!", "text-green-400"); } 
            else showNotification("Failed!", "text-red-400");
            
            if (currentEpisodeReward > state.bestReward) state.bestReward = currentEpisodeReward;
            agent.decayEpsilon();
            
            // CHALLENGE CHECK
            updateChallengeProgress(env.steps, won, env.activatedButtonThisRun);

            updateStats();
            drawChart();
            
            if (state.autoTrain) {
                env.resetEpisode();
                currentEpisodeReward = 0;
            } else {
                state.needsReset = true;
                state.running = false;
                document.getElementById('btnNextEp').classList.remove('hidden');
                updateTrainBtnState();
            }
        }

        // --- Drawing ---
        function draw() {
            ctx.fillStyle = CONFIG.colors.bg; ctx.fillRect(0, 0, canvas.width, canvas.height);
            for (let y = 0; y < env.height; y++) {
                for (let x = 0; x < env.width; x++) {
                    const isActiveFlag = env.goalActive ? 1 : 0;
                    const stateKey = `${x},${y},${isActiveFlag}`;
                    
                    // Walls
                    if (env.grid[y][x] === 1) {
                        drawRect(x, y, CONFIG.colors.wall);
                        ctx.fillStyle = '#475569';
                        const p = getRect(x, y);
                        ctx.fillRect(p.x + 4, p.y + 4, p.w - 8, p.h - 8);
                        continue;
                    }
                    
                    // Hazards
                    if (env.grid[y][x] === 2) {
                        drawRect(x, y, CONFIG.colors.hazard);
                        ctx.fillStyle = '#c2410c';
                        const p = getRect(x, y);
                        ctx.fillRect(p.x + 4, p.y + 4, p.w - 8, p.h - 8);
                        continue;
                    }

                    if (state.showBrain && agent.qTable[stateKey]) {
                        const qs = agent.qTable[stateKey];
                        const maxQ = Math.max(...qs);
                        const avgQ = qs.reduce((a, b) => a + b, 0) / 4;
                        const p = getRect(x, y);
                        if (maxQ > 0) { ctx.fillStyle = `rgba(52, 211, 153, ${Math.min(maxQ / 100, 0.8)})`; ctx.fillRect(p.x, p.y, p.w, p.h); } 
                        else if (avgQ < -5) { ctx.fillStyle = `rgba(239, 68, 68, ${Math.min(Math.abs(avgQ) / 100, 0.7)})`; ctx.fillRect(p.x, p.y, p.w, p.h); }
                    }
                    
                    const p = getRect(x, y);
                    ctx.strokeStyle = CONFIG.colors.grid; ctx.lineWidth = 1; ctx.strokeRect(p.x, p.y, p.w, p.h);
                }
            }
            if (env.buttonPos) {
                const p = getRect(env.buttonPos.x, env.buttonPos.y);
                const cx = p.x + p.w/2; const cy = p.y + p.h/2;
                ctx.fillStyle = CONFIG.colors.button; ctx.beginPath(); ctx.arc(cx, cy, p.w/4, 0, Math.PI * 2); ctx.fill(); ctx.shadowColor = CONFIG.colors.button; ctx.shadowBlur = 10; ctx.stroke(); ctx.shadowBlur = 0;
            }
            const pGoal = getRect(env.goalPos.x, env.goalPos.y);
            const gx = pGoal.x + pGoal.w/2; const gy = pGoal.y + pGoal.h/2;
            ctx.fillStyle = env.goalActive ? CONFIG.colors.goal : CONFIG.colors.goalInactive; ctx.beginPath(); ctx.arc(gx, gy, pGoal.w/3, 0, Math.PI * 2); ctx.fill(); 
            if (env.goalActive) { ctx.shadowColor = CONFIG.colors.goal; ctx.shadowBlur = 15; } ctx.stroke(); ctx.shadowBlur = 0;
            if (state.path.length > 1) {
                ctx.beginPath(); ctx.strokeStyle = CONFIG.colors.path; ctx.lineWidth = 4; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                state.path.forEach((pos, i) => { 
                    const p = getRect(pos.x, pos.y);
                    const px = p.x + p.w/2; const py = p.y + p.h/2; 
                    if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py); 
                }); ctx.stroke();
            }
            const pAgent = getRect(env.agentPos.x, env.agentPos.y);
            const ax = pAgent.x + pAgent.w/2; const ay = pAgent.y + pAgent.h/2;
            ctx.fillStyle = CONFIG.colors.agent; ctx.beginPath(); ctx.arc(ax, ay, pAgent.w/2.5, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(ax - 5, ay - 2, 3, 0, Math.PI * 2); ctx.arc(ax + 5, ay - 2, 3, 0, Math.PI * 2); ctx.fill();
        }
        
        function getRect(gridX, gridY) {
            const size = CONFIG.gridSize;
            return {
                x: env.offsetX + gridX * size,
                y: env.offsetY + gridY * size,
                w: size, h: size
            };
        }

        function drawRect(gridX, gridY, color, fill = true) {
            const p = getRect(gridX, gridY);
            if (fill) { ctx.fillStyle = color; ctx.fillRect(p.x, p.y, p.w, p.h); } 
            else { ctx.strokeStyle = color; ctx.strokeRect(p.x, p.y, p.w, p.h); }
        }

        // --- Helpers ---
        function updateStats() { document.getElementById('episodeCount').innerText = state.episode; document.getElementById('bestReward').innerText = state.bestReward === -Infinity ? 0 : state.bestReward; document.getElementById('winCount').innerText = state.wins; }
        function showNotification(msg, colorClass = "text-white") { const notif = document.getElementById('notification'); notif.innerText = msg; notif.className = `absolute top-4 left-1/2 -translate-x-1/2 bg-slate-800/90 px-4 py-2 rounded-full text-sm font-bold shadow-lg transition-opacity pointer-events-none border border-slate-600 whitespace-nowrap z-20 ${colorClass}`; notif.style.opacity = '1'; setTimeout(() => notif.style.opacity = '0', 2000); }
        function startNextEpisode() { state.needsReset = false; env.resetEpisode(); currentEpisodeReward = 0; scoreEl.innerText = "0"; document.getElementById('btnNextEp').classList.add('hidden'); state.running = true; updateTrainBtnState(); }
        function updateTrainBtnState() {
            const btn = document.getElementById('btnTrain');
            if (state.needsReset) { btn.innerHTML = '<i class="fas fa-play"></i> Resume'; btn.className = 'bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-500/20 transition-all active:scale-95 flex items-center justify-center gap-2'; }
            else if (state.running) { btn.innerHTML = '<i class="fas fa-pause"></i> Pause'; btn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-yellow-500/20 transition-all active:scale-95 flex items-center justify-center gap-2'; }
            else { btn.innerHTML = '<i class="fas fa-play"></i> Train AI'; btn.className = 'bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-emerald-500/20 transition-all active:scale-95 flex items-center justify-center gap-2'; }
        }
        function setMode(mode) {
            state.mode = mode;
            document.getElementById('btnModeSandbox').className = mode === 'sandbox' ? "px-3 py-1 rounded text-xs font-bold bg-slate-600 text-white shadow transition-colors" : "px-3 py-1 rounded text-xs font-bold text-slate-400 hover:text-white transition-colors";
            document.getElementById('btnModeChallenge').className = mode === 'challenge' ? "px-3 py-1 rounded text-xs font-bold bg-emerald-600 text-white shadow transition-colors" : "px-3 py-1 rounded text-xs font-bold text-slate-400 hover:text-white transition-colors";
            if (mode === 'challenge') {
                document.getElementById('challengeSection').classList.remove('hidden');
                document.getElementById('sandboxSection').classList.add('hidden');
                initChallenges();
            } else {
                document.getElementById('challengeSection').classList.add('hidden');
                document.getElementById('sandboxSection').classList.remove('hidden');
                state.activeChallengeIndex = null;
            }
        }
        function drawChart() {
            const w = chartCanvas.width = chartCanvas.clientWidth; const h = chartCanvas.height = chartCanvas.clientHeight;
            chartCtx.clearRect(0, 0, w, h); if (state.history.length < 2) return;
            chartCtx.strokeStyle = '#38bdf8'; chartCtx.lineWidth = 2; chartCtx.beginPath();
            const maxVal = Math.max(100, ...state.history); const minVal = Math.min(-200, ...state.history); const range = maxVal - minVal || 1;
            state.history.forEach((val, i) => { const x = (i / (state.history.length - 1)) * w; const y = h - ((val - minVal) / range) * h; if (i === 0) chartCtx.moveTo(x, y); else chartCtx.lineTo(x, y); }); chartCtx.stroke();
        }
        function confettiEffect() {
            for(let i=0; i<50; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.style.position = 'absolute';
                    el.style.left = '50%';
                    el.style.top = '50%';
                    el.style.width = '10px'; el.style.height = '10px';
                    el.style.backgroundColor = ['#facc15', '#38bdf8', '#a855f7', '#10b981'][Math.floor(Math.random()*4)];
                    el.style.transform = `translate(${Math.random()*400-200}px, ${Math.random()*400-200}px)`;
                    el.style.transition = 'all 1s ease-out';
                    el.style.opacity = '0';
                    document.body.appendChild(el);
                    setTimeout(() => document.body.removeChild(el), 1000);
                    requestAnimationFrame(() => el.style.opacity = '1');
                }, i*20);
            }
        }

        // --- Init Listeners ---
        document.getElementById('btnTrain').addEventListener('click', () => { if (state.needsReset) startNextEpisode(); else { state.running = !state.running; updateTrainBtnState(); } });
        document.getElementById('btnNextEp').addEventListener('click', startNextEpisode);
        document.getElementById('btnReset').addEventListener('click', () => {
            state.running = false; state.needsReset = false; state.episode = 0; state.wins = 0; state.bestReward = -Infinity; state.history = []; scoreEl.innerText = "0"; document.getElementById('btnNextEp').classList.add('hidden'); updateTrainBtnState();
            CONFIG.rewards.goal = parseInt(document.getElementById('rewardGoal').value); CONFIG.rewards.button = parseInt(document.getElementById('rewardButton').value); CONFIG.rewards.wall = parseInt(document.getElementById('rewardWall').value); CONFIG.rewards.step = parseInt(document.getElementById('rewardStep').value); 
            CONFIG.rewards.hazard = parseInt(document.getElementById('rewardHazard').value);
            // Don't reset map layout if challenge active, just agent
            if(state.mode !== 'challenge') env.resetMap(); else env.resetEpisode(); 
            agent.resetBrain(); updateStats(); drawChart(); showNotification("Reset");
        });
        document.getElementById('autoTrainToggle').addEventListener('change', (e) => state.autoTrain = e.target.checked);
        document.getElementById('speedSlider').addEventListener('input', (e) => { state.speedValue = parseInt(e.target.value); document.getElementById('speedLabel').innerText = state.speedValue <= 40 ? "Slow-Mo" : state.speedValue <= 60 ? "Normal" : "Hyper"; });
        document.getElementById('btnApplyGrid').addEventListener('click', () => { const c = parseInt(document.getElementById('gridCols').value); const r = parseInt(document.getElementById('gridRows').value); CONFIG.cols = c; CONFIG.rows = r; document.getElementById('btnReset').click(); env.resize(c, r); });
        
        // Tool buttons logic restored
        document.querySelectorAll('.tool-btn').forEach(btn => btn.addEventListener('click', (e) => { 
            state.tool = e.currentTarget.dataset.tool;
            document.querySelectorAll('.tool-btn').forEach(b => {
                b.classList.remove('active', 'bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-slate-900');
                b.classList.add('bg-slate-700', 'text-slate-300');
            });
            e.currentTarget.classList.remove('bg-slate-700', 'text-slate-300');
            e.currentTarget.classList.add('active', 'bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400', 'ring-offset-2', 'ring-offset-slate-900');
        }));
        
        canvas.addEventListener('mousedown', (e) => { state.isDrawing = true; handleInput(e); });
        window.addEventListener('mouseup', () => state.isDrawing = false);
        canvas.addEventListener('mousemove', (e) => { if (state.isDrawing) handleInput(e); });
        
        // Touch events
        canvas.addEventListener('touchstart', (e) => { 
            e.preventDefault(); // Stop scrolling
            state.isDrawing = true; handleInput(e); 
        }, {passive: false});
        canvas.addEventListener('touchmove', (e) => { 
            e.preventDefault(); 
            if (state.isDrawing) handleInput(e); 
        }, {passive: false});

        function handleInput(e) { 
            const rect = canvas.getBoundingClientRect(); 
            const scaleX = canvas.width / rect.width; // Relationship bitmap vs DOM width
            const scaleY = canvas.height / rect.height;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const x = (clientX - rect.left) * scaleX; 
            const y = (clientY - rect.top) * scaleY; 
            
            const gp = env.toGrid(x, y); 
            env.handleMapClick(gp.x, gp.y); 
        }

        function gameLoop() {
            if (state.running) {
                let steps = 0;
                if (state.speedValue <= 40) { state.frameCount++; if (state.frameCount % Math.floor(41 - state.speedValue) === 0) steps = 1; }
                else if (state.speedValue <= 60) steps = 1;
                else steps = Math.floor((state.speedValue - 60) * 2) + 1;
                for (let i = 0; i < steps; i++) if (state.running) runStep();
            }
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // Start
        env.resize(CONFIG.cols, CONFIG.rows);
        initChallenges();
        gameLoop();
    </script>
</body>
</html>
