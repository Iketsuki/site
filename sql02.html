<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Mastery: Interactive Practice</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- AlaSQL for client-side SQL execution -->
    <script src="https://cdn.jsdelivr.net/npm/alasql@4.4.0/dist/alasql.min.js"></script>
    <!-- CodeMirror for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .CodeMirror {
            height: 150px;
            border-radius: 0.5rem;
            font-size: 14px;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col font-sans text-slate-800">

    <!-- Header -->
    <header class="bg-slate-800 text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-database text-yellow-400 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-wide">SQL Mastery <span class="text-slate-400 text-sm font-normal ml-2">Interactive Practice</span></h1>
        </div>
        <div class="text-sm text-slate-400">
            <span id="progress-text">0/30 Completed</span>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Levels -->
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col shrink-0 overflow-hidden">
            <div class="p-4 bg-slate-50 border-b border-slate-200">
                <h2 class="font-bold text-slate-700">Practice Levels</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-2" id="level-list">
                <!-- Levels will be injected here -->
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
            
            <!-- Question Area -->
            <div class="p-6 bg-white border-b border-slate-200 shrink-0">
                <div class="flex justify-between items-start mb-2">
                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded" id="current-table-badge">CITY Table</span>
                    <button onclick="toggleSchema()" class="text-xs text-slate-500 hover:text-blue-600 underline">
                        <i class="fa-solid fa-table"></i> View Schema
                    </button>
                </div>
                <h2 id="question-text" class="text-lg font-medium text-slate-800 mb-2">Select a level to begin...</h2>
            </div>

            <!-- Editor Area -->
            <div class="p-6 flex flex-col gap-4 shrink-0 bg-slate-50">
                <div class="shadow-sm rounded-lg border border-slate-300 overflow-hidden">
                    <textarea id="sql-editor"></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="runUserQuery()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded shadow-sm font-medium transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-play"></i> Run Query
                    </button>
                    <!-- Show Answer button removed -->
                    <button onclick="resetLevel()" class="ml-auto text-slate-500 hover:text-red-500 px-3 py-2">
                        <i class="fa-solid fa-rotate-left"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Results Area -->
            <div class="flex-1 overflow-hidden flex flex-col p-6 pt-0">
                <!-- Status Message -->
                <div id="status-msg" class="hidden mb-4 p-4 rounded-md border"></div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full overflow-hidden">
                    <!-- User Results -->
                    <div class="flex flex-col h-full bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 text-sm font-semibold text-slate-600">Your Result</div>
                        <div class="overflow-auto flex-1 p-0" id="user-result-container">
                            <div class="p-8 text-center text-slate-400 italic">Run a query to see results</div>
                        </div>
                    </div>
                    
                    <!-- Expected Results (Hidden initially or for comparison) -->
                    <div class="flex flex-col h-full bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden transition-all">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 text-sm font-semibold text-slate-600 flex justify-between">
                            <span>Expected Result</span>
                            <span class="text-xs font-normal text-slate-400">(Truncated Preview)</span>
                        </div>
                        <div class="overflow-auto flex-1 p-0" id="expected-result-container">
                             <div class="p-8 text-center text-slate-400 italic">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Schema Modal -->
    <div id="schema-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-slate-200">
                <h3 class="text-lg font-bold">Database Schema</h3>
                <button onclick="toggleSchema()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50">
                <!-- CITY Table -->
                <div class="bg-white p-4 rounded border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-2 mb-3 border-b pb-2">
                        <i class="fa-solid fa-city text-blue-500"></i>
                        <h4 class="font-bold text-slate-700">CITY</h4>
                    </div>
                    <ul class="text-sm space-y-2 text-slate-600 font-mono">
                        <li class="flex justify-between"><span>ID</span> <span class="text-slate-400">INT</span></li>
                        <li class="flex justify-between"><span>NAME</span> <span class="text-slate-400">VARCHAR</span></li>
                        <li class="flex justify-between"><span>COUNTRYCODE</span> <span class="text-slate-400">VARCHAR(3)</span></li>
                        <li class="flex justify-between"><span>DISTRICT</span> <span class="text-slate-400">VARCHAR</span></li>
                        <li class="flex justify-between"><span>POPULATION</span> <span class="text-slate-400">INT</span></li>
                    </ul>
                </div>
                <!-- Employee Table -->
                <div class="bg-white p-4 rounded border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-2 mb-3 border-b pb-2">
                        <i class="fa-solid fa-users text-green-500"></i>
                        <h4 class="font-bold text-slate-700">Employee</h4>
                    </div>
                    <ul class="text-sm space-y-2 text-slate-600 font-mono">
                        <li class="flex justify-between"><span>employee_id</span> <span class="text-slate-400">INT</span></li>
                        <li class="flex justify-between"><span>name</span> <span class="text-slate-400">VARCHAR</span></li>
                        <li class="flex justify-between"><span>months</span> <span class="text-slate-400">INT</span></li>
                        <li class="flex justify-between"><span>salary</span> <span class="text-slate-400">INT</span></li>
                        <li class="flex justify-between"><span>group_id</span> <span class="text-slate-400">INT</span></li>
                    </ul>
                    <p class="text-xs text-slate-400 mt-2">*Note: The column is 'group_id' to avoid SQL reserved keyword conflicts, though practice questions refer to it as 'group'.</p>
                </div>
            </div>
            <div class="p-4 bg-slate-100 border-t border-slate-200 text-right">
                <button onclick="toggleSchema()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA INITIALIZATION ---
        
        // Mock Data based on user prompt requirements
        const cityData = [
            {ID: 1661, NAME: 'Sayama', COUNTRYCODE: 'JPN', DISTRICT: 'Saitama', POPULATION: 162472},
            {ID: 1613, NAME: 'Neyagawa', COUNTRYCODE: 'JPN', DISTRICT: 'Osaka', POPULATION: 257315},
            {ID: 3878, NAME: 'Scottsdale', COUNTRYCODE: 'USA', DISTRICT: 'Arizona', POPULATION: 202705},
            {ID: 4054, NAME: 'Fairfield', COUNTRYCODE: 'USA', DISTRICT: 'California', POPULATION: 92256},
            {ID: 3973, NAME: 'Concord', COUNTRYCODE: 'USA', DISTRICT: 'California', POPULATION: 121780},
            {ID: 2227, NAME: 'Xingcheng', COUNTRYCODE: 'CHN', DISTRICT: 'Liaoning', POPULATION: 102384},
            {ID: 4061, NAME: 'Fall River', COUNTRYCODE: 'USA', DISTRICT: 'Massachusetts', POPULATION: 90555},
            {ID: 1155, NAME: 'Latur', COUNTRYCODE: 'IND', DISTRICT: 'Maharashtra', POPULATION: 197408},
            {ID: 552,  NAME: 'Bujumbura', COUNTRYCODE: 'BDI', DISTRICT: 'Bujumbura', POPULATION: 300000},
            {ID: 2922, NAME: 'Carolina', COUNTRYCODE: 'PRI', DISTRICT: 'Carolina', POPULATION: 186076},
            {ID: 1001, NAME: 'Akita', COUNTRYCODE: 'JPN', DISTRICT: 'Akita', POPULATION: 300000}, // Starts with A
            {ID: 1002, NAME: 'Albany', COUNTRYCODE: 'USA', DISTRICT: 'New York', POPULATION: 98000}, // Starts with A
            {ID: 214,  NAME: 'Porto Alegre', COUNTRYCODE: 'BRA', DISTRICT: 'Rio Grande do Sul', POPULATION: 1314032}
        ];

        // Note: Using 'group_id' instead of 'group' because GROUP is a reserved keyword in SQL.
        // I will handle column aliasing in expected queries or instruct the user.
        const employeeData = [
            {employee_id: 1233, name: 'Angela', months: 7, salary: 1296, group_id: 2},
            {employee_id: 1901, name: 'Frank', months: 10, salary: 2763, group_id: 3},
            {employee_id: 2035, name: 'Patrick', months: 1, salary: 4583, group_id: 4},
            {employee_id: 330,  name: 'Rose', months: 5, salary: 2248, group_id: 1},
            {employee_id: 15151, name: 'Paula', months: 15, salary: 1526, group_id: 10},
            {employee_id: 5962, name: 'Earl', months: 11, salary: 2958, group_id: 1}, // Group 1 test
            {employee_id: 45285, name: 'Jesse', months: 1, salary: 3768, group_id: 9},
            {employee_id: 15286, name: 'Marilyn', months: 2, salary: 1400, group_id: 2}, // Low salary test
            {employee_id: 41228, name: 'Lori', months: 13, salary: 4350, group_id: 7},
            {employee_id: 99999, name: 'Adam', months: 15, salary: 1450, group_id: 1}, // Starts with A, > 12 months, < 1500 salary
            {employee_id: 88888, name: 'Arthur', months: 20, salary: 2500, group_id: 2}, // Starts with A, > 12 months
            {employee_id: 77777, name: 'Ben', months: 9, salary: 2100, group_id: 3}, // High salary, < 10 months
            {employee_id: 66666, name: 'Carl', months: 11, salary: 2200, group_id: 20} // Group with high exp
        ];

        // Initialize AlaSQL Database
        alasql('CREATE TABLE CITY (ID INT, NAME STRING, COUNTRYCODE STRING, DISTRICT STRING, POPULATION INT)');
        alasql('CREATE TABLE Employee (employee_id INT, name STRING, months INT, salary INT, group_id INT)');
        
        alasql.tables.CITY.data = cityData;
        alasql.tables.Employee.data = employeeData;

        // --- 2. GAME LEVELS CONFIGURATION ---

        const levels = [
            {
                id: 1,
                category: "CITY",
                skill: "#select *",
                question: "Query all columns (attributes) for every row in the CITY table.",
                expectedSQL: "SELECT * FROM CITY",
                hint: "Use the wildcard symbol `*` to select all columns."
            },
            {
                id: 2,
                category: "CITY",
                skill: "#where #id",
                question: "Query all columns for a city in CITY with the ID 1661.",
                expectedSQL: "SELECT * FROM CITY WHERE ID = 1661",
                hint: "Use a `WHERE` clause to filter by ID."
            },
            {
                id: 3,
                category: "CITY",
                skill: "#where #and",
                question: "Query all columns for all American cities (CountryCode 'USA') with populations larger than 100,000.",
                expectedSQL: "SELECT * FROM CITY WHERE COUNTRYCODE = 'USA' AND POPULATION > 100000",
                hint: "Combine two conditions using `AND`."
            },
            {
                id: 4,
                category: "CITY",
                skill: "#select #column",
                question: "Query the NAME field for all American cities with populations larger than 120,000.",
                expectedSQL: "SELECT NAME FROM CITY WHERE COUNTRYCODE = 'USA' AND POPULATION > 120000",
                hint: "Instead of `*`, specify the column name `NAME` after SELECT."
            },
            {
                id: 5,
                category: "CITY",
                skill: "#where #string",
                question: "Query all attributes of every Japanese city in the CITY table. (CountryCode 'JPN')",
                expectedSQL: "SELECT * FROM CITY WHERE COUNTRYCODE = 'JPN'",
                hint: "Filter where COUNTRYCODE is 'JPN'."
            },
            {
                id: 6,
                category: "CITY",
                skill: "#select #where",
                question: "Query the names of all the Japanese cities in the CITY table.",
                expectedSQL: "SELECT NAME FROM CITY WHERE COUNTRYCODE = 'JPN'",
                hint: "Select only the NAME column."
            },
            {
                id: 7,
                category: "CITY",
                skill: "#orderby #asc",
                question: "Query all cities and sort them by population ascendingly.",
                expectedSQL: "SELECT * FROM CITY ORDER BY POPULATION ASC",
                hint: "Use `ORDER BY column_name ASC`."
            },
            {
                id: 8,
                category: "CITY",
                skill: "#orderby #desc",
                question: "Query all cities and sort them by population descendingly.",
                expectedSQL: "SELECT * FROM CITY ORDER BY POPULATION DESC",
                hint: "Use `ORDER BY column_name DESC`."
            },
            {
                id: 9,
                category: "CITY",
                skill: "#groupby #sum",
                question: "Calculate total population by country.",
                expectedSQL: "SELECT COUNTRYCODE, SUM(POPULATION) FROM CITY GROUP BY COUNTRYCODE",
                hint: "Use `SUM(POPULATION)` and `GROUP BY COUNTRYCODE`."
            },
            {
                id: 10,
                category: "CITY",
                skill: "#orderby #aggregate",
                question: "Sort country code by total population (ascending).",
                expectedSQL: "SELECT COUNTRYCODE, SUM(POPULATION) FROM CITY GROUP BY COUNTRYCODE ORDER BY SUM(POPULATION)",
                hint: "You can `ORDER BY` the aggregate result `SUM(POPULATION)`."
            },
            {
                id: 11,
                category: "CITY",
                skill: "#like",
                question: "List city names that start with 'a' (case insensitive).",
                expectedSQL: "SELECT NAME FROM CITY WHERE NAME LIKE 'A%'",
                hint: "Use `LIKE 'A%'`. The % is a wildcard for any characters following 'A'."
            },
            {
                id: 12,
                category: "CITY",
                skill: "#distinct",
                question: "Query a list of unique districts from the CITY table.",
                expectedSQL: "SELECT DISTINCT DISTRICT FROM CITY",
                hint: "Use the `DISTINCT` keyword before the column name to remove duplicates."
            },
            {
                id: 13,
                category: "CITY",
                skill: "#count",
                question: "Count the total number of cities in the CITY table.",
                expectedSQL: "SELECT COUNT(*) FROM CITY",
                hint: "Use the `COUNT(*)` function."
            },
            {
                id: 14,
                category: "CITY",
                skill: "#between",
                question: "Query all cities with a population between 100,000 and 200,000.",
                expectedSQL: "SELECT * FROM CITY WHERE POPULATION BETWEEN 100000 AND 200000",
                hint: "Use the `BETWEEN` operator: `WHERE column BETWEEN x AND y`."
            },
            {
                id: 15,
                category: "Employee",
                skill: "#orderby #string",
                question: "Find employee names from the Employee table in alphabetical order.",
                expectedSQL: "SELECT name FROM Employee ORDER BY name",
                hint: "Select name and order by it."
            },
            {
                id: 16,
                category: "Employee",
                skill: "#where #orderby",
                question: "Find employee names having a salary lower than $1500. Sort your result by descending month experience.",
                expectedSQL: "SELECT name FROM Employee WHERE salary < 1500 ORDER BY months DESC",
                hint: "Filter salary first, then order by months with DESC."
            },
            {
                id: 17,
                category: "Employee",
                skill: "#where #or",
                question: "Find employee names having a salary lower than $1500 OR who just came within 1 year (months < 12).",
                expectedSQL: "SELECT name FROM Employee WHERE salary < 1500 OR months < 12",
                hint: "Use the `OR` operator between the two conditions."
            },
            {
                id: 18,
                category: "Employee",
                skill: "#where #and #asc",
                question: "Find employee names having a salary greater than $2000 per month who have been employees for less than 10 months. Sort by ascending employee_id.",
                expectedSQL: "SELECT name FROM Employee WHERE salary > 2000 AND months < 10 ORDER BY employee_id ASC",
                hint: "Two conditions with AND, then ORDER BY."
            },
            {
                id: 19,
                category: "Employee",
                skill: "#like #and",
                question: "List employee names starting with 'A' who have worked here more than 1 year (> 12 months).",
                expectedSQL: "SELECT name FROM Employee WHERE name LIKE 'A%' AND months > 12",
                hint: "Combine `LIKE` and a greater than comparison."
            },
            {
                id: 20,
                category: "Employee",
                skill: "#groupby #avg #in",
                question: "Find the average salary for group 1 and 2 respectively.",
                expectedSQL: "SELECT group_id, AVG(salary) FROM Employee WHERE group_id IN (1, 2) GROUP BY group_id",
                hint: "Filter `WHERE group_id IN (1, 2)` then `GROUP BY group_id`. Note: Use `group_id` column."
            },
            {
                id: 21,
                category: "Employee",
                skill: "#having #orderby",
                question: "Find groups with their average month experience more than 10 months, sort by group number descendingly.",
                expectedSQL: "SELECT group_id FROM Employee GROUP BY group_id HAVING AVG(months) > 10 ORDER BY group_id DESC",
                hint: "Use `HAVING` to filter after grouping (aggregates), not `WHERE`."
            },
            {
                id: 22,
                category: "Employee",
                skill: "#math #alias",
                question: "Select name and annual salary (salary * 12) for all employees.",
                expectedSQL: "SELECT name, salary * 12 FROM Employee",
                hint: "You can perform multiplication directly in the SELECT statement: `salary * 12`."
            },
            {
                id: 23,
                category: "Employee",
                skill: "#limit",
                question: "Find the top 3 earners (highest salary) in the company.",
                expectedSQL: "SELECT * FROM Employee ORDER BY salary DESC LIMIT 3",
                hint: "Order by salary descending, then use `LIMIT 3`."
            },
            {
                id: 24,
                category: "Employee",
                skill: "#min #max",
                question: "Find the minimum and maximum salary in the Employee table.",
                expectedSQL: "SELECT MIN(salary), MAX(salary) FROM Employee",
                hint: "Use `MIN(column)` and `MAX(column)` functions."
            },
            {
                id: 25,
                category: "Employee",
                skill: "#length",
                question: "Find the names of employees whose name is longer than 5 characters.",
                expectedSQL: "SELECT name FROM Employee WHERE LENGTH(name) > 5",
                hint: "Use the `LENGTH(name)` function."
            },
            {
                id: 26,
                category: "Employee",
                skill: "#count #where",
                question: "Count how many employees have a salary greater than $3000.",
                expectedSQL: "SELECT COUNT(*) FROM Employee WHERE salary > 3000",
                hint: "Use `COUNT(*)` combined with a `WHERE` clause."
            },
            {
                id: 27,
                category: "CITY",
                skill: "#avg #where",
                question: "Find the average population of cities in Japan (JPN).",
                expectedSQL: "SELECT AVG(POPULATION) FROM CITY WHERE COUNTRYCODE = 'JPN'",
                hint: "Use `AVG(POPULATION)` with a filter."
            },
            {
                id: 28,
                category: "Employee",
                skill: "#calculation #alias",
                question: "Calculate the total salary paid to all employees in Group 1.",
                expectedSQL: "SELECT SUM(salary) FROM Employee WHERE group_id = 1",
                hint: "Use `SUM(salary)` where group_id is 1."
            },
            {
                id: 29,
                category: "CITY",
                skill: "#not",
                question: "Query all cities that are NOT in the USA.",
                expectedSQL: "SELECT * FROM CITY WHERE COUNTRYCODE != 'USA'",
                hint: "Use `!=` or `<>` or `NOT`."
            },
            {
                id: 30,
                category: "Employee",
                skill: "#where #complex",
                question: "Find employees in Group 2 who earn more than 1500 OR employees in Group 3 who earn more than 2500.",
                expectedSQL: "SELECT * FROM Employee WHERE (group_id = 2 AND salary > 1500) OR (group_id = 3 AND salary > 2500)",
                hint: "Use parentheses `()` to group your AND/OR logic."
            }
        ];

        // --- 3. APPLICATION STATE & LOGIC ---

        let currentLevelIndex = 0;
        let editor;
        let completedLevels = new Set();

        window.onload = function() {
            // Initialize CodeMirror
            editor = CodeMirror.fromTextArea(document.getElementById('sql-editor'), {
                mode: 'text/x-sql',
                theme: 'dracula',
                lineNumbers: true,
                smartIndent: true,
                extraKeys: {"Ctrl-Enter": runUserQuery}
            });

            renderLevelList();
            loadLevel(0);
        };

        function renderLevelList() {
            const listContainer = document.getElementById('level-list');
            listContainer.innerHTML = '';
            
            levels.forEach((level, index) => {
                const isCompleted = completedLevels.has(level.id);
                const isActive = index === currentLevelIndex;
                
                const div = document.createElement('div');
                div.className = `p-3 rounded-md cursor-pointer text-sm flex items-center justify-between transition-colors ${
                    isActive ? 'bg-blue-100 border-blue-300 border text-blue-800' : 
                    'bg-white border border-transparent hover:bg-slate-50 hover:border-slate-200 text-slate-600'
                }`;
                div.onclick = () => loadLevel(index);

                const left = document.createElement('div');
                left.className = "flex items-center gap-2";
                left.innerHTML = `<span class="font-bold w-5 text-slate-400 text-xs">${index + 1}.</span> <span class="truncate w-48 font-mono text-xs font-semibold text-slate-600">${level.skill}</span>`;

                const icon = document.createElement('i');
                if (isCompleted) {
                    icon.className = "fa-solid fa-check-circle text-green-500";
                } else {
                    icon.className = "fa-regular fa-circle text-slate-300";
                }

                div.appendChild(left);
                div.appendChild(icon);
                listContainer.appendChild(div);
            });

            document.getElementById('progress-text').innerText = `${completedLevels.size}/${levels.length} Completed`;
        }

        function loadLevel(index) {
            currentLevelIndex = index;
            const level = levels[index];
            
            document.getElementById('question-text').innerText = level.question;
            document.getElementById('current-table-badge').innerText = `${level.category} Table`;
            document.getElementById('current-table-badge').className = level.category === 'CITY' 
                ? 'bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded'
                : 'bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded';

            // Reset UI
            document.getElementById('status-msg').className = 'hidden mb-4 p-4 rounded-md border';
            document.getElementById('user-result-container').innerHTML = '<div class="p-8 text-center text-slate-400 italic">Run a query to see results</div>';
            
            editor.setValue("");
            editor.focus();
            renderLevelList();
            
            // Generate expected result silently
            try {
                const expectedRes = alasql(level.expectedSQL);
                renderTable(expectedRes, 'expected-result-container', true);
            } catch (e) {
                console.error("Error generating expected result:", e);
            }
        }

        function runUserQuery() {
            const userSQL = editor.getValue().trim();
            const statusDiv = document.getElementById('status-msg');
            
            if (!userSQL) {
                statusDiv.innerText = "Please enter a SQL query.";
                statusDiv.className = "block mb-4 p-4 rounded-md border bg-yellow-50 border-yellow-200 text-yellow-800";
                return;
            }

            try {
                // 1. Run User Query
                const userResult = alasql(userSQL);
                renderTable(userResult, 'user-result-container');

                // 2. Run Expected Query
                const level = levels[currentLevelIndex];
                const expectedResult = alasql(level.expectedSQL);

                // 3. Compare
                const isCorrect = JSON.stringify(userResult) === JSON.stringify(expectedResult);

                if (isCorrect) {
                    statusDiv.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid fa-check-circle text-green-600 text-xl"></i> <div><strong>Correct!</strong> Great job.</div></div>`;
                    statusDiv.className = "block mb-4 p-4 rounded-md border bg-green-50 border-green-200 text-green-800";
                    completedLevels.add(level.id);
                    renderLevelList();
                } else {
                    statusDiv.innerHTML = `<div class="flex flex-col gap-2">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-xmark-circle text-red-600 text-xl"></i> <div><strong>Incorrect.</strong> Your result doesn't match the expected output.</div></div>
                        <div class="text-sm bg-yellow-50 text-yellow-800 p-2 rounded border border-yellow-200 mt-1"><strong>Hint:</strong> ${level.hint}</div>
                    </div>`;
                    statusDiv.className = "block mb-4 p-4 rounded-md border bg-red-50 border-red-200 text-red-800";
                }

            } catch (err) {
                statusDiv.innerText = "SQL Error: " + err.message;
                statusDiv.className = "block mb-4 p-4 rounded-md border bg-red-50 border-red-200 text-red-800 font-mono text-sm";
                document.getElementById('user-result-container').innerHTML = '<div class="p-8 text-center text-red-400 italic">Query Failed</div>';
            }
        }

        function renderTable(data, containerId, isTruncated = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="p-4 text-slate-500 italic">Query returned no results.</div>';
                return;
            }

            // If result is a single primitive (e.g. from a count without alias), wrap it
            if (typeof data[0] !== 'object') {
                data = data.map(val => ({ Result: val }));
            }

            const table = document.createElement('table');
            table.className = "min-w-full text-left text-sm whitespace-nowrap";
            
            // Prepare Data to Display
            let displayData = data;
            if (isTruncated && data.length > 3) {
                displayData = data.slice(0, 3);
            }

            // Header
            const thead = document.createElement('thead');
            thead.className = "bg-slate-100 border-b border-slate-200 sticky top-0";
            const trHead = document.createElement('tr');
            
            Object.keys(displayData[0]).forEach(key => {
                const th = document.createElement('th');
                th.className = "px-4 py-2 font-semibold text-slate-600";
                th.innerText = key;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            // Body
            const tbody = document.createElement('tbody');
            displayData.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = idx % 2 === 0 ? "bg-white" : "bg-slate-50";
                
                Object.values(row).forEach(val => {
                    const td = document.createElement('td');
                    td.className = "px-4 py-2 border-b border-slate-100 text-slate-700 font-mono";
                    td.innerText = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            // Add "..." row if truncated
            if (isTruncated && data.length > 3) {
                const tr = document.createElement('tr');
                tr.className = "bg-slate-50 opacity-50";
                Object.keys(displayData[0]).forEach(() => {
                    const td = document.createElement('td');
                    td.className = "px-4 py-2 border-b border-slate-100 text-slate-700 font-mono italic";
                    td.innerText = "...";
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
                
                // Add footer info
                const trInfo = document.createElement('tr');
                const tdInfo = document.createElement('td');
                tdInfo.colSpan = Object.keys(displayData[0]).length;
                tdInfo.className = "px-4 py-2 text-xs text-slate-400 text-center bg-slate-50";
                tdInfo.innerText = `(${data.length - 3} more rows hidden)`;
                trInfo.appendChild(tdInfo);
                tbody.appendChild(trInfo);
            }

            table.appendChild(tbody);
            container.appendChild(table);
        }

        function resetLevel() {
            editor.setValue("");
            document.getElementById('status-msg').classList.add('hidden');
            document.getElementById('user-result-container').innerHTML = '<div class="p-8 text-center text-slate-400 italic">Run a query to see results</div>';
        }

        function toggleSchema() {
            const modal = document.getElementById('schema-modal');
            modal.classList.toggle('hidden');
        }

    </script>
</body>
</html>
