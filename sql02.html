<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Mastery: Interactive Practice</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- AlaSQL for client-side SQL execution -->
    <script src="https://cdn.jsdelivr.net/npm/alasql@4.4.0/dist/alasql.min.js"></script>
    <!-- CodeMirror for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .CodeMirror {
            height: 150px;
            border-radius: 0.5rem;
            font-size: 14px;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #1d4ed8;
            background-color: #eff6ff;
        }
        .cheatsheet-code {
            background-color: #1e293b;
            color: #a5b4fc;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col font-sans text-slate-800">

    <!-- Header -->
    <header class="bg-slate-800 text-white p-4 shadow-md flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-database text-yellow-400 text-2xl"></i>
            <h1 class="text-xl font-bold tracking-wide">SQL Mastery <span class="text-slate-400 text-sm font-normal ml-2">Interactive Practice</span></h1>
        </div>
        <div class="text-sm text-slate-400">
            <span id="progress-text">0/40 Completed</span>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-80 bg-white border-r border-slate-200 flex flex-col shrink-0 overflow-hidden">
            <!-- Tabs -->
            <div class="flex border-b border-slate-200">
                <button onclick="switchTab('practice')" id="tab-practice" class="flex-1 py-3 text-sm font-semibold text-slate-600 hover:bg-slate-50 transition-colors tab-active">
                    <i class="fa-solid fa-list-check mr-2"></i> Practice
                </button>
                <button onclick="switchTab('cheatsheet')" id="tab-cheatsheet" class="flex-1 py-3 text-sm font-semibold text-slate-600 hover:bg-slate-50 transition-colors">
                    <i class="fa-solid fa-book-open mr-2"></i> Cheatsheet
                </button>
            </div>

            <!-- Practice List -->
            <div id="content-practice" class="flex-1 overflow-y-auto p-2 space-y-2">
                <!-- Levels will be injected here -->
            </div>

            <!-- Cheatsheet Content -->
            <div id="content-cheatsheet" class="flex-1 overflow-y-auto p-4 hidden bg-slate-50">
                
                <div class="space-y-6">
                    <!-- Basics -->
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-2 border-b pb-1">1. The Basics</h3>
                        <div class="text-sm space-y-3">
                            <div>
                                <p class="font-semibold text-slate-700">Select All</p>
                                <code class="cheatsheet-code block mt-1">SELECT * FROM table_name;</code>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-700">Distinct Values</p>
                                <code class="cheatsheet-code block mt-1">SELECT DISTINCT col1 FROM table;</code>
                            </div>
                        </div>
                    </div>

                    <!-- Logical Operators -->
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-2 border-b pb-1">2. Logical Operators</h3>
                        <div class="text-sm space-y-3">
                            <div><code class="cheatsheet-code">AND</code>, <code class="cheatsheet-code">OR</code>, <code class="cheatsheet-code">NOT</code></div>
                            <div>
                                <p class="font-semibold text-slate-700">Lists & Ranges</p>
                                <code class="cheatsheet-code block mt-1">col IN (1, 2, 3)</code>
                                <code class="cheatsheet-code block mt-1">col BETWEEN 10 AND 20</code>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-700">Pattern Matching</p>
                                <code class="cheatsheet-code block mt-1">LIKE 'A%'</code> <span class="text-xs text-slate-500">(Starts with A)</span>
                                <code class="cheatsheet-code block mt-1">LIKE '_B%'</code> <span class="text-xs text-slate-500">(2nd char is B)</span>
                            </div>
                            <div>
                                <p class="font-semibold text-slate-700">Nulls</p>
                                <code class="cheatsheet-code block mt-1">IS NULL</code>, <code class="cheatsheet-code block mt-1">IS NOT NULL</code>
                            </div>
                        </div>
                    </div>

                    <!-- String Functions -->
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-2 border-b pb-1">3. String Functions</h3>
                        <div class="text-sm space-y-3">
                            <div><code class="cheatsheet-code">LEN(str)</code> / <code class="cheatsheet-code">CHAR_LENGTH(str)</code></div>
                            <div><code class="cheatsheet-code">LOWER(str)</code>, <code class="cheatsheet-code">UPPER(str)</code></div>
                            <div><code class="cheatsheet-code">TRIM(str)</code> <span class="text-xs text-slate-500">(Remove spaces)</span></div>
                            <div><code class="cheatsheet-code">SUBSTRING(str, start, len)</code></div>
                            <div><code class="cheatsheet-code">MID(str, start, len)</code></div>
                        </div>
                    </div>

                    <!-- Math Functions -->
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-2 border-b pb-1">4. Math Functions</h3>
                        <div class="text-sm space-y-3">
                            <div><code class="cheatsheet-code">ABS(num)</code> <span class="text-xs text-slate-500">(Absolute value)</span></div>
                            <div><code class="cheatsheet-code">INT(num)</code> / <code class="cheatsheet-code">FLOOR(num)</code></div>
                            <div><code class="cheatsheet-code">ROUND(num, decimals)</code></div>
                        </div>
                    </div>

                    <!-- Aggregates -->
                    <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-800 mb-2 border-b pb-1">5. Aggregates</h3>
                        <div class="text-sm space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div><code class="cheatsheet-code">COUNT(*)</code></div>
                                <div><code class="cheatsheet-code">SUM(col)</code></div>
                                <div><code class="cheatsheet-code">AVG(col)</code></div>
                                <div><code class="cheatsheet-code">MAX(col)</code></div>
                                <div><code class="cheatsheet-code">MIN(col)</code></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="h-8"></div> <!-- Spacer -->
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden">
            
            <!-- Question Area -->
            <div class="p-6 bg-white border-b border-slate-200 shrink-0">
                <div class="flex justify-between items-start mb-2">
                    <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded" id="current-table-badge">CITY Table</span>
                    <button onclick="toggleSchema()" class="text-xs text-slate-500 hover:text-blue-600 underline">
                        <i class="fa-solid fa-table"></i> View Schema
                    </button>
                </div>
                <h2 id="question-text" class="text-lg font-medium text-slate-800 mb-2">Select a level to begin...</h2>
            </div>

            <!-- Editor Area -->
            <div class="p-6 flex flex-col gap-4 shrink-0 bg-slate-50">
                <div class="shadow-sm rounded-lg border border-slate-300 overflow-hidden">
                    <textarea id="sql-editor"></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="runUserQuery()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded shadow-sm font-medium transition-colors flex items-center gap-2">
                        <i class="fa-solid fa-play"></i> Run Query
                    </button>
                    <!-- Show Answer button removed -->
                    <button onclick="resetLevel()" class="ml-auto text-slate-500 hover:text-red-500 px-3 py-2">
                        <i class="fa-solid fa-rotate-left"></i> Reset
                    </button>
                </div>
            </div>

            <!-- Results Area -->
            <div class="flex-1 overflow-hidden flex flex-col p-6 pt-0">
                <!-- Status Message -->
                <div id="status-msg" class="hidden mb-4 p-4 rounded-md border"></div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-full overflow-hidden">
                    <!-- User Results -->
                    <div class="flex flex-col h-full bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 text-sm font-semibold text-slate-600">Your Result</div>
                        <div class="overflow-auto flex-1 p-0" id="user-result-container">
                            <div class="p-8 text-center text-slate-400 italic">Run a query to see results</div>
                        </div>
                    </div>
                    
                    <!-- Expected Results (Hidden initially or for comparison) -->
                    <div class="flex flex-col h-full bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden transition-all">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-200 text-sm font-semibold text-slate-600 flex justify-between">
                            <span>Expected Result</span>
                            <span class="text-xs font-normal text-slate-400">(Truncated Preview)</span>
                        </div>
                        <div class="overflow-auto flex-1 p-0" id="expected-result-container">
                             <div class="p-8 text-center text-slate-400 italic">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Schema Modal -->
    <div id="schema-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl m-4 overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-slate-200">
                <h3 class="text-lg font-bold">Database Schema</h3>
                <button onclick="toggleSchema()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50">
                <!-- CITY Table -->
                <div class="bg-white p-4 rounded border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-2 mb-3 border-b pb-2">
                        <i class="fa-solid fa-city text-blue-500"></i>
                        <h4 class="font-bold text-slate-700">CITY</h4>
                    </div>
                    <ul class="text-sm space-y-2 text-slate-600 font-mono">
                        <li class="flex justify-between"><span>ID</span> <span class="text-slate-400">INT</span></li>
                        <li class="flex justify-between"><span>NAME</span> <span class="text-slate-400">VARCHAR</span></li>
                        <li class="flex justify-between"><span>COUNTRYCODE</span> <span class="text-slate-400">VARCHAR(3)</span></li>
                        <li class="flex justify-between"><span>DISTRICT</span> <span class="text-slate-400">VARCHAR</span></li>
                        <li class="flex justify-between"><span>POPULATION</span> <span class="text-slate-400">INT</span></li>
                    </ul>
                </div>
                <!-- Employee Table -->
                <div class="bg-white p-4 rounded border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-2 mb-3 border-b pb-2">
                        <i class="fa-solid fa-users text-green-500"></i>
                        <h4 class="font-bold text-slate-700">Employee</h4>
                    </div>
                    <ul class="text-sm space-y-2 text-slate-600 font-mono">
                        <li class="flex justify-between"><span>employee_id</span> <span class="text-slate-400">INT</span></li>
                        <li class="flex justify-between"><span>name</span> <span class="text-slate-400">VARCHAR</span></li>
                        <li class="flex justify-between"><span>months</span> <span class="text-slate-400">INT</span></li>
                        <li class="flex justify-between"><span>salary</span> <span class="text-slate-400">INT</span></li>
                        <li class="flex justify-between"><span>group_id</span> <span class="text-slate-400">INT</span></li>
                    </ul>
                    <p class="text-xs text-slate-400 mt-2">*Note: The column is 'group_id' to avoid SQL reserved keyword conflicts, though practice questions refer to it as 'group'.</p>
                </div>
            </div>
            <div class="p-4 bg-slate-100 border-t border-slate-200 text-right">
                <button onclick="toggleSchema()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATA INITIALIZATION ---
        
        const cityData = [
            {ID: 1661, NAME: 'Sayama', COUNTRYCODE: 'JPN', DISTRICT: 'Saitama', POPULATION: 162472},
            {ID: 1613, NAME: 'Neyagawa', COUNTRYCODE: 'JPN', DISTRICT: 'Osaka', POPULATION: 257315},
            {ID: 3878, NAME: 'Scottsdale', COUNTRYCODE: 'USA', DISTRICT: 'Arizona', POPULATION: 202705},
            {ID: 4054, NAME: 'Fairfield', COUNTRYCODE: 'USA', DISTRICT: 'California', POPULATION: 92256},
            {ID: 3973, NAME: 'Concord', COUNTRYCODE: 'USA', DISTRICT: 'California', POPULATION: 121780},
            {ID: 2227, NAME: 'Xingcheng', COUNTRYCODE: 'CHN', DISTRICT: 'Liaoning', POPULATION: 102384},
            {ID: 4061, NAME: 'Fall River', COUNTRYCODE: 'USA', DISTRICT: 'Massachusetts', POPULATION: 90555},
            {ID: 1155, NAME: 'Latur', COUNTRYCODE: 'IND', DISTRICT: 'Maharashtra', POPULATION: 197408},
            {ID: 552,  NAME: 'Bujumbura', COUNTRYCODE: 'BDI', DISTRICT: 'Bujumbura', POPULATION: 300000},
            {ID: 2922, NAME: 'Carolina', COUNTRYCODE: 'PRI', DISTRICT: 'Carolina', POPULATION: 186076},
            {ID: 1001, NAME: 'Akita', COUNTRYCODE: 'JPN', DISTRICT: 'Akita', POPULATION: 300000}, 
            {ID: 1002, NAME: 'Albany', COUNTRYCODE: 'USA', DISTRICT: 'New York', POPULATION: 98000},
            {ID: 214,  NAME: 'Porto Alegre', COUNTRYCODE: 'BRA', DISTRICT: 'Rio Grande do Sul', POPULATION: 1314032},
            // Additional Data for String/Null/Math testing
            {ID: 9001, NAME: '  TrimMe  ', COUNTRYCODE: 'TST', DISTRICT: null, POPULATION: 500}, 
            {ID: 9002, NAME: 'short', COUNTRYCODE: 'TST', DISTRICT: 'TestDist', POPULATION: 100},
            {ID: 9003, NAME: 'Special', COUNTRYCODE: 'TST', DISTRICT: null, POPULATION: 1234}
        ];

        const employeeData = [
            {employee_id: 1233, name: 'Angela', months: 7, salary: 1296, group_id: 2},
            {employee_id: 1901, name: 'Frank', months: 10, salary: 2763, group_id: 3},
            {employee_id: 2035, name: 'Patrick', months: 1, salary: 4583, group_id: 4},
            {employee_id: 330,  name: 'Rose', months: 5, salary: 2248, group_id: 1},
            {employee_id: 15151, name: 'Paula', months: 15, salary: 1526, group_id: 10},
            {employee_id: 5962, name: 'Earl', months: 11, salary: 2958, group_id: 1}, 
            {employee_id: 45285, name: 'Jesse', months: 1, salary: 3768, group_id: 9},
            {employee_id: 15286, name: 'Marilyn', months: 2, salary: 1400, group_id: 2},
            {employee_id: 41228, name: 'Lori', months: 13, salary: 4350, group_id: 7},
            {employee_id: 99999, name: 'Adam', months: 15, salary: 1450, group_id: 1},
            {employee_id: 88888, name: 'Arthur', months: 20, salary: 2500, group_id: 2}, 
            {employee_id: 77777, name: 'Ben', months: 9, salary: 2100, group_id: 3},
            {employee_id: 66666, name: 'Carl', months: 11, salary: 2200, group_id: 20}
        ];

        alasql('CREATE TABLE CITY (ID INT, NAME STRING, COUNTRYCODE STRING, DISTRICT STRING, POPULATION INT)');
        alasql('CREATE TABLE Employee (employee_id INT, name STRING, months INT, salary INT, group_id INT)');
        
        alasql.tables.CITY.data = cityData;
        alasql.tables.Employee.data = employeeData;

        // --- 2. GAME LEVELS CONFIGURATION ---

        const levels = [
            // --- BASICS ---
            {
                id: 1,
                category: "CITY",
                skill: "#select *",
                difficulty: "Beginner",
                question: "Query all columns for every row in the CITY table.",
                expectedSQL: "SELECT * FROM CITY",
                hint: "Use `SELECT * FROM CITY`."
            },
            {
                id: 2,
                category: "CITY",
                skill: "#select col",
                difficulty: "Beginner",
                question: "Query only the NAME and POPULATION for all cities.",
                expectedSQL: "SELECT NAME, POPULATION FROM CITY",
                hint: "Separate column names with a comma."
            },
            {
                id: 3,
                category: "CITY",
                skill: "#distinct",
                difficulty: "Beginner",
                question: "Query a list of unique districts from the CITY table.",
                expectedSQL: "SELECT DISTINCT DISTRICT FROM CITY",
                hint: "Use `SELECT DISTINCT DISTRICT ...`."
            },

            // --- FILTERING & LOGIC ---
            {
                id: 4,
                category: "CITY",
                skill: "#where #and",
                difficulty: "Beginner",
                question: "Query cities in 'USA' with population > 100000.",
                expectedSQL: "SELECT * FROM CITY WHERE COUNTRYCODE = 'USA' AND POPULATION > 100000",
                hint: "Use `WHERE condition1 AND condition2`."
            },
            {
                id: 5,
                category: "Employee",
                skill: "#where #or",
                difficulty: "Beginner",
                question: "Find employees who are in Group 1 OR have a salary < 1500.",
                expectedSQL: "SELECT * FROM Employee WHERE group_id = 1 OR salary < 1500",
                hint: "Use `WHERE ... OR ...`."
            },
            {
                id: 6,
                category: "CITY",
                skill: "#not",
                difficulty: "Beginner",
                question: "Query all cities that are NOT in the 'USA'.",
                expectedSQL: "SELECT * FROM CITY WHERE NOT COUNTRYCODE = 'USA'",
                hint: "Use `WHERE NOT` or `!=` or `<>`."
            },
            {
                id: 7,
                category: "Employee",
                skill: "#in",
                difficulty: "Intermediate",
                question: "Find employees whose group_id is 1, 2, or 3.",
                expectedSQL: "SELECT * FROM Employee WHERE group_id IN (1, 2, 3)",
                hint: "Use `WHERE column IN (val1, val2, ...)`."
            },
            {
                id: 8,
                category: "CITY",
                skill: "#between",
                difficulty: "Intermediate",
                question: "Query cities with population between 100,000 and 200,000.",
                expectedSQL: "SELECT * FROM CITY WHERE POPULATION BETWEEN 100000 AND 200000",
                hint: "Use `WHERE column BETWEEN x AND y`."
            },

            // --- NULL HANDLING ---
            {
                id: 9,
                category: "CITY",
                skill: "#is null",
                difficulty: "Intermediate",
                question: "Find cities where the DISTRICT is NULL (missing).",
                expectedSQL: "SELECT * FROM CITY WHERE DISTRICT IS NULL",
                hint: "Use `WHERE column IS NULL`. Cannot use `= NULL`."
            },
            {
                id: 10,
                category: "CITY",
                skill: "#is not null",
                difficulty: "Intermediate",
                question: "Find cities where the DISTRICT is NOT NULL.",
                expectedSQL: "SELECT * FROM CITY WHERE DISTRICT IS NOT NULL",
                hint: "Use `WHERE column IS NOT NULL`."
            },

            // --- PATTERN MATCHING ---
            {
                id: 11,
                category: "CITY",
                skill: "#like %",
                difficulty: "Intermediate",
                question: "Find cities starting with 'A'.",
                expectedSQL: "SELECT * FROM CITY WHERE NAME LIKE 'A%'",
                hint: "Use `LIKE 'A%'`. `%` matches any sequence."
            },
            {
                id: 12,
                category: "Employee",
                skill: "#like _",
                difficulty: "Intermediate",
                question: "Find employees whose name is exactly 4 characters long and starts with 'R'.",
                expectedSQL: "SELECT * FROM Employee WHERE name LIKE 'R___'",
                hint: "Use `LIKE 'R___'` (three underscores). `_` matches exactly one character."
            },

            // --- SORTING & LIMITS ---
            {
                id: 13,
                category: "Employee",
                skill: "#order #limit",
                difficulty: "Intermediate",
                question: "Find the top 3 highest paid employees.",
                expectedSQL: "SELECT * FROM Employee ORDER BY salary DESC LIMIT 3",
                hint: "Order descending and use `LIMIT 3`."
            },

            // --- STRING FUNCTIONS ---
            {
                id: 14,
                category: "CITY",
                skill: "#len",
                difficulty: "Intermediate",
                question: "Select city name and the length of the name (use LEN or CHAR_LENGTH).",
                expectedSQL: "SELECT NAME, LEN(NAME) FROM CITY",
                hint: "Use `LEN(column)`."
            },
            {
                id: 15,
                category: "Employee",
                skill: "#upper #lower",
                difficulty: "Intermediate",
                question: "Select employee names in all uppercase.",
                expectedSQL: "SELECT UPPER(name) FROM Employee",
                hint: "Use `UPPER(column)`."
            },
            {
                id: 16,
                category: "CITY",
                skill: "#substring",
                difficulty: "Intermediate",
                question: "Select the first 3 characters of each city name (use SUBSTRING, SUBSTR, or MID).",
                expectedSQL: "SELECT SUBSTRING(NAME, 1, 3) FROM CITY",
                hint: "Use `SUBSTRING(col, start, length)`."
            },
            {
                id: 17,
                category: "CITY",
                skill: "#trim",
                difficulty: "Intermediate",
                question: "Select all cities, but trim leading/trailing spaces from the NAME.",
                expectedSQL: "SELECT TRIM(NAME) FROM CITY",
                hint: "Use `TRIM(column)` to remove extra spaces."
            },
             {
                id: 18,
                category: "CITY",
                skill: "#space #concat",
                difficulty: "Intermediate",
                question: "Select Name and CountryCode combined with 3 spaces in between.",
                expectedSQL: "SELECT NAME + SPACE(3) + COUNTRYCODE FROM CITY",
                hint: "Use `SPACE(3)` and the `+` operator for concatenation."
            },

            // --- MATH FUNCTIONS ---
            {
                id: 19,
                category: "Employee",
                skill: "#abs",
                difficulty: "Intermediate",
                question: "Calculate the absolute difference between salary and 3000.",
                expectedSQL: "SELECT ABS(salary - 3000) FROM Employee",
                hint: "Use `ABS(expression)`."
            },
            {
                id: 20,
                category: "CITY",
                skill: "#int #floor",
                difficulty: "Intermediate",
                question: "Calculate population in thousands (divide by 1000) rounded down to an integer.",
                expectedSQL: "SELECT FLOOR(POPULATION / 1000) FROM CITY",
                hint: "Use `FLOOR(val)` or `INT(val)`."
            },

            // --- AGGREGATES ---
            {
                id: 21,
                category: "Employee",
                skill: "#count",
                difficulty: "Advanced",
                question: "Count total number of employees.",
                expectedSQL: "SELECT COUNT(*) FROM Employee",
                hint: "Use `COUNT(*)`."
            },
            {
                id: 22,
                category: "Employee",
                skill: "#sum",
                difficulty: "Advanced",
                question: "Calculate sum of all salaries.",
                expectedSQL: "SELECT SUM(salary) FROM Employee",
                hint: "Use `SUM(salary)`."
            },
            {
                id: 23,
                category: "Employee",
                skill: "#avg",
                difficulty: "Advanced",
                question: "Calculate average months of experience.",
                expectedSQL: "SELECT AVG(months) FROM Employee",
                hint: "Use `AVG(months)`."
            },
            {
                id: 24,
                category: "Employee",
                skill: "#min #max",
                difficulty: "Advanced",
                question: "Find the minimum and maximum salary.",
                expectedSQL: "SELECT MIN(salary), MAX(salary) FROM Employee",
                hint: "Use `MIN` and `MAX` separated by comma."
            },

            // --- GROUPING ---
            {
                id: 25,
                category: "CITY",
                skill: "#groupby",
                difficulty: "Advanced",
                question: "Count number of cities in each CountryCode.",
                expectedSQL: "SELECT COUNTRYCODE, COUNT(*) FROM CITY GROUP BY COUNTRYCODE",
                hint: "Use `GROUP BY COUNTRYCODE`."
            },
            {
                id: 26,
                category: "Employee",
                skill: "#groupby #avg",
                difficulty: "Advanced",
                question: "Calculate average salary for each group_id.",
                expectedSQL: "SELECT group_id, AVG(salary) FROM Employee GROUP BY group_id",
                hint: "Select group_id and AVG, then group by group_id."
            },
            {
                id: 27,
                category: "Employee",
                skill: "#having",
                difficulty: "Advanced",
                question: "Find group_ids where the average salary is > 3000.",
                expectedSQL: "SELECT group_id FROM Employee GROUP BY group_id HAVING AVG(salary) > 3000",
                hint: "Use `HAVING` after `GROUP BY` to filter aggregates."
            },

            // --- CHALLENGES & MIXED ---
            {
                id: 28,
                category: "Employee",
                skill: "#math #filter",
                difficulty: "Challenge",
                question: "Find employees whose salary is an even number (remainder of division by 2 is 0).",
                expectedSQL: "SELECT * FROM Employee WHERE salary % 2 = 0",
                hint: "Use the modulo operator `%`."
            },
            {
                id: 29,
                category: "CITY",
                skill: "#string #filter",
                difficulty: "Challenge",
                question: "Find cities where the name is longer than 10 characters.",
                expectedSQL: "SELECT * FROM CITY WHERE LEN(NAME) > 10",
                hint: "Use `WHERE LEN(NAME) > 10`."
            },
            {
                id: 30,
                category: "Employee",
                skill: "#complex",
                difficulty: "Challenge",
                question: "Find employees in Group 1 with salary > 2000 OR in Group 2 with salary > 3000.",
                expectedSQL: "SELECT * FROM Employee WHERE (group_id = 1 AND salary > 2000) OR (group_id = 2 AND salary > 3000)",
                hint: "Use parentheses to group logical conditions."
            },
            {
                id: 31,
                category: "CITY",
                skill: "#is null #or",
                difficulty: "Challenge",
                question: "Find cities where District is NULL or CountryCode is 'TST'.",
                expectedSQL: "SELECT * FROM CITY WHERE DISTRICT IS NULL OR COUNTRYCODE = 'TST'",
                hint: "Combine `IS NULL` with `OR`."
            },
            {
                id: 32,
                category: "Employee",
                skill: "#round",
                difficulty: "Challenge",
                question: "Show name and salary divided by 12, rounded to 0 decimals.",
                expectedSQL: "SELECT name, ROUND(salary / 12, 0) FROM Employee",
                hint: "Use `ROUND(val, 0)`."
            },
            {
                id: 33,
                category: "CITY",
                skill: "#count #distinct",
                difficulty: "Challenge",
                question: "Count how many unique CountryCodes exist in the table.",
                expectedSQL: "SELECT COUNT(DISTINCT COUNTRYCODE) FROM CITY",
                hint: "Use `COUNT(DISTINCT column)`."
            },
            {
                id: 34,
                category: "Employee",
                skill: "#string #wildcard",
                difficulty: "Challenge",
                question: "Find employees where the name contains 'a' as the second letter.",
                expectedSQL: "SELECT * FROM Employee WHERE name LIKE '_a%'",
                hint: "Use `_a%`."
            },
             {
                id: 35,
                category: "CITY",
                skill: "#logic #between",
                difficulty: "Challenge",
                question: "Find cities NOT in USA with population between 50k and 150k.",
                expectedSQL: "SELECT * FROM CITY WHERE COUNTRYCODE != 'USA' AND POPULATION BETWEEN 50000 AND 150000",
                hint: "Combine `!=` and `BETWEEN`."
            },
            {
                id: 36,
                category: "Employee",
                skill: "#calc #sort",
                difficulty: "Challenge",
                question: "List employees sorted by their salary per month (salary/months) descending.",
                expectedSQL: "SELECT * FROM Employee ORDER BY salary / months DESC",
                hint: "You can calculate in the ORDER BY clause."
            },
            {
                id: 37,
                category: "CITY",
                skill: "#avg #having",
                difficulty: "Challenge",
                question: "Show CountryCodes where the average population is less than 150,000.",
                expectedSQL: "SELECT COUNTRYCODE FROM CITY GROUP BY COUNTRYCODE HAVING AVG(POPULATION) < 150000",
                hint: "Use `GROUP BY` and `HAVING`."
            },
             {
                id: 38,
                category: "Employee",
                skill: "#alias",
                difficulty: "Challenge",
                question: "Select name and salary, renaming salary to 'Monthly_Pay'.",
                expectedSQL: "SELECT name, salary AS Monthly_Pay FROM Employee",
                hint: "Use `AS` keyword."
            },
             {
                id: 39,
                category: "Employee",
                skill: "#math #function",
                difficulty: "Challenge",
                question: "Find the square root of salary for employees in group 2.",
                expectedSQL: "SELECT SQRT(salary) FROM Employee WHERE group_id = 2",
                hint: "Use `SQRT(num)`."
            },
            {
                id: 40,
                category: "Employee",
                skill: "#master",
                difficulty: "Challenge",
                question: "Find the average salary of employees whose name starts with 'A', grouped by group_id.",
                expectedSQL: "SELECT group_id, AVG(salary) FROM Employee WHERE name LIKE 'A%' GROUP BY group_id",
                hint: "Filter first with WHERE, then GROUP BY."
            }
        ];

        // --- 3. APPLICATION STATE & LOGIC ---

        let currentLevelIndex = 0;
        let editor;
        let completedLevels = new Set();

        window.onload = function() {
            // Initialize CodeMirror
            editor = CodeMirror.fromTextArea(document.getElementById('sql-editor'), {
                mode: 'text/x-sql',
                theme: 'dracula',
                lineNumbers: true,
                smartIndent: true,
                extraKeys: {"Ctrl-Enter": runUserQuery}
            });

            renderLevelList();
            loadLevel(0);
        };

        function renderLevelList() {
            const listContainer = document.getElementById('content-practice');
            listContainer.innerHTML = '';
            
            levels.forEach((level, index) => {
                const isCompleted = completedLevels.has(level.id);
                const isActive = index === currentLevelIndex;
                
                const div = document.createElement('div');
                div.className = `p-3 rounded-md cursor-pointer text-sm flex items-center justify-between transition-colors ${
                    isActive ? 'bg-blue-100 border-blue-300 border text-blue-800' : 
                    'bg-white border border-transparent hover:bg-slate-50 hover:border-slate-200 text-slate-600'
                }`;
                div.onclick = () => loadLevel(index);

                // Add difficulty color badge
                let diffColor = "text-slate-400";
                if(level.difficulty === "Beginner") diffColor = "text-green-500";
                if(level.difficulty === "Intermediate") diffColor = "text-blue-500";
                if(level.difficulty === "Advanced") diffColor = "text-orange-500";
                if(level.difficulty === "Challenge") diffColor = "text-red-500";

                const left = document.createElement('div');
                left.className = "flex items-center gap-2";
                left.innerHTML = `<span class="font-bold w-5 text-slate-400 text-xs">${index + 1}.</span> 
                    <div class="flex flex-col">
                        <span class="truncate w-40 font-mono text-xs font-semibold text-slate-600">${level.skill}</span>
                        <span class="text-[10px] ${diffColor}">${level.difficulty}</span>
                    </div>`;

                const icon = document.createElement('i');
                if (isCompleted) {
                    icon.className = "fa-solid fa-check-circle text-green-500";
                } else {
                    icon.className = "fa-regular fa-circle text-slate-300";
                }

                div.appendChild(left);
                div.appendChild(icon);
                listContainer.appendChild(div);
            });

            document.getElementById('progress-text').innerText = `${completedLevels.size}/${levels.length} Completed`;
        }

        function loadLevel(index) {
            currentLevelIndex = index;
            const level = levels[index];
            
            document.getElementById('question-text').innerText = level.question;
            document.getElementById('current-table-badge').innerText = `${level.category} Table`;
            document.getElementById('current-table-badge').className = level.category === 'CITY' 
                ? 'bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded'
                : 'bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded';

            // Reset UI
            document.getElementById('status-msg').className = 'hidden mb-4 p-4 rounded-md border';
            document.getElementById('user-result-container').innerHTML = '<div class="p-8 text-center text-slate-400 italic">Run a query to see results</div>';
            
            editor.setValue("");
            editor.focus();
            
            // Re-render list to show active state
            renderLevelList();
            
            // Generate expected result silently
            try {
                const expectedRes = alasql(level.expectedSQL);
                renderTable(expectedRes, 'expected-result-container', true);
            } catch (e) {
                console.error("Error generating expected result:", e);
            }
        }

        function switchTab(tabName) {
            const practiceBtn = document.getElementById('tab-practice');
            const sheetBtn = document.getElementById('tab-cheatsheet');
            const practiceContent = document.getElementById('content-practice');
            const sheetContent = document.getElementById('content-cheatsheet');

            if (tabName === 'practice') {
                practiceBtn.classList.add('tab-active', 'bg-slate-50', 'text-blue-800');
                sheetBtn.classList.remove('tab-active', 'bg-slate-50', 'text-blue-800');
                
                practiceContent.classList.remove('hidden');
                sheetContent.classList.add('hidden');
            } else {
                sheetBtn.classList.add('tab-active', 'bg-slate-50', 'text-blue-800');
                practiceBtn.classList.remove('tab-active', 'bg-slate-50', 'text-blue-800');

                sheetContent.classList.remove('hidden');
                practiceContent.classList.add('hidden');
            }
        }

        function runUserQuery() {
            const userSQL = editor.getValue().trim();
            const statusDiv = document.getElementById('status-msg');
            
            if (!userSQL) {
                statusDiv.innerText = "Please enter a SQL query.";
                statusDiv.className = "block mb-4 p-4 rounded-md border bg-yellow-50 border-yellow-200 text-yellow-800";
                return;
            }

            try {
                // 1. Run User Query
                const userResult = alasql(userSQL);
                renderTable(userResult, 'user-result-container');

                // 2. Run Expected Query
                const level = levels[currentLevelIndex];
                const expectedResult = alasql(level.expectedSQL);

                // 3. Compare
                const isCorrect = JSON.stringify(userResult) === JSON.stringify(expectedResult);

                if (isCorrect) {
                    statusDiv.innerHTML = `<div class="flex items-center gap-2"><i class="fa-solid fa-check-circle text-green-600 text-xl"></i> <div><strong>Correct!</strong> Great job.</div></div>`;
                    statusDiv.className = "block mb-4 p-4 rounded-md border bg-green-50 border-green-200 text-green-800";
                    completedLevels.add(level.id);
                    renderLevelList();
                } else {
                    statusDiv.innerHTML = `<div class="flex flex-col gap-2">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-xmark-circle text-red-600 text-xl"></i> <div><strong>Incorrect.</strong> Your result doesn't match the expected output.</div></div>
                        <div class="text-sm bg-yellow-50 text-yellow-800 p-2 rounded border border-yellow-200 mt-1"><strong>Hint:</strong> ${level.hint}</div>
                    </div>`;
                    statusDiv.className = "block mb-4 p-4 rounded-md border bg-red-50 border-red-200 text-red-800";
                }

            } catch (err) {
                statusDiv.innerText = "SQL Error: " + err.message;
                statusDiv.className = "block mb-4 p-4 rounded-md border bg-red-50 border-red-200 text-red-800 font-mono text-sm";
                document.getElementById('user-result-container').innerHTML = '<div class="p-8 text-center text-red-400 italic">Query Failed</div>';
            }
        }

        function renderTable(data, containerId, isTruncated = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="p-4 text-slate-500 italic">Query returned no results.</div>';
                return;
            }

            if (typeof data[0] !== 'object') {
                data = data.map(val => ({ Result: val }));
            }

            const table = document.createElement('table');
            table.className = "min-w-full text-left text-sm whitespace-nowrap";
            
            let displayData = data;
            if (isTruncated && data.length > 3) {
                displayData = data.slice(0, 3);
            }

            const thead = document.createElement('thead');
            thead.className = "bg-slate-100 border-b border-slate-200 sticky top-0";
            const trHead = document.createElement('tr');
            
            Object.keys(displayData[0]).forEach(key => {
                const th = document.createElement('th');
                th.className = "px-4 py-2 font-semibold text-slate-600";
                th.innerText = key;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            displayData.forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = idx % 2 === 0 ? "bg-white" : "bg-slate-50";
                
                Object.values(row).forEach(val => {
                    const td = document.createElement('td');
                    td.className = "px-4 py-2 border-b border-slate-100 text-slate-700 font-mono";
                    td.innerText = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            if (isTruncated && data.length > 3) {
                const tr = document.createElement('tr');
                tr.className = "bg-slate-50 opacity-50";
                Object.keys(displayData[0]).forEach(() => {
                    const td = document.createElement('td');
                    td.className = "px-4 py-2 border-b border-slate-100 text-slate-700 font-mono italic";
                    td.innerText = "...";
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
                
                const trInfo = document.createElement('tr');
                const tdInfo = document.createElement('td');
                tdInfo.colSpan = Object.keys(displayData[0]).length;
                tdInfo.className = "px-4 py-2 text-xs text-slate-400 text-center bg-slate-50";
                tdInfo.innerText = `(${data.length - 3} more rows hidden)`;
                trInfo.appendChild(tdInfo);
                tbody.appendChild(trInfo);
            }

            table.appendChild(tbody);
            container.appendChild(table);
        }

        function resetLevel() {
            editor.setValue("");
            document.getElementById('status-msg').classList.add('hidden');
            document.getElementById('user-result-container').innerHTML = '<div class="p-8 text-center text-slate-400 italic">Run a query to see results</div>';
        }

        function toggleSchema() {
            const modal = document.getElementById('schema-modal');
            modal.classList.toggle('hidden');
        }

    </script>
</body>
</html>
