<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Hero: Time Attack V31</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    
    <style>
        :root { --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: var(--font-main); height: 100vh; display: flex; flex-direction: column; }

        /* BACKGROUNDS */
        #bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; transition: background 1s ease; }
        .bg-lvl-1 { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); }
        .bg-lvl-2 { background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); }
        .bg-lvl-3 { background: linear-gradient(to bottom, #320b35, #000000); }
        .bg-lvl-4 { background: linear-gradient(to bottom, #480048, #C04848); }
        .bg-lvl-5 { background: linear-gradient(to bottom, #23074d, #cc5333); }
        .bg-lvl-6 { background: radial-gradient(circle at center, #000000 0%, #2c3e50 100%); }
        .bg-lvl-7 { background: linear-gradient(135deg, #000000 0%, #434343 100%); } /* THE END */
        .bg-clear { background: linear-gradient(to bottom, #FFD700, #FF8C00); } /* VICTORY */

        /* UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; z-index: 10; }
        .hud-top { display: flex; justify-content: space-between; align-items: center; }
        .stat-grp { display: flex; gap: 10px; }
        .stat-box { background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); font-weight: bold; display: flex; align-items: center; gap: 5px; backdrop-filter: blur(5px); }
        .bar-cont { width: 80px; height: 8px; background: rgba(255,255,255,0.2); border-radius: 5px; overflow: hidden; margin-left: 8px; }
        #lvl-bar { height: 100%; background: #facc15; width: 0%; transition: width 0.3s; }
        .lvl-badge { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: linear-gradient(90deg, #ff8a00, #e52e71); padding: 5px 15px; border-radius: 10px; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; box-shadow: 0 0 15px rgba(229, 46, 113, 0.5); text-align: center; white-space: nowrap; }

        #game-cvs { display: block; width: 100%; flex-grow: 1; }

        /* CONTROLS */
        #ctrl-panel { flex-shrink: 0; min-height: 35vh; background: rgba(15, 23, 42, 0.98); border-top: 3px solid #334155; padding: 10px; display: flex; flex-direction: column; align-items: center; z-index: 20; padding-bottom: env(safe-area-inset-bottom); }
        #q-box { width: 100%; max-width: 700px; background: #1e293b; border-radius: 12px; padding: 10px; margin-bottom: 10px; text-align: center; border: 1px solid #475569; position: relative; min-height: 70px; display: flex; flex-direction: column; justify-content: center; }
        .q-lbl { color: #94a3b8; font-size: 0.8rem; text-transform: uppercase; margin-bottom: 5px; }
        .math-txt { font-size: 1.3rem; color: #e2e8f0; line-height: 1.2; overflow-wrap: break-word; }
        
        /* FEEDBACK */
        #fb-ol { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 30; border-radius: 12px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; padding: 15px; backdrop-filter: blur(4px); opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        #fb-ol.active { opacity: 1; pointer-events: auto; }
        .fb-t { font-weight: bold; margin-bottom: 5px; color: #f87171; font-size: 1.3rem; }
        .fb-r { color: #fbbf24; font-size: 1.1rem; }

        #ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 700px; flex-grow: 1; }
        .ans-btn { background: linear-gradient(145deg, #334155, #1e293b); border: 2px solid #475569; border-radius: 12px; color: white; cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center; padding: 5px; font-size: 1rem; }
        .ans-btn:active { transform: scale(0.96); }
        .ans-btn.cor { background: #059669 !important; border-color: #34d399 !important; box-shadow: 0 0 15px #34d399; }
        .ans-btn.err { background: #dc2626 !important; border-color: #f87171 !important; opacity: 0.5; }

        /* MENUS */
        .menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 10, 0.98); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .hidden { display: none !important; }
        h1 { font-size: 2.5rem; background: linear-gradient(to right, #4facfe, #00f2fe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        input { background: rgba(255,255,255,0.1); border: 2px solid #475569; color: white; padding: 10px; font-size: 16px; border-radius: 30px; margin: 10px; text-align: center; width: 250px; outline: none; }
        input:focus { border-color: #60a5fa; }
        .hero-grid { display: flex; gap: 10px; margin: 15px 0; justify-content: center; flex-wrap: wrap; }
        .hero-opt { font-size: 2rem; cursor: pointer; padding: 8px; border-radius: 50%; border: 2px solid transparent; background: rgba(255,255,255,0.1); transition: 0.2s; }
        .hero-opt.sel { border-color: #facc15; background: rgba(250, 204, 21, 0.2); }
        .btn { background: linear-gradient(90deg, #4f46e5, #7c3aed); border: none; padding: 12px 30px; font-size: 1.2rem; color: white; border-radius: 50px; cursor: pointer; margin-top: 10px; font-weight: bold; box-shadow: 0 5px 15px rgba(124,58,237,0.4); min-width: 120px; }
        
        .log { background: #1e293b; width: 100%; max-width: 600px; max-height: 40vh; overflow-y: auto; border-radius: 10px; margin: 15px 0; border: 1px solid #334155; font-size: 0.9rem; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #334155; color: #cbd5e1; }
        th { background: #0f172a; position: sticky; top: 0; }
        .red { color: #fca5a5; } .grn { color: #86efac; }

        @media (max-width: 600px) { 
            #ctrl-panel { min-height: 40vh; } .q-lbl { display: none; } 
            #q-box { min-height: 60px; padding: 5px; margin-bottom: 5px; }
            .ans-btn { font-size: 0.9rem; } 
        }
    </style>
</head>
<body>

<div id="bg-layer" class="bg-lvl-1"></div>

<div id="ui-layer">
    <div class="hud-top">
        <div class="stat-grp">
            <div class="stat-box" style="color: #ef4444;">‚ù§Ô∏è <span id="hp-val">3</span></div>
            <div class="stat-box"><span id="lvl-txt">LVL 1</span><div class="bar-cont"><div id="lvl-bar"></div></div></div>
        </div>
        <div class="stat-box" style="color: #facc15;">üèÜ <span id="sc-val">0</span></div>
    </div>
    <div id="lvl-badge" class="lvl-badge">FOREST</div>
</div>

<canvas id="game-cvs"></canvas>

<div id="ctrl-panel">
    <div id="q-box">
        <div id="fb-ol">
            <div class="fb-t">TRAP!</div>
            <div class="fb-r" id="fb-text">...</div>
        </div>
        <span class="q-lbl">SOLVE TO ATTACK</span>
        <div id="math-q" class="math-txt">...</div>
    </div>
    <div id="ans-grid">
        <button class="ans-btn" id="b0"></button>
        <button class="ans-btn" id="b1"></button>
        <button class="ans-btn" id="b2"></button>
        <button class="ans-btn" id="b3"></button>
    </div>
</div>

<!-- INTRO -->
<div id="scr-intro" class="menu">
    <h1>Math Hero</h1>
    <p>Select Hero</p>
    <div class="hero-grid">
        <div class="hero-opt sel" onclick="Game.setHero(this,'üßù')">üßù</div>
        <div class="hero-opt" onclick="Game.setHero(this,'üßô‚Äç‚ôÇÔ∏è')">üßô‚Äç‚ôÇÔ∏è</div>
        <div class="hero-opt" onclick="Game.setHero(this,'ü¶∏')">ü¶∏</div>
        <div class="hero-opt" onclick="Game.setHero(this,'ü§ñ')">ü§ñ</div>
        <div class="hero-opt" onclick="Game.setHero(this,'üßõ')">üßõ</div>
        <div class="hero-opt" onclick="Game.setHero(this,'üêâ')">üêâ</div>
    </div>
    <input type="text" id="p-name" placeholder="Enter Name">
    <button class="btn" onclick="Game.checkStart()">BATTLE START</button>
</div>

<!-- END -->
<div id="scr-end" class="menu hidden">
    <h1 id="end-title">GAME OVER</h1>
    <p>Hero: <span id="end-name" style="color:#60a5fa"></span></p>
    <h3>Score: <span id="end-score">0</span></h3>
    <div class="log">
        <table id="log-tbl"><thead><tr><th>Q</th><th>You</th><th>Ans</th><th>Trap</th></tr></thead><tbody id="log-body"></tbody></table>
    </div>
    <div style="display:flex; gap:10px; flex-wrap: wrap; justify-content: center;">
        <button class="btn" style="background:#059669" onclick="Game.export()">üíæ Save</button>
        <button class="btn" id="btn-restart" onclick="Game.tryRestart()">‚Üª Retry</button>
        <button class="btn" style="background:#64748b" onclick="Game.restart()">üè† Menu</button>
    </div>
</div>

<script>
/** SYMBOLIC ENGINE */
const Sym = {
    term: (c, vars={}) => ({c, v: vars}),
    mult: (t1, t2) => {
        let newC = t1.c * t2.c;
        let newV = {...t1.v};
        for(let k in t2.v) newV[k] = (newV[k] || 0) + t2.v[k];
        return {c: newC, v: newV};
    },
    v: (char) => ({[char]: 1}),
    fmtTerm: (t, isFirst) => {
        if(t.c === 0) return "";
        let s = "";
        if(t.c < 0) s += "-"; else if(!isFirst) s += "+";
        let absC = Math.abs(t.c);
        let vars = t.v || {};
        let keys = Object.keys(vars).sort();
        let hasVars = keys.length > 0;
        if(absC !== 1 || !hasVars) s += absC;
        for(let k of keys) { let p = vars[k]; if(p === 1) s += k; else if(p > 1) s += `${k}^${p}`; }
        return s;
    },
    poly: (terms, shuffle=false) => {
        let work = terms.filter(t => t.c !== 0);
        if(shuffle && Math.random() > 0.4) work.sort(() => Math.random() - 0.5);
        let out = "";
        work.forEach((t, i) => {
            let str = Sym.fmtTerm(t, i===0);
            if(i > 0) { if(str.startsWith("+")) str = " + " + str.substring(1); else if(str.startsWith("-")) str = " - " + str.substring(1); }
            out += str;
        });
        return out || "0";
    }
};

const Utils = {
    bags: {},
    rand: (min, max) => {
        let key = `${min}-${max}`;
        if(!Utils.bags[key] || Utils.bags[key].length === 0) {
            Utils.bags[key] = [];
            for(let i=min; i<=max; i++) if(i!==0) Utils.bags[key].push(i);
            Utils.bags[key].sort(() => Math.random() - 0.5);
        }
        return Utils.bags[key].pop();
    },
    randBool: () => Math.random() > 0.5,
    gcd: (a,b) => { a=Math.abs(a); b=Math.abs(b); while(b){let t=b;b=a%b;a=t} return a; },
    gcd3: (a,b,c) => Utils.gcd(a, Utils.gcd(b,c)),
    vars: () => [['x','y'], ['a','b'], ['m','n'], ['p','q']][Math.floor(Math.random()*4)],
    norm: (s) => {
        if (!s) return ""; s = s.replace(/\s+/g,""); 
        let k = (s.match(/^([^(]+)/) || ["",""])[1];
        let facts = s.match(/\([^)]+\)/g);
        if(!facts) return s;
        return k + facts.sort().join("");
    },
    fmt: (c,v) => { let abs = Math.abs(c); if(abs===1 && v) return v; return `${abs}${v}`; }
};

const Gen = {
    history: [],
    decks: {},
    isUnique: (q) => {
        if(Gen.history.includes(q)) return false;
        Gen.history.push(q); if(Gen.history.length>30) Gen.history.shift();
        return true;
    },
    getDeck: (lvl, types) => {
        if(!Gen.decks[lvl] || Gen.decks[lvl].length === 0) Gen.decks[lvl] = [...types].sort(() => Math.random() - 0.5);
        return Gen.decks[lvl].pop();
    },
    generate: (lvl, fn) => {
        let res, tries=0;
        do { res=fn(); tries++; } while(!Gen.isUnique(res.q) && tries<30);
        return res;
    },

    // L1: Common
    getL1: () => {
        let k = Utils.rand(2,6)*(Utils.randBool()?1:-1);
        let [x,y] = Utils.vars();
        let is3 = Utils.randBool();
        let tAns = [], tQ = [];
        
        if(is3) {
            let a=Utils.rand(1,3), b=Utils.rand(1,4), c=Utils.rand(1,5);
            while(Utils.gcd3(a,b,c)>1) b++;
            tAns = [Sym.term(a, Sym.v(x)), Sym.term(b, Sym.v(y)), Sym.term(c, {})];
        } else {
            let a=Utils.rand(1,5), b=Utils.rand(1,9);
            while(Utils.gcd(a,b)>1) b++;
            tAns = [Sym.term(a, Sym.v(x)), Sym.term(b, {})];
        }
        for(let t of tAns) tQ.push(Sym.mult(t, {c:k, v:{}}));
        let qStr = `\\text{Factorize: } ${Sym.poly(tQ, true)}`;
        let aStr = `${k}(${Sym.poly(tAns, false)})`;
        
        let d1 = `${k}(${Sym.poly(tAns.slice(0, tAns.length-1), false)})`;
        let d2 = `${Math.abs(k)}(${Sym.poly(tAns, false)})`;
        return { q: qStr, a: aStr, ds: [{v:d1, r:"Missing term"}, {v:d2, r:"Sign Error"}] };
    },

    // L2: Identities
    getL2: () => {
        let [x] = ['x'];
        if(Utils.randBool()) { 
            let a=Utils.rand(1,4), b=Utils.rand(2,7); while(Utils.gcd(a,b)>1) b++;
            let t1 = Sym.term(a*a, {x:2}), t2 = Sym.term(-(b*b), {});
            let qStr = `\\text{Factorize: } ${Sym.poly([t1,t2], true)}`;
            let ax = a===1?'x':`${a}x`;
            return { q: qStr, a: `(${ax}+${b})(${ax}-${b})`, ds: [{v:`(${ax}-${b})^2`, r:"Diff of Sq ‚â† (a-b)¬≤"}, {v:`(${a*a}x+${b})(${a*a}x-${b})`, r:"Square root needed"}] };
        } else {
            let a=Utils.rand(1,7), s=Utils.randBool()?1:-1;
            let t1 = Sym.term(1,{x:2}), t2 = Sym.term(2*a*s,{x:1}), t3 = Sym.term(a*a,{});
            return { q: `\\text{Expand: } (x ${s>0?'+':'-'} ${a})^2`, a: Sym.poly([t1,t2,t3], false), ds: [{v:Sym.poly([t1,t3]), r:"Missing 2ab"}, {v:Sym.poly([t1,{c:a*s,v:{x:1}},t3]), r:"Coeff Error"}] };
        }
    },

    // L3: Cross
    getL3: () => {
        let p=Utils.rand(-6,6), q=Utils.rand(-6,6); if(p===0)p=1; if(q===0)q=2;
        let sum=p+q, prod=p*q;
        let t1=Sym.term(1,{x:2}), t2=Sym.term(sum,{x:1}), t3=Sym.term(prod,{});
        return { q: `\\text{Factorize: } ${Sym.poly([t1,t2,t3], true)}`, a: `(x ${p>0?'+':''}${p})(x ${q>0?'+':''}${q})`, ds: [{v:`(x ${-p>0?'+':''}${-p})(x ${-q>0?'+':''}${-q})`, r:"Sign Error"}, {v:`(x ${sum>0?'+':''}${sum})(x ${prod>0?'+':''}${prod})`, r:"Used sum as root"}] };
    },

    // L4: Mixed
    getL4: () => {
        let type = Gen.getDeck(4, ['kDiff', 'kCross', 'kPerf']);
        let k=Utils.rand(2,4)*(Utils.randBool()?1:-1);
        let res = {};
        if(type==='kDiff') { 
            let a=Utils.rand(2,4);
            let t1=Sym.term(k,{x:2}), t2=Sym.term(k*(-a*a),{});
            res = { q: `\\text{Factorize: } ${Sym.poly([t1,t2], true)}`, a: `${k}(x+${a})(x-${a})`, ds: [{v:`${k}(x-${a})^2`, r:"Not (a-b)¬≤"}, {v:`(x+${a})(x-${a})`, r:"Forgot k"}] };
        } else if(type==='kCross') {
            let p=2, q=-3;
            let t1=Sym.term(k,{x:2}), t2=Sym.term(k*(p+q),{x:1}), t3=Sym.term(k*p*q,{});
            res = { q: `\\text{Factorize: } ${Sym.poly([t1,t2,t3], true)}`, a: `${k}(x+2)(x-3)`, ds: [{v:`${k}(x-2)(x+3)`, r:"Sign Error"}, {v:`(x+2)(x-3)`, r:"Forgot k"}] };
        } else { 
            let a=3, s=1;
            let t1=Sym.term(k,{x:2}), t2=Sym.term(k*2*a*s,{x:1}), t3=Sym.term(k*a*a,{});
            res = { q: `\\text{Factorize: } ${Sym.poly([t1,t2,t3], true)}`, a: `${k}(x+3)^2`, ds: [{v:`${k}(x-3)^2`, r:"Sign Error"}, {v:`(x+3)^2`, r:"Forgot k"}] };
        }
        return res;
    },

    // L5: Inferno
    getL5: () => {
        let type = Gen.getDeck(5, ['expSq', 'expDiff', 'x4', 'x3']);
        let [x] = Utils.vars();
        if(type === 'expSq') { // 3(x-2)^2
            let k=Utils.rand(2,3), a=Utils.rand(2,4), s=Utils.randBool()?1:-1;
            let t1=Sym.term(k,{[x]:2}), t2=Sym.term(k*2*a*s,{[x]:1}), t3=Sym.term(k*a*a,{});
            return { q: `\\text{Expand: } ${k}(${x} ${s>0?'+':'-'} ${a})^2`, a: Sym.poly([t1,t2,t3], false), ds: [{v:Sym.poly([t1,{c:2*a*s,v:{[x]:1}},{c:a*a,v:{}}], false), r:"Forgot k"}, {v:Sym.poly([t1,t3], false), r:"Missing 2ab"}] };
        } else if (type === 'expDiff') { // 2(x+3)(x-3)
            let k=Utils.rand(2,3), a=Utils.rand(2,5);
            let t1=Sym.term(k,{[x]:2}), t2=Sym.term(k*(-a*a),{});
            return { q: `\\text{Expand: } ${k}(${x}+${a})(${x}-${a})`, a: Sym.poly([t1,t2], false), ds: [{v:Sym.poly([t1, {c:a*a*k, v:{}}]), r:"Sign Error"}, {v:`${k}(${x}^2-${a*a})`, r:"Unfinished Expansion"}] };
        } else if (type === 'x4') { // x^4 - 16
            let a=Utils.rand(2,3), a2=a*a, a4=a2*a2;
            let t1 = Sym.term(1, {[x]:4}), t2 = Sym.term(-a4, {});
            return { q: `\\text{Factorize: } ${Sym.poly([t1,t2], true)}`, a: `(${x}^2+${a2})(${x}+${a})(${x}-${a})`, ds: [{v:`(${x}^2+${a2})(${x}^2-${a2})`, r:"Incomplete"}, {v:`(${x}^2-${a2})^2`, r:"Formula Error"}] };
        } else { // x^3 - 4x
            let a=Utils.rand(2,5), a2=a*a;
            let t1 = Sym.term(1, {[x]:3}), t2 = Sym.term(-a2, {[x]:1});
            return { q: `\\text{Factorize: } ${Sym.poly([t1,t2], true)}`, a: `${x}(${x}+${a})(${x}-${a})`, ds: [{v:`${x}(${x}^2-${a2})`, r:"Incomplete"}, {v:`${x}(${x}-${a})^2`, r:"Not (a-b)¬≤"}] };
        }
    },

    // L6: Abyss
    getL6: () => { 
        let type = Gen.getDeck(6, ['group', '5term', 'expand']);
        if(type === 'expand') { // (a+b)(x+y)
            let [v1,v2] = Utils.vars(); let [c1,c2] = Utils.vars(); if(c1===v1) c1='z'; if(c2===v2) c2='w';
            let t1={c:1,v:{[v1]:1,[v2]:1}}, t2={c:1,v:{[v1]:1,[c1]:1}}, t3={c:1,v:{[c2]:1,[v2]:1}}, t4={c:1,v:{[c2]:1,[c1]:1}};
            return { q: `\\text{Expand: } (${v1}+${c2})(${v2}+${c1})`, a: Sym.poly([t1,t2,t3,t4], false), ds: [{v:Sym.poly([t1,t4]), r:"Missing terms"}, {v:Sym.poly([t1,t2,t3,{c:-1,v:{[c2]:1,[c1]:1}}]), r:"Sign Error"}]};
        } else if(type === 'group') { // ax + ay + nx + ny
            let [v1,v2] = Utils.vars(); let [c1,c2] = Utils.vars(); if(c1===v1) c1='z';
            let n = -Utils.rand(2,5);
            let t1={c:1,v:{[c1]:1,[v1]:1}}, t2={c:1,v:{[c1]:1,[v2]:1}}, t3={c:n,v:{[v1]:1}}, t4={c:n,v:{[v2]:1}};
            return { q: `\\text{Factorize: } ${Sym.poly([t1,t2,t3,t4], true)}`, a: `(${c1}${n})(${v1}+${v2})`, ds: [{v:`(${c1}+${v1})(${n}+${v2})`, r:"Bad Grouping"}, {v:`${c1}(${v1}+${v2})+${n}(${v1}+${v2})`, r:"Unfinished"}] };
        } else { // x^2 + 2xy + y^2 - a^2
            let [x,y] = Utils.vars(); let a=Utils.rand(2,5), a2=a*a;
            let t1=Sym.term(1,{[x]:2}), t2=Sym.term(2,{[x]:1,[y]:1}), t3=Sym.term(1,{[y]:2}), t4=Sym.term(-a2,{});
            return { q: `\\text{Factorize: } ${Sym.poly([t1,t2,t3,t4], true)}`, a: `(${x}+${y}+${a})(${x}+${y}-${a})`, ds: [{v:`(${x}+${y}-${a})^2`, r:"Diff of Sq"}, {v:`(${x}+${y})^2-${a2}`, r:"Unfinished"}] };
        }
    },

    // L7: The End
    getL7: (qIndex) => {
        if(qIndex < 3) return Gen.getL4(); 
        if(qIndex < 6) return Gen.getL5();
        if(qIndex < 9) return Gen.getL6();

        if(Math.random() > 0.5) {
            let [x,y] = Utils.vars();
            let t1=Sym.term(1,{[x]:2}), t2=Sym.term(-1,{[y]:2}), t3=Sym.term(1,{[x]:1}), t4=Sym.term(-1,{[y]:1});
            return {
                q: `\\text{Factorize: } ${Sym.poly([t1,t2,t3,t4], true)}`,
                a: `(${x}-${y})(${x}+${y}+1)`,
                ds: [{v:`(${x}-${y})(${x}+${y})`, r:"Missing +1"}, {v:`(${x}+${y})(${x}-${y}+1)`, r:"Sign Error"}]
            };
        } else {
            let [x,y] = Utils.vars(); let a='a', b='b';
            return {
                q: `\\text{Factorize: } ax+ay+az+bx+by+bz`,
                a: `(a+b)(x+y+z)`,
                ds: [{v:`(a+x)(b+y+z)`, r:"Grouping Logic"}, {v:`a(x+y+z)+b(x+y+z)`, r:"Unfinished"}]
            };
        }
    }
};

// --- GAME ---
const Game = {
    state: 0, lvl:1, qN:0, sc:0, hp:3, pName:"Hero", pChar:"üßù", qD:null, curOpts:[], log:[],
    lvls: [20, 20, 30, 45, 60, 90, 120],

    setHero: (e,c) => { document.querySelectorAll('.hero-opt').forEach(x=>x.classList.remove('sel')); e.classList.add('sel'); Game.pChar=c; },
    checkStart: () => {
        let t = document.getElementById('p-name').value.trim();
        Game.pName = t || "Hero";
        let m = t.match(/level\s*(\d)/i);
        Game.run(m && m[1]>=1 && m[1]<=7 ? parseInt(m[1]) : 1);
    },
    run: (l) => {
        document.getElementById('scr-intro').classList.add('hidden'); document.getElementById('scr-end').classList.add('hidden');
        Game.lvl=l; Game.sc=(l-1)*1000; Game.hp=3; Game.qN=0; Game.log=[]; Game.state=1; 
        Renderer.hero.c = Game.pChar; Renderer.start(); Game.updEnv(); Game.nextQ(); 
    },
    restart: () => { document.getElementById('scr-intro').classList.remove('hidden'); document.getElementById('scr-end').classList.add('hidden'); },
    tryRestart: () => {
        let target = Math.max(1, Game.lvl - 1); 
        if(Game.hp > 0 && Game.lvl >= 7) target = 1; 
        else if (Game.lvl === 1) target = 1;
        Game.run(target);
    },
    updEnv: () => {
        let bgL = Math.min(Game.lvl, 7);
        document.getElementById('bg-layer').className = (Game.lvl>7) ? 'bg-clear' : `bg-lvl-${bgL}`;
        document.getElementById('lvl-badge').innerText = ["FOREST","SPACE","CYBER","VOID","INFERNO","ABYSS","THE END"][bgL-1] || "VICTORY";
        Renderer.setBg(bgL);
    },
    nextQ: () => {
        if(Game.state !== 1) return;
        let maxQ = Game.lvl===7 ? 10 : 5;
        if(Game.qN >= maxQ) { 
            if(Game.lvl<7){Game.lvl++; Game.qN=0; if(Game.hp<3)Game.hp++; Game.updEnv();} 
            else {Game.victory(); return;} 
        }
        
        let gen;
        if(Game.lvl === 7) gen = () => Gen.getL7(Game.qN); 
        else gen = [Gen.getL1, Gen.getL2, Gen.getL3, Gen.getL4, Gen.getL5, Gen.getL6][Game.lvl-1];
        
        let raw = Gen.generate(Game.lvl, gen);
        
        let opts = [{v:raw.a, ok:true}];
        let seen = new Set([Utils.norm(raw.a)]);
        for(let d of raw.ds) {
            let n = Utils.norm(d.v);
            if(!seen.has(n)) { opts.push({v:d.v, ok:false, r:d.r}); seen.add(n); }
        }
        while(opts.length<4) {
            let fake = raw.a.replace(/\+/g,"TEMP").replace(/-/g,"+").replace(/TEMP/g,"-");
            if(seen.has(Utils.norm(fake))) fake = raw.a + " + 1";
            opts.push({v:fake, ok:false, r:"Calc Error"}); seen.add(Utils.norm(fake));
        }
        Game.qD = {q:raw.q, a:raw.a}; Game.curOpts = opts.sort(()=>Math.random()-0.5);
        
        katex.render(Game.qD.q, document.getElementById('math-q'), {displayMode:true});
        document.querySelectorAll('.ans-btn').forEach((b,i) => {
            b.className='ans-btn'; b.disabled=false; b.innerHTML="";
            try{ katex.render(Game.curOpts[i].v, b); } catch(e){ b.innerText=Game.curOpts[i].v; }
            b.onclick = ()=>Game.click(i);
        });
        Game.updUI(); 
        Renderer.spawn(); 
    },
    click: (i) => {
        if(Game.state!==1) return;
        let sel = Game.curOpts[i], btns = document.querySelectorAll('.ans-btn');
        if(sel.ok) {
            btns[i].classList.add('cor'); Game.sc+=100; Game.qN++; Renderer.atk(); Game.state=2;
            btns.forEach(b=>b.disabled=true); setTimeout(()=>{Game.state=1; Game.nextQ();},1000);
        } else {
            Game.state=2; Game.hp--; Game.log.push({q:Game.qD.q, y:sel.v, a:Game.qD.a, r:sel.r||"Error"});
            btns[i].classList.add('err');
            Game.curOpts.forEach((o,k)=>{if(o.ok)btns[k].classList.add('cor');});
            document.getElementById('fb-text').innerText = sel.r;
            document.getElementById('fb-ol').classList.add('active'); Renderer.hit(); Game.updUI();
            setTimeout(()=>{ document.getElementById('fb-ol').classList.remove('active'); if(Game.hp<=0)Game.over(); else{Game.state=1;Game.nextQ();} },2500);
        }
    },
    timeOut: () => {
        if(Game.state!==1) return;
        Game.hp--; Game.log.push({q:Game.qD.q, y:"Time Up", a:Game.qD.a, r:"Too Slow"}); Renderer.hit(); Game.updUI();
        if(Game.hp<=0) Game.over(); else Renderer.spawn(); 
    },
    over: () => {
        Game.state=3; document.getElementById('scr-end').classList.remove('hidden');
        document.getElementById('end-title').innerText = "GAME OVER";
        document.getElementById('end-title').style.color = "#ef4444";
        document.getElementById('end-name').innerText = Game.pName; document.getElementById('end-score').innerText = Game.sc;
        document.getElementById('btn-restart').innerText = `‚Üª Retry Lv ${Math.max(1, Game.lvl-1)}`;
        Game.fillLog();
    },
    victory: () => {
        Game.state=3; document.getElementById('scr-end').classList.remove('hidden');
        document.getElementById('end-title').innerText = "MISSION COMPLETE!";
        document.getElementById('end-title').style.color = "#facc15";
        document.getElementById('end-name').innerText = Game.pName; document.getElementById('end-score').innerText = Game.sc;
        document.getElementById('btn-restart').innerText = "‚Üª Play Again";
        Game.fillLog();
    },
    fillLog: () => {
        let tb=document.getElementById('log-body'), p=s=>s.replace(/\\text\{(.*?)\}/g,"$1: ").replace(/\\/g,"");
        tb.innerHTML=""; Game.log.forEach(m=>{let r=document.createElement('tr'); r.innerHTML=`<td>${p(m.q)}</td><td class="red">${p(m.y)}</td><td class="grn">${p(m.a)}</td><td>${m.r}</td>`; tb.appendChild(r);});
    },
    updUI: () => {
        let maxQ = Game.lvl===7 ? 10 : 5;
        document.getElementById('sc-val').innerText=Game.sc; document.getElementById('hp-val').innerText=Game.hp;
        document.getElementById('lvl-txt').innerText=`LVL ${Game.lvl}`; document.getElementById('lvl-bar').style.width=`${(Game.qN/maxQ)*100}%`;
    },
    export: () => {
        if(!Game.log.length) return alert("No data!");
        let c=document.createElement('canvas'), ctx=c.getContext('2d'), w=1000, h=140+Game.log.length*90+50;
        c.width=w; c.height=h;
        let g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,"#0f172a"); g.addColorStop(1,"#1e293b");
        ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
        ctx.fillStyle="#60a5fa"; ctx.font="bold 48px Arial"; ctx.textAlign="center"; ctx.fillText("BATTLE REPORT",w/2,60);
        ctx.fillStyle="#e2e8f0"; ctx.font="24px Arial"; ctx.fillText(`Hero: ${Game.pName} | Score: ${Game.sc}`,w/2,110);
        let y=180, p=s=>s.replace(/\\text\{(.*?)\}/g,"$1: ").replace(/\\/g,""); ctx.textAlign="left";
        Game.log.forEach((m,i)=>{
            if(i%2===0){ctx.fillStyle="rgba(255,255,255,0.05)"; ctx.fillRect(20,y-50,w-40,90);}
            ctx.fillStyle="white"; ctx.font="bold 22px Arial"; ctx.fillText(p(m.q),40,y-15);
            ctx.fillStyle="#f87171"; ctx.font="18px Arial"; ctx.fillText(`‚úó ${p(m.y)}`,40,y+20); 
            ctx.fillStyle="#4ade80"; ctx.fillText(`‚úì ${p(m.a)}`,350,y+20);
            ctx.fillStyle="#fbbf24"; ctx.fillText(`‚ö† ${m.r}`,650,y+20);
            y+=90;
        });
        let l=document.createElement('a'); l.download=`Report_${Game.pName}.png`; l.href=c.toDataURL(); l.click();
    }
};

// --- RENDERER ---
const Renderer = {
    cvs: document.getElementById('game-cvs'), ctx: null, cw:0, ch:0, id:0, init:false,
    hero:{x:100,y:0,c:"üßù",s:0}, en:{x:1000,y:0,c:"üêâ", dead:false}, bgs:[], parts:[],
    stop:()=>{if(Renderer.id)cancelAnimationFrame(Renderer.id);},
    start:()=>{ Renderer.stop(); if(!Renderer.init){Renderer.ctx=Renderer.cvs.getContext('2d'); window.onresize=Renderer.resize; Renderer.init=true;} Renderer.resize(); Renderer.loop(); },
    resize:()=>{ Renderer.cw=Renderer.cvs.clientWidth; Renderer.ch=Renderer.cvs.clientHeight; Renderer.cvs.width=Renderer.cw; Renderer.cvs.height=Renderer.ch; Renderer.hero.y=Renderer.ch*0.65; Renderer.en.y=Renderer.ch*0.65; },
    setBg:(l)=>{
        Renderer.bgs=[]; let n=(l===2?50:20);
        let type = l===1?'tree':(l===2?'star':(l===3?'grid':(l===4?'shard':(l===5?'fire':(l===6?'orb':'void')))));
        for(let i=0;i<n;i++) Renderer.bgs.push({t:type, x:Math.random()*Renderer.cw, y:Math.random()*Renderer.ch, s:Math.random()*20+5, sp:Math.random()+0.5});
    },
    spawn:()=>{ 
        const pools = [
            ["üê∫", "üêª", "üêó", "üå≤"], ["üëΩ", "üëæ", "üõ∏", "ü™ê"], ["ü§ñ", "ü¶æ", "ü¶ø", "üíæ"], 
            ["üëª", "üíÄ", "ü¶á", "üï∏Ô∏è"], ["üëø", "üî•", "üåã", "üë∫"], ["üêô", "ü¶à", "ü¶Ä", "üåä"], ["üê≤", "üëë", "üëÅÔ∏è", "üåü"]
        ];
        let p = pools[Math.min(Game.lvl-1, 6)];
        Renderer.en.c = p[Math.floor(Math.random() * p.length)]; 
        Renderer.en.x = Renderer.cw + 50; 
        Renderer.en.dead = false;
        Renderer.parts = []; 
    },
    atk:()=>{ Renderer.parts.push({t:'atk',x:Renderer.hero.x,y:Renderer.hero.y-20,vx:20,l:30}); },
    hit:()=>{ Renderer.hero.s=30; },
    loop:()=>{
        let c=Renderer.ctx;
        if(c){
            if(Game.state===1){
                let t=Game.lvls[Game.lvl-1]||120, sp=(Renderer.cw/60)/(t*0.9);
                if(Renderer.en.x>Renderer.hero.x+60) Renderer.en.x-=sp; else { Renderer.en.x=Renderer.cw+50; Game.timeOut(); }
                if(isNaN(Renderer.en.x) || Renderer.en.x < -100) Renderer.en.x = Renderer.cw+50; 
            }
            c.clearRect(0,0,Renderer.cw,Renderer.ch); c.globalAlpha=0.3; c.fillStyle="white";
            Renderer.bgs.forEach(o=>{ o.x-=o.sp; if(o.x<-50)o.x=Renderer.cw+50; if(o.t==='tree')c.fillRect(o.x,Renderer.ch-o.s*2,10,o.s*2); else{c.beginPath();c.arc(o.x,o.y,o.s/4,0,7);c.fill();} });
            c.globalAlpha=1; c.font="60px Arial"; c.textAlign="center"; c.shadowBlur=10; c.shadowColor="black";
            let hx=Renderer.hero.x+(Renderer.hero.s>0?(Math.random()-0.5)*Renderer.hero.s:0); if(Renderer.hero.s>0)Renderer.hero.s*=0.9;
            c.fillText(Renderer.hero.c,hx,Renderer.hero.y);
            if(!Renderer.en.dead) c.fillText(Renderer.en.c,Renderer.en.x,Renderer.en.y);
            
            c.shadowBlur=0; c.fillStyle="#60a5fa";
            Renderer.parts.forEach(p=>{ 
                p.x+=p.vx; p.l--; c.beginPath(); c.arc(p.x,p.y,10,0,7); c.fill(); 
                if(!Renderer.en.dead && p.x>Renderer.en.x){ p.l=0; Renderer.en.dead=true; } 
            });
        }
        Renderer.id=requestAnimationFrame(Renderer.loop);
    }
};
</script>
</body>
</html>
